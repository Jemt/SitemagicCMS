if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Base=function(itemId){Fit.Validation.ExpectStringValue(itemId);var me=this;var urls=null;var onRequestHandlers=[];var onResponseHandlers=[];var onFailureHandlers=[];this.InitializeModel=function(){urls=me.GetWebServiceUrls();var properties=me.GetProperties();Fit.Array.ForEach(properties,function(prop){if(typeof properties[prop]==="number"){me[prop]=createGetSet(function(){return me.GetProperties()[prop]},function(val){me.GetProperties()[prop]=val},Fit.Validation.ExpectNumber)}else if(typeof properties[prop]==="string"){me[prop]=createGetSet(function(){return me.GetProperties()[prop]},function(val){me.GetProperties()[prop]=val},Fit.Validation.ExpectString)}else if(typeof properties[prop]==="object"){me[prop]=createGetSet(function(){return me.GetProperties()[prop]},function(val){me.GetProperties()[prop]=val},null)}})};this.GetModelName=function(){Fit.Validation.ThrowError("Missing implementation")};this.GetProperties=function(){Fit.Validation.ThrowError("Missing implementation")};this.GetWebServiceUrls=function(){Fit.Validation.ThrowError("Missing implementation")};this.Create=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);if(Fit.Validation.IsSet(urls.Create)===false)Fit.Validation.ThrowError("WebService URL not configured");var req=createRequest("Create",cbSuccess,cbFailure);req.SetData({Model:me.GetModelName(),Properties:Fit.Core.Clone(me.GetProperties()),Operation:"Create"});req.Start()};this.Retrieve=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);if(Fit.Validation.IsSet(urls.Retrieve)===false)Fit.Validation.ThrowError("WebService URL not configured");var req=createRequest("Retrieve",cbSuccess,cbFailure);req.SetData({Model:me.GetModelName(),Properties:Fit.Core.Clone(me.GetProperties()),Operation:"Retrieve"});req.Start()};this.Update=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);if(Fit.Validation.IsSet(urls.Update)===false)Fit.Validation.ThrowError("WebService URL not configured");var req=createRequest("Update",cbSuccess,cbFailure);req.SetData({Model:me.GetModelName(),Properties:Fit.Core.Clone(me.GetProperties()),Operation:"Update"});req.Start()};this.Delete=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);if(Fit.Validation.IsSet(urls.Delete)===false)Fit.Validation.ThrowError("WebService URL not configured");var req=createRequest("Delete",cbSuccess,cbFailure);req.SetData({Model:me.GetModelName(),Properties:Fit.Core.Clone(me.GetProperties()),Operation:"Delete"});req.Start()};this.OnRequest=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onRequestHandlers,cb)};this.OnResponse=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onResponseHandlers,cb)};this.OnFailure=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onFailureHandlers,cb)};this.toString=function(){return"JSShop.Models."+me.GetModelName()+" = "+JSON.stringify(me.GetProperties())};function createGetSet(getter,setter,validator){Fit.Validation.ExpectFunction(getter);Fit.Validation.ExpectFunction(setter);Fit.Validation.ExpectFunction(validator,true);return function(val){if(Fit.Validation.IsSet(validator)===true)validator(val,true);if(Fit.Validation.IsSet(val)===true){setter(val)}return getter()}}function createRequest(operation,cbSuccess,cbFailure){Fit.Validation.ExpectString(operation);Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);var req=new Fit.Http.JsonRequest(me.GetWebServiceUrls()[operation]);req.OnRequest(function(sender){if(req.SuppressEvents===true)return;Fit.Array.ForEach(onRequestHandlers,function(cb){cb(req,me,operation)});if(Fit.Validation.IsSet(JSShop.Events.OnRequest)===true){if(JSShop.Events.OnRequest(req,[me],operation)===false)return false}});req.OnSuccess(function(sender){if(req.SuppressEvents===true)return;var resp=req.GetResponseJson();if(resp!==null){Fit.Array.ForEach(me.GetProperties(),function(prop){if(resp[prop]===null||resp[prop]===undefined)return;me[prop](resp[prop])})}Fit.Array.ForEach(onResponseHandlers,function(cb){cb(req,me,operation)});if(Fit.Validation.IsSet(JSShop.Events.OnSuccess)===true)JSShop.Events.OnSuccess(req,[me],operation);if(Fit.Validation.IsSet(cbSuccess)===true)cbSuccess(req,me);if(req.GetResponseHeader("Post-Process-Url")!==null){var url=req.GetResponseHeader("Post-Process-Url");var data=req.GetResponseHeader("Post-Process-Payload");var args=req.GetResponseHeader("Post-Process-Arguments");if(url==="[same]")url=me.GetWebServiceUrls()[operation];var r=new Fit.Http.JsonRequest(url+(args!==null?(url.indexOf("?")>-1?"&":"?")+args:""));r.SetData(data!==null?JSON.parse(data):{});r.OnSuccess(function(){});r.Start()}});req.OnFailure(function(sender){if(req.SuppressEvents===true)return;Fit.Array.ForEach(onFailureHandlers,function(cb){cb(req,me,operation)});if(Fit.Validation.IsSet(JSShop.Events.OnError)===true)JSShop.Events.OnError(req,[me],operation);if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(req,me)});return req}this._internal={CreateRequest:function(operation,cbSuccess,cbFailure){Fit.Validation.ExpectString(operation);Fit.Validation.ExpectFunction(cbSuccess,true);Fit.Validation.ExpectFunction(cbFailure,true);return createRequest(operation,cbSuccess,cbFailure)}}};JSShop.Models.Base.RetrieveAll=function(modelType,idProp,match,cbSuccess,cbFailure){Fit.Validation.ExpectFunction(modelType);Fit.Validation.ExpectString(idProp);Fit.Validation.ExpectIsSet(match);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var templateModel=new modelType("TemplateModel"+Fit.Data.CreateGuid());if(Fit.Validation.IsSet(templateModel.GetWebServiceUrls().RetrieveAll)===false)Fit.Validation.ThrowError("WebService URL not configured");var req=templateModel._internal.CreateRequest("RetrieveAll");req.SuppressEvents=true;req.SetData({Model:templateModel.GetModelName(),Properties:Fit.Core.Clone(templateModel.GetProperties()),Operation:"RetrieveAll",Match:match});req.OnRequest(function(sender){if(Fit.Validation.IsSet(JSShop.Events.OnRequest)===true){if(JSShop.Events.OnRequest(req,[],"RetrieveAll")===false)return false}});req.OnSuccess(function(sender){var json=req.GetResponseJson();var models=[];Fit.Array.ForEach(json,function(item){var model=new modelType(item[idProp]);Fit.Array.ForEach(model.GetProperties(),function(prop){if(item[prop]===null||item[prop]===undefined)return;model[prop](item[prop])});Fit.Array.Add(models,model)});if(Fit.Validation.IsSet(JSShop.Events.OnSuccess)===true)JSShop.Events.OnSuccess(req,models,"RetrieveAll");cbSuccess(req,models)});req.OnFailure(function(sender){if(Fit.Validation.IsSet(JSShop.Events.OnError)===true)JSShop.Events.OnError(req,[],"RetrieveAll");if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(req,[])});req.Start()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Basket={};JSShop.Models.Basket.Add=function(productId,units){Fit.Validation.ExpectStringValue(productId);Fit.Validation.ExpectInteger(units);if(units<1)return;var basketData=JSShop.Cookies.Get("Basket");var basket=basketData!==null?JSON.parse(basketData):{Items:[]};var alreadyAdded=false;Fit.Array.ForEach(basket.Items,function(item){if(item.ProductId===productId){alreadyAdded=true;item.Units=item.Units+units;return false}});if(alreadyAdded===false){var item={ProductId:productId,Units:units};Fit.Array.Add(basket.Items,item)}JSShop.Cookies.Set("Basket",JSON.stringify(basket))};JSShop.Models.Basket.Update=function(productId,units){Fit.Validation.ExpectStringValue(productId);Fit.Validation.ExpectInteger(units);if(units<1){JSShop.Models.Basket.Remove(productId);return}var basketData=JSShop.Cookies.Get("Basket");var basket=basketData!==null?JSON.parse(basketData):{Items:[]};var exists=false;Fit.Array.ForEach(basket.Items,function(item){if(item.ProductId===productId){exists=true;item.Units=units;return false}});if(exists===true){JSShop.Cookies.Set("Basket",JSON.stringify(basket))}else{JSShop.Models.Basket.Add(productId,units)}};JSShop.Models.Basket.Remove=function(productId){Fit.Validation.ExpectStringValue(productId);var basketData=JSShop.Cookies.Get("Basket");var basket=basketData!==null?JSON.parse(basketData):{Items:[]};var newBasket={Items:[]};Fit.Array.ForEach(basket.Items,function(item){if(item.ProductId!==productId)Fit.Array.Add(newBasket.Items,item)});JSShop.Cookies.Set("Basket",JSON.stringify(newBasket))};JSShop.Models.Basket.GetItems=function(){var basketData=JSShop.Cookies.Get("Basket");var basket=basketData!==null?JSON.parse(basketData):{Items:[]};return basket.Items};JSShop.Models.Basket.Clear=function(){JSShop.Cookies.Remove("Basket")};JSShop.Models.Basket.CreateOrder=function(order,cbSuccess,cbFailure){Fit.Validation.ExpectInstance(order,JSShop.Models.Order);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var basketData=JSShop.Cookies.Get("Basket");var basket=basketData!==null?JSON.parse(basketData):{Items:[]};var orderEntries=[];var failure=false;Fit.Array.ForEach(basket.Items,function(item){var entry=new JSShop.Models.OrderEntry(Fit.Data.CreateGuid());entry.OrderId(order.Id());entry.ProductId(item.ProductId);entry.Units(item.Units);entry.Create(function(eReq,eModel){Fit.Array.Add(orderEntries,entry);if(orderEntries.length===basket.Items.length){if(failure===false){order.Create(function(oReq,oModel){cbSuccess(order)},function(oReq,oModel){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(order)})}else{if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(order)}}},function(eReq,eModel){Fit.Array.Add(orderEntries,entry);failure=true;if(orderEntries.length===basket.Items.length){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(order)}})})};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Config=function(id){Fit.Validation.ExpectStringValue(id,true);Fit.Core.Extend(this,JSShop.Models.Base).Apply("-1");var me=this;var properties={Basic:{TermsPage:"",ReceiptPage:"",ShopBccEmail:""},MailTemplates:{Confirmation:"",Invoice:"",Templates:[]},PaymentMethods:[],CostCorrections:[],AdditionalData:"",Identifiers:{NextOrderId:{Value:1,Dirty:false},NextInvoiceId:{Value:1,Dirty:false}}};function init(){me.InitializeModel();me.OnResponse(function(req,model,operation){if(operation==="Retrieve"){var props=me.GetProperties();Fit.Validation.ExpectObject(props.Basic);Fit.Validation.ExpectObject(props.MailTemplates);Fit.Validation.ExpectArray(props.PaymentMethods);Fit.Validation.ExpectArray(props.CostCorrections);Fit.Validation.ExpectString(props.AdditionalData);Fit.Validation.ExpectObject(props.Identifiers);Fit.Validation.ExpectString(props.Basic.TermsPage);Fit.Validation.ExpectString(props.Basic.ReceiptPage);Fit.Validation.ExpectString(props.Basic.ShopBccEmail);Fit.Validation.ExpectString(props.MailTemplates.Confirmation);Fit.Validation.ExpectString(props.MailTemplates.Invoice);Fit.Validation.ExpectArray(props.MailTemplates.Templates);Fit.Validation.ExpectObject(props.Identifiers.NextOrderId);Fit.Validation.ExpectInteger(props.Identifiers.NextOrderId.Value);Fit.Validation.ExpectBoolean(props.Identifiers.NextOrderId.Dirty);Fit.Validation.ExpectObject(props.Identifiers.NextInvoiceId);Fit.Validation.ExpectInteger(props.Identifiers.NextInvoiceId.Value);Fit.Validation.ExpectBoolean(props.Identifiers.NextInvoiceId.Dirty);Fit.Array.ForEach(props.PaymentMethods,function(p){Fit.Validation.ExpectString(p.Module);Fit.Validation.ExpectString(p.Title);Fit.Validation.ExpectBoolean(p.Enabled);Fit.Validation.ExpectArray(p.Settings);Fit.Array.ForEach(p.Settings,function(s){Fit.Validation.ExpectString(s.Title);Fit.Validation.ExpectString(s.Value)})});Fit.Array.ForEach(props.CostCorrections,function(c){Fit.Validation.ExpectString(c.CostCorrection);Fit.Validation.ExpectString(c.Vat);Fit.Validation.ExpectString(c.Message)});Fit.Array.ForEach(props.MailTemplates.Templates,function(t){Fit.Validation.ExpectString(t.Name);Fit.Validation.ExpectString(t.Title);Fit.Validation.ExpectString(t.Subject);Fit.Validation.ExpectString(t.Content)})}else if(operation==="Update"){var props=me.GetProperties();props.Identifiers.NextOrderId.Dirty=false;props.Identifiers.NextInvoiceId.Dirty=false}})}this.GetModelName=function(){return"Config"};this.GetProperties=function(){return properties};this.GetWebServiceUrls=function(){var urls={Retrieve:JSShop.WebService.Configuration.Retrieve,Update:JSShop.WebService.Configuration.Update};return urls};this.Create=function(){Fit.Validation.ThrowError("Not supported")};this.Delete=function(){Fit.Validation.ThrowError("Not supported")};init()};JSShop.Models.Config.RetrieveAll=function(id,cbSuccess,cbFailure){Fit.Validation.ThrowError("Not supported")};JSShop.Models.Config.Current=new JSShop.Models.Config("-1");if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Order=function(orderId){Fit.Validation.ExpectStringValue(orderId);Fit.Core.Extend(this,JSShop.Models.Base).Apply(orderId);var me=this;var properties={Id:orderId,Time:-1,ClientIp:"",Company:"",FirstName:"",LastName:"",Address:"",ZipCode:"",City:"",Email:"",Phone:"",Message:"",AltCompany:"",AltFirstName:"",AltLastName:"",AltAddress:"",AltZipCode:"",AltCity:"",Price:0,Vat:0,Currency:"",Weight:0,WeightUnit:"",CostCorrection1:0,CostCorrectionVat1:0,CostCorrectionMessage1:"",CostCorrection2:0,CostCorrectionVat2:0,CostCorrectionMessage2:"",CostCorrection3:0,CostCorrectionVat3:0,CostCorrectionMessage3:"",PaymentMethod:"",TransactionId:"",State:"",TagIds:"",PromoCode:"",CustData1:"",CustData2:"",CustData3:"",InvoiceId:"",InvoiceTime:-1};function init(){me.InitializeModel()}this.GetModelName=function(){return"Order"};this.GetProperties=function(){return properties};this.GetWebServiceUrls=function(){var urls={Create:JSShop.WebService.Orders.Create,Retrieve:JSShop.WebService.Orders.Retrieve,RetrieveAll:JSShop.WebService.Orders.RetrieveAll,Update:JSShop.WebService.Orders.Update,Delete:JSShop.WebService.Orders.Delete};return urls};function calculateNumber(expr){Fit.Validation.ExpectString(expr);return JSShop.Models.Order.CalculateExpression(me.Price(),me.Vat(),me.Currency(),me.Weight(),me.WeightUnit(),me.AltZipCode()!==""?me.AltZipCode():me.ZipCode(),me.PaymentMethod(),me.PromoCode(),me.CustData1(),me.CustData2(),me.CustData3(),expr,"number")}function calculateString(expr){Fit.Validation.ExpectString(expr);return JSShop.Models.Order.CalculateExpression(me.Price(),me.Vat(),me.Currency(),me.Weight(),me.WeightUnit(),me.AltZipCode()!==""?me.AltZipCode():me.ZipCode(),me.PaymentMethod(),me.PromoCode(),me.CustData1(),me.CustData2(),me.CustData3(),expr,"string")}this.CalculateCostCorrection1=function(){return calculateNumber(JSShop.Settings.CostCorrection1?JSShop.Settings.CostCorrection1:"")};this.CalculateCostCorrectionVat1=function(){return calculateNumber(JSShop.Settings.CostCorrectionVat1?JSShop.Settings.CostCorrectionVat1:"")};this.CalculateCostCorrectionMessage1=function(){return calculateString(JSShop.Settings.CostCorrectionMessage1?JSShop.Settings.CostCorrectionMessage1:"")};this.CalculateCostCorrection2=function(){return calculateNumber(JSShop.Settings.CostCorrection2?JSShop.Settings.CostCorrection2:"")};this.CalculateCostCorrectionVat2=function(){return calculateNumber(JSShop.Settings.CostCorrectionVat2?JSShop.Settings.CostCorrectionVat2:"")};this.CalculateCostCorrectionMessage2=function(){return calculateString(JSShop.Settings.CostCorrectionMessage2?JSShop.Settings.CostCorrectionMessage2:"")};this.CalculateCostCorrection3=function(){return calculateNumber(JSShop.Settings.CostCorrection3?JSShop.Settings.CostCorrection3:"")};this.CalculateCostCorrectionVat3=function(){return calculateNumber(JSShop.Settings.CostCorrectionVat3?JSShop.Settings.CostCorrectionVat3:"")};this.CalculateCostCorrectionMessage3=function(){return calculateString(JSShop.Settings.CostCorrectionMessage3?JSShop.Settings.CostCorrectionMessage3:"")};this.CapturePayment=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);if(!JSShop.Settings.PaymentCaptureUrl){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(me);return}var req=new Fit.Http.Request(JSShop.Settings.PaymentCaptureUrl);req.AddData("OrderId",me.Id());req.OnSuccess(function(sender){me.State("Captured");cbSuccess(req,me)});req.OnFailure(function(sender){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(req,me)});req.Start()};this.CancelPayment=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);if(!JSShop.Settings.PaymentCancelUrl){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(null,me);return}var req=new Fit.Http.Request(JSShop.Settings.PaymentCancelUrl);req.AddData("OrderId",me.Id());req.OnSuccess(function(sender){me.State("Canceled");cbSuccess(req,me)});req.OnFailure(function(sender){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(req,me)});req.Start()};this.SendInvoice=function(cbSuccess,cbFailure){Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);if(!JSShop.Settings.SendInvoiceUrl){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(null,me);return}var req=new Fit.Http.Request(JSShop.Settings.SendInvoiceUrl);req.AddData("OrderId",me.Id());req.OnSuccess(function(sender){cbSuccess(req,me)});req.OnFailure(function(sender){if(Fit.Validation.IsSet(cbFailure)===true)cbFailure(req,me)});req.Start()};init()};JSShop.Models.Order.RetrieveAll=function(search,fromTimestamp,toTimestamp,cbSuccess,cbFailure){Fit.Validation.ExpectString(search);Fit.Validation.ExpectInteger(fromTimestamp);Fit.Validation.ExpectInteger(toTimestamp);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var or=[];if(search!==""){var expr=/^\$(.+?) (.+?) (.+)$/.exec(search);if(expr!==null){var field=expr[1];var operator=expr[2];var match=expr[3];var and=[];Fit.Array.Add(and,{Field:"Time",Operator:">=",Value:fromTimestamp});Fit.Array.Add(and,{Field:"Time",Operator:"<=",Value:toTimestamp});Fit.Array.Add(and,{Field:field,Operator:operator.toUpperCase(),Value:match});Fit.Array.Add(or,and)}else{Fit.Array.ForEach(["FirstName","LastName","Address","City","ZipCode","Email","Phone","Message","AltFirstName","AltLastName","AltAddress","AltCity","AltZipCode"],function(field){var and=[];Fit.Array.Add(and,{Field:"Time",Operator:">=",Value:fromTimestamp});Fit.Array.Add(and,{Field:"Time",Operator:"<=",Value:toTimestamp});Fit.Array.Add(and,{Field:field,Operator:"CONTAINS",Value:search});Fit.Array.Add(or,and)})}}else{var and=[];Fit.Array.Add(and,{Field:"Time",Operator:">=",Value:fromTimestamp});Fit.Array.Add(and,{Field:"Time",Operator:"<=",Value:toTimestamp});Fit.Array.Add(or,and)}JSShop.Models.Base.RetrieveAll(JSShop.Models.Order,"Id",or,cbSuccess,cbFailure)};JSShop.Models.Order.CalculateExpression=function(price,vat,currency,weight,weightUnit,zipCode,paymentMethod,promoCode,custData1,custData2,custData3,expression,returnType){Fit.Validation.ExpectNumber(price);Fit.Validation.ExpectNumber(vat);Fit.Validation.ExpectString(currency);Fit.Validation.ExpectNumber(weight);Fit.Validation.ExpectString(weightUnit);Fit.Validation.ExpectString(zipCode);Fit.Validation.ExpectString(paymentMethod);Fit.Validation.ExpectString(promoCode);Fit.Validation.ExpectString(custData1);Fit.Validation.ExpectString(custData2);Fit.Validation.ExpectString(custData3);Fit.Validation.ExpectString(expression);Fit.Validation.ExpectStringValue(returnType);if(expression===""){if(returnType==="number"){return 0}else if(returnType==="string"){return""}else{throw"InvalidReturnType: Return type must be either 'string' or 'number'"}}var ex=expression;ex=ex.replace(/\r|\n|\t/g,"");ex=ex.replace(/\/\*.*?\*\//g,"");ex=ex.replace(/price|vat|currency|weightunit|weight|zipcodeval|zipcode|paymentmethod|promocode|custdata1|custdata2|custdata3|data/g,"");ex=ex.replace(/JSShop.Floor|JSShop.Ceil|JSShop.Round/g,"");ex=ex.replace(/ |[0-9]|\*|\+|\-|\/|%|=|&|\||!|\.|:|\(|\)|\[|\]|>|<|\?|true|false/g,"");ex=ex.replace(/(["']).*?\1/g,"");var secure=ex==="";if(secure===false)throw"InvalidExpression: Invalid and potentially insecure expression detected - evaluation aborted";var zipCodeVal=isNaN(parseInt(zipCode))===false&&parseInt(zipCode)+""===zipCode?parseInt(zipCode):-1;var expr="";expr+="var price = "+price+";";expr+="var vat = "+vat+";";expr+='var currency = "'+currency+'";';expr+="var weight = "+weight+";";expr+='var weightunit = "'+weightUnit+'";';expr+='var zipcode = "'+zipCode+'";';expr+="var zipcodeval = "+zipCodeVal+";";expr+='var paymentmethod = "'+paymentMethod+'";';expr+='var promocode = "'+promoCode+'";';expr+='var custdata1 = "'+custData1+'";';expr+='var custdata2 = "'+custData2+'";';expr+='var custdata3 = "'+custData3+'";';expr+="var data = "+(JSShop.Settings.AdditionalData?JSON.stringify(JSShop.Settings.AdditionalData):"{}")+";";expr+="("+expression.replace(/JSShop\.Floor/g,"Math.floor").replace(/JSShop\.Ceil/g,"Math.ceil").replace(/JSShop\.Round/g,"Math.round")+");";var result=eval(expr);if(typeof result==="string")result=Fit.String.EncodeHtml(result);var isValid=false;if(returnType==="number"){isValid=/^\-?([0-9]+(\.[0-9]+)?)$/.test(result.toString());isValid=isValid===true&&typeof result==="number"}else if(returnType==="string"){isValid=typeof result==="string"}else{throw"InvalidReturnType: Return type must be either 'string' or 'number'"}if(isValid===false)throw"InvalidExpressionResult: Expression did not produce a valid value of type '"+returnType+"'";return result};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.OrderEntry=function(entryId){Fit.Validation.ExpectStringValue(entryId);Fit.Core.Extend(this,JSShop.Models.Base).Apply(entryId);var me=this;var properties={Id:entryId,OrderId:"",ProductId:"",UnitPrice:0,Vat:0,Currency:"",Units:0,Discount:0,DiscountMessage:""};function init(){me.InitializeModel()}this.GetModelName=function(){return"OrderEntry"};this.GetProperties=function(){return properties};this.GetWebServiceUrls=function(){var urls={Create:JSShop.WebService.OrderEntries.Create,Retrieve:JSShop.WebService.OrderEntries.Retrieve,RetrieveAll:JSShop.WebService.OrderEntries.RetrieveAll,Update:JSShop.WebService.OrderEntries.Update,Delete:JSShop.WebService.OrderEntries.Delete};return urls};init()};JSShop.Models.OrderEntry.RetrieveAll=function(orderId,cbSuccess,cbFailure){Fit.Validation.ExpectString(orderId);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var match=[[{Field:"OrderId",Operator:"=",Value:orderId}]];JSShop.Models.Base.RetrieveAll(JSShop.Models.OrderEntry,"Id",match,cbSuccess,cbFailure)};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Product=function(itemId){Fit.Validation.ExpectStringValue(itemId);Fit.Core.Extend(this,JSShop.Models.Base).Apply(itemId);var me=this;var properties={Id:itemId,Category:"",Title:"",Description:"",Images:"",Price:0,Vat:0,Currency:"",Weight:0,WeightUnit:"",DeliveryTime:"",DiscountExpression:"",DiscountMessage:""};function init(){me.InitializeModel()}this.GetModelName=function(){return"Product"};this.GetProperties=function(){return properties};this.GetWebServiceUrls=function(){var urls={Create:JSShop.WebService.Products.Create,Retrieve:JSShop.WebService.Products.Retrieve,RetrieveAll:JSShop.WebService.Products.RetrieveAll,Update:JSShop.WebService.Products.Update,Delete:JSShop.WebService.Products.Delete};return urls};this.CalculateDiscount=function(units){Fit.Validation.ExpectInteger(units);if(me.DiscountExpression()==="")return 0;var result=calculateExpression(units,me.DiscountExpression(),"number");return result};this.CalculateDiscountMessage=function(units){Fit.Validation.ExpectInteger(units);if(me.DiscountMessage()==="")return"";var result=calculateExpression(units,me.DiscountMessage(),"string");return result};function calculateExpression(units,expression,returnType){Fit.Validation.ExpectInteger(units);Fit.Validation.ExpectString(expression);Fit.Validation.ExpectStringValue(returnType);if(expression===""){if(returnType==="number"){return 0}else if(returnType==="string"){return""}else{throw"InvalidReturnType: Return type must be either 'string' or 'number'"}}var ex=expression;ex=ex.replace(/\r|\n|\t/g,"");ex=ex.replace(/\/\*.*?\*\//g,"");ex=ex.replace(/data|units|price|vat|currency|weight|weightunit/g,"");ex=ex.replace(/JSShop.Floor|JSShop.Ceil|JSShop.Round/g,"");ex=ex.replace(/ |[0-9]|\*|\+|\-|\/|%|=|&|\||!|\.|:|\(|\)|\[|\]|>|<|\?|true|false/g,"");ex=ex.replace(/(["']).*?\1/g,"");var secure=ex==="";if(secure===false)throw"InvalidExpression: Invalid and potentially insecure expression detected - evaluation aborted";var expr="";expr+="var units = "+units+";";expr+="var price = "+me.Price()+";";expr+="var vat = "+me.Vat()+";";expr+='var currency = "'+me.Currency()+'";';expr+='var weight = "'+me.Weight()+'";';expr+='var weightunit = "'+me.WeightUnit()+'";';expr+="var data = "+(JSShop.Settings.AdditionalData?JSON.stringify(JSShop.Settings.AdditionalData):"{}")+";";expr+="("+expression.replace(/JSShop\.Floor/g,"Math.floor").replace(/JSShop\.Ceil/g,"Math.ceil").replace(/JSShop\.Round/g,"Math.round")+");";var result=eval(expr);if(typeof result==="string")result=Fit.String.EncodeHtml(result);var isValid=false;if(returnType==="number"){isValid=/^\-?([0-9]+(\.[0-9]+)?)$/.test(result.toString());isValid=isValid===true&&typeof result==="number"}else if(returnType==="string"){isValid=typeof result==="string"}else{throw"InvalidReturnType: Return type must be either 'string' or 'number'"}if(isValid===false)throw"InvalidExpressionResult: Expression did not produce a valid value of type '"+returnType+"'";return result}init()};JSShop.Models.Product.RetrieveAll=function(category,cbSuccess,cbFailure){Fit.Validation.ExpectString(category);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var match=category!==""?[[{Field:"Category",Operator:"=",Value:category}]]:[];JSShop.Models.Base.RetrieveAll(JSShop.Models.Product,"Id",match,cbSuccess,cbFailure)};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Models.Tag=function(tagId){Fit.Validation.ExpectStringValue(tagId);Fit.Core.Extend(this,JSShop.Models.Base).Apply(tagId);var me=this;var properties={Id:tagId,Type:"",Title:""};function init(){me.InitializeModel()}this.GetModelName=function(){return"Tag"};this.GetProperties=function(){return properties};this.GetWebServiceUrls=function(){var urls={Create:JSShop.WebService.Tags.Create,Retrieve:JSShop.WebService.Tags.Retrieve,RetrieveAll:JSShop.WebService.Tags.RetrieveAll,Update:JSShop.WebService.Tags.Update,Delete:JSShop.WebService.Tags.Delete};return urls};init()};JSShop.Models.Tag.RetrieveAll=function(type,cbSuccess,cbFailure){Fit.Validation.ExpectString(type);Fit.Validation.ExpectFunction(cbSuccess);Fit.Validation.ExpectFunction(cbFailure,true);var match=[[{Field:"Type",Operator:"=",Value:type}]];JSShop.Models.Base.RetrieveAll(JSShop.Models.Tag,"Id",match,cbSuccess,cbFailure)};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.Base=function(){var me=this;var onRenderHandlers=[];var onRenderedHandlers=[];function init(){}this.GetDomElement=function(){throw new Error("Not implemented")};this.Render=function(toElement){Fit.Validation.ExpectDomElement(toElement);Fit.Array.ForEach(onRenderHandlers,function(cb){cb(me)});Fit.Dom.Add(toElement,me.GetDomElement());Fit.Array.ForEach(onRenderedHandlers,function(cb){cb(me)})};this.OnRender=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onRenderHandlers,cb)};this.OnRendered=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onRenderedHandlers,cb)};init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.Basket=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var me=this;var dom=null;var tpl=null;var basket=JSShop.Models.Basket;var lang=JSShop.Language.Translations;var zipCode="";var paymentMethod="";var promoCode="";var custData1="";var custData2="";var custData3="";var onUpdateHandlers=[];var onUpdatedHandlers=[];var result={Price:-1,Vat:-1};function init(cb){loadView(function(){populateView()})}function loadView(cb){Fit.Validation.ExpectFunction(cb);dom=document.createElement("div");if(document.querySelector("link[href*='/Views/Basket/Basket.css']")===null){Fit.Browser.Log("Lazy loading Basket.css");Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/Basket/Basket.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"))}tpl=new Fit.Template(true);tpl.AllowUnsafeContent(true);tpl.LoadUrl(JSShop.GetPath()+"/Views/Basket/Basket.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){tpl.Content.HeaderProduct=lang.Basket.Product;tpl.Content.HeaderUnitPrice=lang.Basket.UnitPrice;tpl.Content.HeaderUnits=lang.Basket.Units;tpl.Content.HeaderDiscount=lang.Basket.Discount;tpl.Content.HeaderPrice=lang.Basket.Price;tpl.Content.HeaderTotalVat=lang.Basket.TotalVat;tpl.Content.HeaderTotalPrice=lang.Basket.TotalPrice;cb()});tpl.Render(dom)}function populateView(){if(tpl.Content===null){return}var items=basket.GetItems();Fit.Array.ForEach(onUpdateHandlers,function(handler){handler(me)});if(document.querySelector("link[href*='/Views/Basket/Basket.css']")===null)Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/Basket/Basket.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"));if(items.length===0){dom.innerHTML=lang.Basket.BasketEmpty;return}tpl.Content.ProductEntries.Clear();var totalVat=0;var totalPrice=0;var totalDiscount=0;var totalWeight=0;var itemCount=items.length;var currency=null;var currencyError=false;var weightUnit=null;var weightUnitError=false;var commonVatFactor=-99999.99;var identicalVat=true;Fit.Array.ForEach(items,function(item){item.Product=new JSShop.Models.Product(item.ProductId);item.View=tpl.Content.ProductEntries.AddItem();var product=item.Product;product.Retrieve(function(req,model){itemCount--;if(itemCount===0){var productEntry=null;Fit.Array.ForEach(items,function(item){currency=currency!==null?currency:item.Product.Currency();if(item.Product.Currency()!==currency)currencyError=true;weightUnit=weightUnit!==null?weightUnit:item.Product.WeightUnit();if(item.Product.WeightUnit()!==weightUnit)weightUnitError=true;productEntry=item.View;var discountExclVat=Fit.Math.Round(item.Product.CalculateDiscount(item.Units),2);var pricing=JSShop.CalculatePricing(item.Product.Price(),item.Units,item.Product.Vat(),discountExclVat);productEntry.Title=item.Product.Title();productEntry.UnitPrice=Fit.Math.Format(pricing.UnitPriceInclVat,2,lang.Locale.DecimalSeparator);productEntry.DiscountMessage=pricing.DiscountInclVat>0||pricing.DiscountInclVat<0?item.Product.CalculateDiscountMessage(item.Units):"";productEntry.Discount=pricing.DiscountInclVat>0||pricing.DiscountInclVat<0?Fit.Math.Format(pricing.DiscountInclVat*-1,2,lang.Locale.DecimalSeparator):"";productEntry.Units=null;productEntry.Currency=item.Product.Currency();productEntry.Price=Fit.Math.Format(pricing.TotalInclVat,2,lang.Locale.DecimalSeparator);totalVat=Fit.Math.Round(totalVat+pricing.TotalVat,2);totalPrice=Fit.Math.Round(totalPrice+pricing.TotalInclVat,2);totalDiscount=Fit.Math.Round(totalDiscount+pricing.DiscountInclVat,2);totalWeight=Fit.Math.Round(totalWeight+item.Units*item.Product.Weight(),2);if(commonVatFactor===-99999.99)commonVatFactor=pricing.VatFactor;if(commonVatFactor!==pricing.VatFactor)identicalVat=false});var costCorrections=[{Expression:JSShop.Settings.CostCorrection1?JSShop.Settings.CostCorrection1:"",Vat:JSShop.Settings.CostCorrectionVat1?JSShop.Settings.CostCorrectionVat1:"",Msg:JSShop.Settings.CostCorrectionMessage1?JSShop.Settings.CostCorrectionMessage1:"",CostCorrectionExVat:0,CostCorrectionVat:0},{Expression:JSShop.Settings.CostCorrection2?JSShop.Settings.CostCorrection2:"",Vat:JSShop.Settings.CostCorrectionVat2?JSShop.Settings.CostCorrectionVat2:"",Msg:JSShop.Settings.CostCorrectionMessage2?JSShop.Settings.CostCorrectionMessage2:"",CostCorrectionExVat:0,CostCorrectionVat:0},{Expression:JSShop.Settings.CostCorrection3?JSShop.Settings.CostCorrection3:"",Vat:JSShop.Settings.CostCorrectionVat3?JSShop.Settings.CostCorrectionVat3:"",Msg:JSShop.Settings.CostCorrectionMessage3?JSShop.Settings.CostCorrectionMessage3:"",CostCorrectionExVat:0,CostCorrectionVat:0}];Fit.Array.ForEach(costCorrections,function(cc){if(!cc.Expression)return;var correctionExclVat=JSShop.Models.Order.CalculateExpression(totalPrice-totalVat,totalVat,currency,totalWeight,weightUnit,zipCode,paymentMethod,promoCode,custData1,custData2,custData3,cc.Expression,"number");var correctionInclVat=0;if(correctionExclVat>0||correctionExclVat<0){var correctionVat=0;if(cc.Vat)correctionVat=JSShop.Models.Order.CalculateExpression(totalPrice-totalVat,totalVat,currency,totalWeight,weightUnit,zipCode,paymentMethod,promoCode,custData1,custData2,custData3,cc.Vat,"number");var costCorrectionResult=JSShop.CalculatePricing(correctionExclVat,1,correctionVat,0);correctionExclVat=costCorrectionResult.TotalExclVat;correctionInclVat=costCorrectionResult.TotalInclVat;var correctionMessage="";if(cc.Msg)correctionMessage=JSShop.Models.Order.CalculateExpression(totalPrice-totalVat,totalVat,currency,totalWeight,weightUnit,zipCode,paymentMethod,promoCode,custData1,custData2,custData3,cc.Msg,"string");productEntry=tpl.Content.ProductEntries.AddItem();productEntry.Title=correctionMessage;productEntry.UnitPrice="&nbsp;";productEntry.DiscountMessage="";productEntry.Discount="";productEntry.Units="&nbsp;";productEntry.Currency=currency;productEntry.Price=Fit.Math.Format(correctionInclVat,2,lang.Locale.DecimalSeparator);cc.CostCorrectionExVat=correctionExclVat;cc.CostCorrectionVat=correctionInclVat-correctionExclVat;if(commonVatFactor!==costCorrectionResult.VatFactor)identicalVat=false}});Fit.Array.ForEach(costCorrections,function(cc){totalVat+=cc.CostCorrectionVat;totalPrice+=cc.CostCorrectionExVat+cc.CostCorrectionVat});if(identicalVat===true){totalVat=Fit.Math.Round(totalPrice-totalPrice/commonVatFactor,2)}result={Price:totalPrice-totalVat,Vat:totalVat};tpl.Content.Currency=items[0].Product.Currency();tpl.Content.TotalVat=Fit.Math.Format(totalVat,2,lang.Locale.DecimalSeparator);tpl.Content.TotalPrice=Fit.Math.Format(totalPrice,2,lang.Locale.DecimalSeparator);tpl.Content.TotalDiscount=Fit.Math.Format(totalDiscount,2,lang.Locale.DecimalSeparator);Fit.Array.ForEach(items,function(item){var cmdUnits=new Fit.Controls.Button(Fit.Data.CreateGuid());cmdUnits.Title(item.Units.toString());cmdUnits.Type(Fit.Controls.Button.Type.Default);cmdUnits.GetDomElement().style.cssText="font-size: 0.9em; padding: 2px 10px 2px 10px;";cmdUnits.Width(4,"em");cmdUnits.OnClick(function(sender){var html="";html+="<div style='text-align: center' id='JSShopUnitsDialogInput'>";html+="<b>"+item.Product.Title()+"</b><br><br>";html+=lang.Basket.NumberOfUnits+":<br><br>";html+="</div>";var dialog=new Fit.Controls.Dialog;dialog.Modal(true);dialog.Content(html);var units=item.Units.toString();var txtUnits=new Fit.Controls.Input(Fit.Data.CreateGuid());txtUnits.Width(4,"em");txtUnits.OnChange(function(sender){if(txtUnits.Value()!==""){if(isNaN(parseInt(txtUnits.Value()))===true||parseInt(txtUnits.Value()).toString()!==txtUnits.Value()||parseInt(txtUnits.Value())<0||parseInt(txtUnits.Value())>999999){txtUnits.Value(units)}else{units=txtUnits.Value()}}});txtUnits.OnBlur(function(sender){if(txtUnits.Value()==="")txtUnits.Value("0")});txtUnits.Render(dialog.GetDomElement().querySelector("#JSShopUnitsDialogInput"));var dispose=function(){txtUnits.Dispose();dialog.Dispose()};var cmdSave=new Fit.Controls.Button(Fit.Data.CreateGuid());cmdSave.Title(lang.Common.Ok);cmdSave.Type(Fit.Controls.Button.Type.Success);cmdSave.OnClick(function(sender){basket.Update(item.ProductId,parseInt(txtUnits.Value()));dispose();populateView()});dialog.AddButton(cmdSave);var cmdCancel=new Fit.Controls.Button(Fit.Data.CreateGuid());cmdCancel.Title(lang.Common.Cancel);cmdCancel.Type(Fit.Controls.Button.Type.Danger);cmdCancel.OnClick(function(sender){dispose()});dialog.AddButton(cmdCancel);Fit.Events.AddHandler(txtUnits.GetDomElement(),"keydown",function(e){var ev=Fit.Events.GetEvent(e);if(ev.keyCode===13){if(txtUnits.Value()==="")txtUnits.Value("0");cmdSave.Click()}});Fit.Events.AddHandler(dialog.GetDomElement(),"keydown",function(e){var ev=Fit.Events.GetEvent(e);if(ev.keyCode===27){cmdCancel.Click()}});dialog.Open();txtUnits.Focused(true)});item.View.Units=cmdUnits.GetDomElement()});tpl.Update();if(currencyError===true)Fit.Controls.Dialog.Alert(lang.Basket.ErrorCurrencies);if(weightUnitError===true)Fit.Controls.Dialog.Alert(lang.Basket.ErrorWeightUnits);Fit.Array.ForEach(onUpdatedHandlers,function(handler){handler(me)})}})})}this.ZipCode=function(zip){Fit.Validation.ExpectString(zip,true);if(Fit.Validation.IsSet(zip)===true){if(zip!==zipCode&&expressionsContain("zipcode")===true){zipCode=zip;populateView()}}return zipCode};this.PaymentMethod=function(pm){Fit.Validation.ExpectString(pm,true);if(Fit.Validation.IsSet(pm)===true){if(pm!==paymentMethod&&expressionsContain("paymentmethod")===true){paymentMethod=pm;populateView()}}return paymentMethod};this.PromoCode=function(val){Fit.Validation.ExpectString(val,true);if(Fit.Validation.IsSet(val)===true){if(val!==promoCode&&expressionsContain("promocode")===true){promoCode=val;populateView()}}return promoCode};this.CustData1=function(val){Fit.Validation.ExpectString(val,true);if(Fit.Validation.IsSet(val)===true){if(val!==custData1&&expressionsContain("custdata1")===true){custData1=val;populateView()}}return custData1};this.CustData2=function(val){Fit.Validation.ExpectString(val,true);if(Fit.Validation.IsSet(val)===true){if(val!==custData2&&expressionsContain("custdata2")===true){custData2=val;populateView()}}return custData2};this.CustData3=function(val){Fit.Validation.ExpectString(val,true);if(Fit.Validation.IsSet(val)===true){if(val!==custData3&&expressionsContain("custdata3")===true){custData3=val;populateView()}}return custData3};this.GetPricing=function(){return result};this.GetDomElement=function(){return dom};this.Update=function(){if(Fit.Dom.IsRooted(dom)===true){populateView()}};this.OnUpdate=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onUpdateHandlers,cb)};this.OnUpdated=function(cb){Fit.Validation.ExpectFunction(cb);Fit.Array.Add(onUpdatedHandlers,cb)};function expressionsContain(str){Fit.Validation.ExpectString(str);for(var i=1;i<=3;i++){if(JSShop.Settings["CostCorrection"+i]&&JSShop.Settings["CostCorrection"+i].indexOf(str)>-1||JSShop.Settings["CostCorrectionVat"+i]&&JSShop.Settings["CostCorrectionVat"+i].indexOf(str)>-1||JSShop.Settings["CostCorrectionMessage"+i]&&JSShop.Settings["CostCorrectionMessage"+i].indexOf(str)>-1){return true}}return false}init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.Config=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var me=this;var view=null;var tpl=null;var config=null;var lang=JSShop.Language.Translations;var buttons=[];var ctx=null;var ctxCallback=null;var cmdSave=null;var codeMirrorLoadState=-1;function init(){if(document.querySelector("link[href*='/Views/Config/Config.css']")===null){Fit.Browser.Log("Lazy loading Config.css");Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/Config/Config.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"))}view=document.createElement("div");tpl=new Fit.Template(true);tpl.AllowUnsafeContent(false);tpl.Render(view);JSShop.Models.Config.Current.Retrieve(function(sender){config=JSShop.Models.Config.Current.GetProperties();tpl.LoadUrl(JSShop.GetPath()+"/Views/Config/Config.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){var cmdBasic=createTabButton(lang.Config.Basic,function(sender){loadBasicConfig(sender)});var cmdMails=createTabButton(lang.Config.EmailTemplates,function(sender){showMailTemplates(sender)});var cmdPayMethods=createTabButton(lang.Config.PaymentMethods,function(sender){showPayMethods(sender)});var cmdAdvanced=createTabButton(lang.Config.Advanced,function(sender){showAdvanced(sender)});ctx=new Fit.Controls.ContextMenu;ctx.OnSelect(function(sender,item){ctxCallback(item.Value());ctx.Hide()});cmdMails.Enabled(config.MailTemplates.Templates&&config.MailTemplates.Templates.length>0?true:false);cmdPayMethods.Enabled(config.PaymentMethods.length>0?true:false);cmdSave=new Fit.Controls.Button(Fit.Data.CreateGuid());cmdSave.Title(lang.Config.Save);cmdSave.Type(Fit.Controls.Button.Type.Success);cmdSave.OnClick(function(sender){JSShop.Models.Config.Current.Update(function(req,model){Fit.Controls.Dialog.Alert(lang.Config.Done)})});tpl.Content.SectionList.AddItem().Section=cmdBasic.GetDomElement();tpl.Content.SectionList.AddItem().Section=cmdMails.GetDomElement();tpl.Content.SectionList.AddItem().Section=cmdPayMethods.GetDomElement();tpl.Content.SectionList.AddItem().Section=cmdAdvanced.GetDomElement();tpl.Content.SectionList.AddItem().Section=cmdSave.GetDomElement();cmdBasic.Type(Fit.Controls.Button.Type.Primary);loadBasicConfig(cmdBasic);tpl.Update();setTimeout(function(){loadCodeMirror()},1e3)})})}this.GetDomElement=function(){return view};function createTabButton(title,cb){Fit.Validation.ExpectString(title);Fit.Validation.ExpectFunction(cb);var b=new Fit.Controls.Button(Fit.Data.CreateGuid());b.Title(title);b.Type(Fit.Controls.Button.Type.Default);b.OnClick(function(sender){cb(sender)});Fit.Array.Add(buttons,b);return b}function loadBasicConfig(sender){Fit.Validation.ExpectInstance(sender,Fit.Controls.Button);setActiveTabButton(sender);tpl.Content.Properties.Clear();tpl.Content.Headline=lang.Config.Basic;var itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.Receipt;if(JSShop.Settings.Pages&&JSShop.Settings.Pages.length>0){itm.PropertyValue=createDropDown(config.Basic.ReceiptPage?config.Basic.ReceiptPage:"",JSShop.Settings.Pages,function(sender,val){config.Basic.ReceiptPage=val})}else{itm.PropertyValue=createInput(config.Basic.ReceiptPage?config.Basic.ReceiptPage:"",function(sender,val){config.Basic.ReceiptPage=val})}itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.Terms;if(JSShop.Settings.Pages&&JSShop.Settings.Pages.length>0){itm.PropertyValue=createDropDown(config.Basic.TermsPage?config.Basic.TermsPage:"",JSShop.Settings.Pages,function(sender,val){config.Basic.TermsPage=val})}else{itm.PropertyValue=createInput(config.Basic.TermsPage?config.Basic.TermsPage:"",function(sender,val){config.Basic.TermsPage=val})}itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.BccEmail;itm.PropertyValue=createInput(config.Basic.ShopBccEmail?config.Basic.ShopBccEmail:"",function(sender,val){config.Basic.ShopBccEmail=val});tpl.Update()}function showMailTemplates(btn){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);var options=[];var templates=config.MailTemplates.Templates?config.MailTemplates.Templates:[];Fit.Array.ForEach(templates,function(mt){Fit.Array.Add(options,mt.Title)});showOptions(btn,options,function(selectedValue){loadMailConfig(btn,selectedValue)})}function loadMailConfig(btn,tplName){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);Fit.Validation.ExpectString(tplName);setActiveTabButton(btn);tpl.Content.Properties.Clear();var templates=config.MailTemplates.Templates?config.MailTemplates.Templates:[];var mt=null;Fit.Array.ForEach(templates,function(t){if(t.Title===tplName){mt=t;return false}});tpl.Content.Headline=mt.Title;var itmSubject=tpl.Content.Properties.AddItem();itmSubject.PropertyName=lang.Config.Subject;itmSubject.PropertyValue=createInput(mt.Subject,function(sender,val){mt.Subject=val});var autoLineBreaksTag="\x3c!-- JSShopAutoLineBreaks --\x3e\n";var autoLineBreaks=mt.Content.indexOf(autoLineBreaksTag)===0;var val=mt.Content.replace(autoLineBreaksTag,"");val=autoLineBreaks===true?val.replace(/<br\s?\/?>/g,"\n"):val;var itmContent=tpl.Content.Properties.AddItem();itmContent.PropertyName=lang.Config.Content;itmContent.PropertyValue=createInput("",function(sender,val){if(autoLineBreaks===true){mt.Content=autoLineBreaksTag+val.replace(/\n/g,"<br>")}else{mt.Content=val}});itmContent.PropertyValue.FitControl.Width(95,"%");itmContent.PropertyValue.FitControl.Height(250);itmContent.PropertyValue.FitControl.MultiLine(true);itmContent.PropertyValue.FitControl.Maximizable(true);itmContent.PropertyValue.FitControl.Value(val);var chk=new Fit.Controls.CheckBox(Fit.Data.CreateGuid());chk.Label(Fit.String.EncodeHtml(lang.Config.AutoLineBreaks));chk.Checked(autoLineBreaks);chk.OnChange(function(sender){if(chk.Checked()===true){mt.Content=autoLineBreaksTag+itmContent.PropertyValue.FitControl.Value().replace(/\n/g,"<br>");itmContent.PropertyValue.FitControl.Value(itmContent.PropertyValue.FitControl.Value().replace(/<br\s?\/?>/g,"\n"));autoLineBreaks=true}else{mt.Content=itmContent.PropertyValue.FitControl.Value().replace(autoLineBreaksTag,"");itmContent.PropertyValue.FitControl.Value(itmContent.PropertyValue.FitControl.Value().replace(/\n/g,"<br>"));autoLineBreaks=false}});chk.GetDomElement().FitControl=chk;var itmLineBreaks=tpl.Content.Properties.AddItem();itmLineBreaks.PropertyValue=chk.GetDomElement();tpl.Update()}function showPayMethods(btn){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);var options=[];Fit.Array.ForEach(config.PaymentMethods,function(pm){Fit.Array.Add(options,pm.Module)});showOptions(btn,options,function(selectedValue){loadPaymentMethod(btn,selectedValue)})}function loadPaymentMethod(btn,moduleName){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);Fit.Validation.ExpectString(moduleName);setActiveTabButton(btn);tpl.Content.Properties.Clear();var module=null;Fit.Array.ForEach(config.PaymentMethods,function(pm){if(pm.Module===moduleName){module=pm;return false}});tpl.Content.Headline=module.Module;var chk=new Fit.Controls.CheckBox(Fit.Data.CreateGuid());chk.Label(lang.Config.EnableModule);chk.Checked(module.Enabled);chk.OnChange(function(sender){module.Enabled=chk.Checked()});chk.GetDomElement().FitControl=chk;var itmTitle=tpl.Content.Properties.AddItem();itmTitle.PropertyName=lang.Config.Title;itmTitle.PropertyValue=createInput(module.Title,function(sender,val){module.Title=val});Fit.Array.ForEach(module.Settings?module.Settings:[],function(s){var itm=tpl.Content.Properties.AddItem();itm.PropertyName=s.Title;itm.PropertyValue=createInput(s.Value,function(sender,val){s.Value=val})});var enabledItem=tpl.Content.Properties.AddItem();enabledItem.PropertyName=lang.Config.Enabled;enabledItem.PropertyValue=chk.GetDomElement();tpl.Update()}function showAdvanced(btn){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);var options=[];Fit.Array.Add(options,(!config.MailTemplates.Templates||config.MailTemplates.Templates.length===0||config.MailTemplates.Templates.length===2?"!":"")+lang.Config.EmailTemplates);for(var i=0;i<3;i++){Fit.Array.Add(options,(!config.CostCorrections||!config.CostCorrections[i]?"!":"")+lang.Config.CostCorrection+" "+(i+1))}Fit.Array.Add(options,(config.CostCorrections.length===0?"!":"")+lang.Config.AdditionalData);Fit.Array.Add(options,lang.Config.Identifiers);showOptions(btn,options,function(selectedValue){loadAdvanced(btn,selectedValue)})}function loadAdvanced(btn,section){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);Fit.Validation.ExpectString(section);setActiveTabButton(btn);tpl.Content.Properties.Clear();tpl.Content.Headline=section;var itm=null;if(section===lang.Config.EmailTemplates){itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.ConfirmTemplate;itm.PropertyValue=createInput(config.MailTemplates.Confirmation?config.MailTemplates.Confirmation:"",function(sender,val){config.MailTemplates.Confirmation=val});itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.InvoiceTemplate;itm.PropertyValue=createInput(config.MailTemplates.Invoice?config.MailTemplates.Invoice:"",function(sender,val){config.MailTemplates.Invoice=val})}else if(section.indexOf(lang.Config.CostCorrection)===0){var ccId=parseInt(section.substring(section.length-1),10)-1;var cc=config.CostCorrections[ccId];if(!cc)return;itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.CostExpression;itm.PropertyValue=createCostCorrectionExpressionInput(cc.CostCorrection,"number",function(sender,val){cc.CostCorrection=val});itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.VatExpression;itm.PropertyValue=createCostCorrectionExpressionInput(cc.Vat,"number",function(sender,val){cc.Vat=val});itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.MessageExpression;itm.PropertyValue=createCostCorrectionExpressionInput(cc.Message,"string",function(sender,val){cc.Message=val})}else if(section===lang.Config.AdditionalData){itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.AdditionalDataJson;itm.PropertyValue=createAdditionalDataExpressionInput(config.AdditionalData,function(sender,val){config.AdditionalData=val;if(sender.IsValid()===true){JSShop.Settings.AdditionalData=val!==""?JSON.parse(val):{}}})}else if(section===lang.Config.Identifiers){var orgNextOrderId=config.Identifiers.NextOrderId.Value.toString();itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.NextOrderId;itm.PropertyValue=createInput(orgNextOrderId,function(sender,val){if(parseInt(val).toString()===val&&parseInt(val)>0&&orgNextOrderId!==val){config.Identifiers.NextOrderId.Value=parseInt(val);config.Identifiers.NextOrderId.Dirty=true}else{config.Identifiers.NextOrderId.Value=parseInt(orgNextOrderId);config.Identifiers.NextOrderId.Dirty=false}});var orgNextInvoiceId=config.Identifiers.NextInvoiceId.Value.toString();itm=tpl.Content.Properties.AddItem();itm.PropertyName=lang.Config.NextInvoiceId;itm.PropertyValue=createInput(orgNextInvoiceId,function(sender,val){if(parseInt(val).toString()===val&&parseInt(val)>0&&orgNextInvoiceId!==val){config.Identifiers.NextInvoiceId.Value=parseInt(val);config.Identifiers.NextInvoiceId.Dirty=true}else{config.Identifiers.NextInvoiceId.Value=parseInt(orgNextInvoiceId);config.Identifiers.NextInvoiceId.Dirty=false}})}tpl.Update()}function showOptions(btn,options,cb){Fit.Validation.ExpectInstance(btn,Fit.Controls.Button);Fit.Validation.ExpectTypeArray(options,Fit.Validation.ExpectString);Fit.Validation.ExpectFunction(cb);ctx.RemoveAllChildren(true);Fit.Array.ForEach(options,function(opt){var enabled=opt.indexOf("!")!==0;var title=enabled===true?opt:opt.substring(1);var item=new Fit.Controls.ContextMenu.Item(title,title);item.Selectable(enabled);ctx.AddChild(item)});ctxCallback=cb;var el=btn.GetDomElement();var pos=Fit.Dom.GetPosition(el);var x=pos.X;var y=pos.Y+el.offsetHeight;ctx.Show(x,y);Fit.Dom.Add(me.GetDomElement(),ctx.GetDomElement());ctx.Focused(true)}function createInput(value,onChange){Fit.Validation.ExpectString(value);Fit.Validation.ExpectFunction(onChange);var ctl=new Fit.Controls.Input(Fit.Data.CreateGuid());ctl.Value(value);ctl.OnChange(function(sender){onChange(sender,ctl.Value())});ctl.Width(95,"%");ctl.GetDomElement().FitControl=ctl;return ctl.GetDomElement()}function createExpressionInput(value,onChange){Fit.Validation.ExpectString(value);Fit.Validation.ExpectFunction(onChange);var input=createInput(value,onChange);input.FitControl.CheckSpelling(false);input.FitControl.MultiLine(true);input.FitControl.Value(value);setTimeout(function(){activateCodeMirror(input.FitControl)},0);return input}function createCostCorrectionExpressionInput(value,valueType,onChange){Fit.Validation.ExpectString(value);Fit.Validation.ExpectString(valueType);Fit.Validation.ExpectFunction(onChange);var input=createExpressionInput(value,onChange);input.FitControl.SetValidationCallback(function(val){if(val==="")return true;try{JSShop.Models.Order.CalculateExpression(100,.1,"USD",.5,"kg","5000","DIBS","TvCampaign","A","B","C",val,valueType);JSShop.Models.Order.CalculateExpression(1,.25,"DKK",25,"lbs","9850","QuickPay","Spring","X","Y","Z",val,valueType)}catch(err){return false}return true},lang.Config.InvalidExpression);return input}function createAdditionalDataExpressionInput(value,onChange){Fit.Validation.ExpectString(value);Fit.Validation.ExpectFunction(onChange);var input=createExpressionInput(value,onChange);input.FitControl.SetValidationCallback(function(val){if(val==="")return true;try{var res=JSON.parse(val);return res!==undefined&&res!==null&&res.constructor===Object}catch(err){return false}},lang.Config.InvalidJson);return input}function createDropDown(value,options,onChange){Fit.Validation.ExpectString(value);Fit.Validation.ExpectArray(options);Fit.Validation.ExpectFunction(onChange);var ctl=new Fit.Controls.DropDown(Fit.Data.CreateGuid());ctl.SetPicker(new Fit.Controls.ListView);ctl.Width(95,"%");var title=value;Fit.Array.ForEach(options,function(option){Fit.Validation.ExpectString(option.Title);Fit.Validation.ExpectString(option.Value);if(option.Value===value)title=option.Title;ctl.GetPicker().AddItem(option.Title,option.Value)});if(value!==""){ctl.AddSelection(title,value)}ctl.OnChange(function(sender){onChange(sender,ctl.GetSelections().length!==0?ctl.GetSelections()[0].Value:"")});ctl.GetDomElement().FitControl=ctl;return ctl.GetDomElement()}function setActiveTabButton(active){Fit.Validation.ExpectInstance(active,Fit.Controls.Button);Fit.Array.ForEach(buttons,function(btn){btn.Type(Fit.Controls.Button.Type.Default)});active.Type(Fit.Controls.Button.Type.Primary);active.Focused(false)}function loadCodeMirror(callback){Fit.Validation.ExpectFunction(callback,true);var cb=callback?callback:function(){};if(codeMirrorLoadState===1){cb()}else if(codeMirrorLoadState===0){var checkInt=-1;checkInt=setInterval(function(){if(codeMirrorLoadState===1){clearInterval(checkInt);cb()}},250)}else{codeMirrorLoadState=0;Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/CodeMirror/codemirror.min.css");Fit.Loader.LoadScript(JSShop.GetPath()+"/CodeMirror/codemirror.bundled.min.js",function(cfgs){codeMirrorLoadState=1;cb()})}}function activateCodeMirror(ctl){Fit.Validation.ExpectInstance(ctl,Fit.Controls.Input);loadCodeMirror(function(){ctl.GetDomElement().style.height="auto";var codeEditor=CodeMirror.fromTextArea(ctl.GetDomElement().querySelector("textarea"),{lineNumbers:true,mode:"javascript",matchBrackets:true,viewportMargin:Infinity,styleActiveLine:true});codeEditor.getWrapperElement().style.cssText+="; border: 1px solid silver; height: auto;";codeEditor.on("change",function(sender,args){ctl.Value(sender.getValue())})})}init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.OrderForm=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var me=this;var dom=null;var lang=JSShop.Language.Translations;var txtCompany=null;var txtFirstName=null;var txtLastName=null;var txtAddress=null;var txtZipCode=null;var txtCity=null;var txtEmail=null;var txtPhone=null;var txtMessage=null;var chkRememberMe=null;var chkAlternativeAddress=null;var txtAltCompany=null;var txtAltFirstName=null;var txtAltLastName=null;var txtAltAddress=null;var txtAltZipCode=null;var txtAltCity=null;var txtPromoCode=null;var lstPaymentMethod=null;var chkAcceptTerms=null;var cmdContinue=null;function init(){dom=document.createElement("div");if(JSShop.Models.Basket.GetItems().length===0)return;if(document.querySelector("link[href*='/Views/OrderForm/OrderForm.css']")===null){Fit.Browser.Log("Lazy loading OrderForm.css");Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderForm/OrderForm.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"))}var tpl=new Fit.Template;tpl.AllowUnsafeContent(false);tpl.LoadUrl(JSShop.GetPath()+"/Views/OrderForm/OrderForm.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){tpl.Content.AddressArea=lang.OrderForm.CustomerDetails;tpl.Content.CompanyLabel=lang.OrderForm.Company;tpl.Content.CompanyControl=txtCompany;tpl.Content.FirstNameLabel=lang.OrderForm.FirstName;tpl.Content.FirstNameControl=txtFirstName;tpl.Content.LastNameLabel=lang.OrderForm.LastName;tpl.Content.LastNameControl=txtLastName;tpl.Content.AddressLabel=lang.OrderForm.Address;tpl.Content.AddressControl=txtAddress;tpl.Content.ZipCodeLabel=lang.OrderForm.ZipCode;tpl.Content.ZipCodeControl=txtZipCode;tpl.Content.CityLabel=lang.OrderForm.City;tpl.Content.CityControl=txtCity;tpl.Content.EmailLabel=lang.OrderForm.Email;tpl.Content.EmailControl=txtEmail;tpl.Content.PhoneLabel=lang.OrderForm.Phone;tpl.Content.PhoneControl=txtPhone;tpl.Content.MessageLabel=lang.OrderForm.Message;tpl.Content.MessageControl=txtMessage;tpl.Content.RememberMeControl=chkRememberMe;tpl.Content.EnableAltAddressControl=chkAlternativeAddress;tpl.Content.AltAddressDisplay=chkAlternativeAddress.Checked()===true?"block":"none";tpl.Content.AltAddressArea=lang.OrderForm.AlternativeAddress;tpl.Content.AltCompanyLabel=lang.OrderForm.Company;tpl.Content.AltCompanyControl=txtAltCompany;tpl.Content.AltFirstNameLabel=lang.OrderForm.FirstName;tpl.Content.AltFirstNameControl=txtAltFirstName;tpl.Content.AltLastNameLabel=lang.OrderForm.LastName;tpl.Content.AltLastNameControl=txtAltLastName;tpl.Content.AltAddressLabel=lang.OrderForm.Address;tpl.Content.AltAddressControl=txtAltAddress;tpl.Content.AltZipCodeLabel=lang.OrderForm.ZipCode;tpl.Content.AltZipCodeControl=txtAltZipCode;tpl.Content.AltCityLabel=lang.OrderForm.City;tpl.Content.AltCityControl=txtAltCity;if((lstPaymentMethod!==null||txtPromoCode!==null)&&chkAcceptTerms!==null)tpl.Content.PaymentArea=lang.OrderForm.PaymentAndTerms;else if(lstPaymentMethod!==null||txtPromoCode!==null)tpl.Content.PaymentArea=lang.OrderForm.Payment;else if(chkAcceptTerms!==null)tpl.Content.PaymentArea=lang.OrderForm.Terms;if(txtPromoCode!==null){tpl.Content.PromoCodeLabel=lang.OrderForm.PromotionCode;tpl.Content.PromoCodeControl=txtPromoCode}if(lstPaymentMethod!==null){tpl.Content.PaymentMethodLabel=lang.OrderForm.PaymentMethod;tpl.Content.PaymentMethodControl=lstPaymentMethod}if(chkAcceptTerms!==null){tpl.Content.AcceptTermsControl=chkAcceptTerms;var dialog=new Fit.Controls.Dialog;dialog.Title(lang.OrderForm.AcceptTerms);dialog.Modal(true);dialog.Maximizable(true);dialog.ContentUrl(JSShop.Settings.TermsUrl);dialog.Width(50,"%");dialog.Height(50,"%");var cmdOk=new Fit.Controls.Button("JSShopOkButton");cmdOk.Type(Fit.Controls.Button.Type.Success);cmdOk.Title(lang.Common.Ok);cmdOk.OnClick(function(sender){chkAcceptTerms.Checked(true);dialog.Close()});dialog.AddButton(cmdOk);var cmdCancel=new Fit.Controls.Button("JSShopCancelButton");cmdCancel.Type(Fit.Controls.Button.Type.Danger);cmdCancel.Title(lang.Common.Cancel);cmdCancel.OnClick(function(sender){chkAcceptTerms.Checked(false);dialog.Close()});dialog.AddButton(cmdCancel);var link=Fit.Dom.CreateElement(" (<a href='javascript:'>"+lang.OrderForm.Read+"</a>)","span");link.onclick=function(e){dialog.Open(me.GetDomElement().parentElement);Fit.Events.StopPropagation(e)};var chkId="Chk"+Fit.Data.CreateGuid();chkAcceptTerms.Label(chkAcceptTerms.Label()+"<div id='"+chkId+"'></div>");Fit.Dom.Replace(chkAcceptTerms.GetDomElement().querySelector("#"+chkId),link)}tpl.Content.ContinuePurchaseControl=cmdContinue;tpl.Render(dom)});txtCompany=new Fit.Controls.Input("JSShopCompany");txtCompany.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtCompany.Scope("JSShopOrderForm");txtCompany.LazyValidation(true);txtCompany.OnChange(saveValue);txtCompany.OnBlur(cleanUp);txtCompany.Width(100,"%");txtFirstName=new Fit.Controls.Input("JSShopFirstName");txtFirstName.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtFirstName.Required(true);txtFirstName.Scope("JSShopOrderForm");txtFirstName.LazyValidation(true);txtFirstName.OnChange(saveValue);txtFirstName.OnBlur(cleanUp);txtFirstName.Width(100,"%");txtLastName=new Fit.Controls.Input("JSShopLastName");txtLastName.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtLastName.Required(true);txtLastName.Scope("JSShopOrderForm");txtLastName.LazyValidation(true);txtLastName.OnChange(saveValue);txtLastName.OnBlur(cleanUp);txtLastName.Width(100,"%");txtAddress=new Fit.Controls.Input("JSShopAddress");txtAddress.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAddress.Required(true);txtAddress.Scope("JSShopOrderForm");txtAddress.LazyValidation(true);txtAddress.OnChange(saveValue);txtAddress.OnBlur(cleanUp);txtAddress.Width(100,"%");txtZipCode=new Fit.Controls.Input("JSShopZipCode");txtZipCode.SetValidationCallback(function(val){return val.length<=20},lang.Common.MaxLengthExceeded);txtZipCode.Required(true);txtZipCode.Scope("JSShopOrderForm");txtZipCode.LazyValidation(true);txtZipCode.OnChange(saveValue);txtZipCode.OnBlur(cleanUp);txtZipCode.Width(100,"%");if(isContainedInCostCorrections("zipcodeval")===true){txtZipCode.SetValidationExpression(/^\d*$/,lang.OrderForm.EnterValidZipCode)}txtCity=new Fit.Controls.Input("JSShopCity");txtCity.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtCity.Required(true);txtCity.Scope("JSShopOrderForm");txtCity.LazyValidation(true);txtCity.OnChange(saveValue);txtCity.OnBlur(cleanUp);txtCity.Width(100,"%");txtEmail=new Fit.Controls.Input("JSShopEmail");txtEmail.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtEmail.SetValidationExpression(/^[a-z0-9!#$%&'*+-\/=?^_`{|}~]+@[a-z0-9_.-]+$/i,lang.OrderForm.EnterValidEmail);txtEmail.Required(true);txtEmail.Scope("JSShopOrderForm");txtEmail.LazyValidation(true);txtEmail.OnChange(saveValue);txtEmail.OnBlur(cleanUp);txtEmail.Width(100,"%");txtPhone=new Fit.Controls.Input("JSShopPhone");txtPhone.SetValidationCallback(function(val){return val.length<=20},lang.Common.MaxLengthExceeded);txtPhone.Scope("JSShopOrderForm");txtPhone.LazyValidation(true);txtPhone.OnChange(saveValue);txtPhone.OnBlur(cleanUp);txtPhone.Width(100,"%");txtMessage=new Fit.Controls.Input("JSShopMessage");txtMessage.SetValidationCallback(function(val){return val.length<=250},lang.Common.MaxLengthExceeded);txtMessage.Scope("JSShopOrderForm");txtMessage.LazyValidation(true);txtMessage.MultiLine(true);txtMessage.Width(100,"%");txtMessage.Height(6,"em");txtMessage.OnBlur(cleanUp);chkRememberMe=new Fit.Controls.CheckBox("JSShopRememberMe");chkRememberMe.Label(lang.OrderForm.RememberMe);chkRememberMe.Value(JSShop.Cookies.Get(chkRememberMe.GetId())!==null?JSShop.Cookies.Get(chkRememberMe.GetId()):"false");chkRememberMe.OnChange(function(sender){if(chkRememberMe.Checked()===true)saveValue(chkRememberMe);else clearValue(chkRememberMe)});chkRememberMe.OnChange(function(sender){saveValues()});chkAlternativeAddress=new Fit.Controls.CheckBox("JSShopAlternativeAddress");chkAlternativeAddress.Label(lang.OrderForm.AlternativeAddress);chkAlternativeAddress.OnChange(saveValue);chkAlternativeAddress.OnChange(function(sender){if(document.querySelector("div.JSShopAlternativeAddress")!==null)document.querySelector("div.JSShopAlternativeAddress").style.display=chkAlternativeAddress.Checked()===true?"block":"none"});txtAltCompany=new Fit.Controls.Input("JSShopAltCompany");txtAltCompany.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAltCompany.Scope("JSShopOrderForm");txtAltCompany.LazyValidation(true);txtAltCompany.OnChange(saveValue);txtAltCompany.OnBlur(cleanUp);txtAltCompany.Width(100,"%");txtAltFirstName=new Fit.Controls.Input("JSShopAltFirstName");txtAltFirstName.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAltFirstName.Scope("JSShopOrderForm");txtAltFirstName.LazyValidation(true);txtAltFirstName.OnChange(saveValue);txtAltFirstName.OnBlur(cleanUp);txtAltFirstName.Width(100,"%");txtAltLastName=new Fit.Controls.Input("JSShopAltLastName");txtAltLastName.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAltLastName.Scope("JSShopOrderForm");txtAltLastName.LazyValidation(true);txtAltLastName.OnChange(saveValue);txtAltLastName.OnBlur(cleanUp);txtAltLastName.Width(100,"%");txtAltAddress=new Fit.Controls.Input("JSShopAltAddress");txtAltAddress.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAltAddress.Scope("JSShopOrderForm");txtAltAddress.LazyValidation(true);txtAltAddress.OnChange(saveValue);txtAltAddress.OnBlur(cleanUp);txtAltAddress.Width(100,"%");txtAltZipCode=new Fit.Controls.Input("JSShopAltZipCode");txtAltZipCode.SetValidationCallback(function(val){return val.length<=20},lang.Common.MaxLengthExceeded);txtAltZipCode.Scope("JSShopOrderForm");txtAltZipCode.LazyValidation(true);txtAltZipCode.OnChange(saveValue);txtAltZipCode.OnBlur(cleanUp);txtAltZipCode.Width(100,"%");if(isContainedInCostCorrections("zipcodeval")===true){txtAltZipCode.SetValidationExpression(/^\d*$/,lang.OrderForm.EnterValidZipCode)}txtAltCity=new Fit.Controls.Input("JSShopAltCity");txtAltCity.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtAltCity.Scope("JSShopOrderForm");txtAltCity.LazyValidation(true);txtAltCity.OnChange(saveValue);txtAltCity.OnBlur(cleanUp);txtAltCity.Width(100,"%");if(isContainedInCostCorrections("promocode")===true){txtPromoCode=new Fit.Controls.Input("JSShopPromoCode");txtPromoCode.SetValidationCallback(function(val){return val.length<=30},lang.Common.MaxLengthExceeded);txtPromoCode.Scope("JSShopOrderForm");txtPromoCode.LazyValidation(true);txtPromoCode.OnBlur(cleanUp);txtPromoCode.Width(100,"%")}if(JSShop.Settings.PaymentMethods&&JSShop.Settings.PaymentMethods.length>0){var enabled=[];Fit.Array.ForEach(JSShop.Settings.PaymentMethods,function(pm){if(pm.Title&&pm.Module&&pm.Enabled===true){Fit.Array.Add(enabled,pm)}});if(enabled.length>0){lstPaymentMethod=new Fit.Controls.DropDown("JSShopPaymentMethod");lstPaymentMethod.Required(true);lstPaymentMethod.Scope("JSShopOrderForm");lstPaymentMethod.LazyValidation(true);lstPaymentMethod.OnChange(saveValue);lstPaymentMethod.SetPicker(new Fit.Controls.ListView);lstPaymentMethod.Width(100,"%");Fit.Array.ForEach(enabled,function(pm){lstPaymentMethod.GetPicker().AddItem(pm.Title,pm.Module)})}if(enabled.length===1){lstPaymentMethod.AddSelection(enabled[0].Title,enabled[0].Module)}}if(JSShop.Settings.TermsUrl){chkAcceptTerms=new Fit.Controls.CheckBox("JSShopAcceptTerms");chkAcceptTerms.Label(lang.OrderForm.AcceptTerms)}cmdContinue=new Fit.Controls.Button("JSShopContinue");cmdContinue.Type(Fit.Controls.Button.Type.Primary);cmdContinue.Title(lang.OrderForm.Continue);cmdContinue.OnClick(function(sender){if(chkAcceptTerms!==null&&chkAcceptTerms.Checked()===false){Fit.Controls.Dialog.Alert(lang.OrderForm.TermsRequired);return}if(txtPhone.Value()===""){var dialog=new Fit.Controls.Dialog;dialog.Modal(true);dialog.Content(lang.OrderForm.MissingPhoneNumber);var cmdContinueWithout=new Fit.Controls.Button("JSShopContinueWithoutButton");var cmdGoBack=new Fit.Controls.Button("JSShopGoBackButton");cmdContinueWithout.Type(Fit.Controls.Button.Type.Default);cmdContinueWithout.Title(lang.OrderForm.ContinueWithout);cmdContinueWithout.OnClick(function(sender){dialog.Close();dialog.Dispose();processOrder()});dialog.AddButton(cmdContinueWithout);cmdGoBack.Type(Fit.Controls.Button.Type.Default);cmdGoBack.Title(lang.OrderForm.AddPhoneNumber);cmdGoBack.OnClick(function(sender){dialog.Close();dialog.Dispose();txtPhone.Focused(true)});dialog.AddButton(cmdGoBack);dialog.Open();cmdGoBack.Focused(true);return}processOrder()});restoreValues()}this.BindBasket=function(basket){Fit.Validation.ExpectInstance(basket,JSShop.Presenters.Basket);cmdContinue.Enabled(false);basket.ZipCode(chkAlternativeAddress.Checked()===false?txtZipCode.Value():txtAltZipCode.Value());if(lstPaymentMethod!==null&&lstPaymentMethod.GetSelections().length!==0)basket.PaymentMethod(lstPaymentMethod.GetSelections()[0].Value);var prevPricing=null;basket.OnUpdate(function(sender){cmdContinue.Enabled(false)});basket.OnUpdated(function(sender){if(prevPricing!==null&&Fit.Core.IsEqual(prevPricing,basket.GetPricing())===false){var focused=Fit.Dom.GetFocused();Fit.Controls.Dialog.Alert(lang.OrderForm.BasketUpdated,function(){focused.focus()})}prevPricing=basket.GetPricing();cmdContinue.Enabled(true)});var updateZipCode=function(sender){if(chkAlternativeAddress.Checked()===false)basket.ZipCode(txtZipCode.Value());else if(txtAltZipCode.Value()!=="")basket.ZipCode(txtAltZipCode.Value())};txtZipCode.OnBlur(updateZipCode);txtAltZipCode.OnBlur(updateZipCode);chkAlternativeAddress.OnChange(updateZipCode);if(txtPromoCode!==null){txtPromoCode.OnBlur(function(sender){basket.PromoCode(txtPromoCode.Value())})}if(lstPaymentMethod!==null){lstPaymentMethod.OnChange(function(sender){if(lstPaymentMethod.GetSelections().length===0)return;basket.PaymentMethod(lstPaymentMethod.GetSelections()[0].Value)})}};this.GetDomElement=function(){return dom};function isContainedInCostCorrections(val){Fit.Validation.ExpectString(val);return JSShop.Settings.CostCorrection1&&JSShop.Settings.CostCorrection1.indexOf(val)>-1||JSShop.Settings.CostCorrection2&&JSShop.Settings.CostCorrection2.indexOf(val)>-1||JSShop.Settings.CostCorrection3&&JSShop.Settings.CostCorrection3.indexOf(val)>-1||JSShop.Settings.CostCorrectionVat1&&JSShop.Settings.CostCorrectionVat1.indexOf(val)>-1||JSShop.Settings.CostCorrectionVat2&&JSShop.Settings.CostCorrectionVat2.indexOf(val)>-1||JSShop.Settings.CostCorrectionVat3&&JSShop.Settings.CostCorrectionVat3.indexOf(val)>-1||JSShop.Settings.CostCorrectionMessage1&&JSShop.Settings.CostCorrectionMessage1.indexOf(val)>-1||JSShop.Settings.CostCorrectionMessage2&&JSShop.Settings.CostCorrectionMessage2.indexOf(val)>-1||JSShop.Settings.CostCorrectionMessage3&&JSShop.Settings.CostCorrectionMessage3.indexOf(val)>-1}function cleanUp(sender){Fit.Validation.ExpectInstance(sender,Fit.Controls.Input);var val=sender.Value();var trimmed=Fit.String.Trim(val.replace(""," "));if(trimmed!==sender.Value())sender.Value(trimmed)}function processOrder(errorCallback){Fit.Validation.ExpectFunction(errorCallback,true);if(Fit.Controls.ValidateAll("JSShopOrderForm")===false){Fit.Controls.Dialog.Alert(lang.Common.InvalidEntries);if(Fit.Validation.IsSet(errorCallback)===true)errorCallback();return}if(chkAlternativeAddress.Checked()===true){var altAddressUsed=txtAltCompany.Value()!==""||txtAltFirstName.Value()!==""||txtAltLastName.Value()!==""||txtAltAddress.Value()!==""||txtAltZipCode.Value()!==""||txtAltCity.Value()!=="";var altAddressPartial=altAddressUsed===true&&(txtAltFirstName.Value()===""||txtAltLastName.Value()===""||txtAltAddress.Value()===""||txtAltZipCode.Value()===""||txtAltCity.Value()==="");if(altAddressPartial===true){Fit.Controls.Dialog.Alert(lang.OrderForm.PartialAltAddress);return}}cmdContinue.Enabled(false);cmdContinue.Icon("fa-spinner fa-spin");var o=new JSShop.Models.Order(Fit.Data.CreateGuid());o.Company(txtCompany.Value());o.FirstName(txtFirstName.Value());o.LastName(txtLastName.Value());o.Address(txtAddress.Value());o.ZipCode(txtZipCode.Value());o.City(txtCity.Value());o.Email(txtEmail.Value());o.Phone(txtPhone.Value());o.Message(txtMessage.Value());if(chkAlternativeAddress.Checked()===true){o.AltCompany(txtAltCompany.Value());o.AltFirstName(txtAltFirstName.Value());o.AltLastName(txtAltLastName.Value());o.AltAddress(txtAltAddress.Value());o.AltZipCode(txtAltZipCode.Value());o.AltCity(txtAltCity.Value())}if(txtPromoCode!==null)o.PromoCode(txtPromoCode.Value());if(lstPaymentMethod!==null)o.PaymentMethod(lstPaymentMethod.GetSelections()[0].Value);var showLoaderId=-1;showLoaderId=setTimeout(function(){var loadDia=new Fit.Controls.Dialog;loadDia.Content(lang.OrderForm.PleaseWait);loadDia.Modal(true);loadDia.Open();setTimeout(function(){loadDia.Dispose()},15e3)},8e3);JSShop.Models.Basket.CreateOrder(o,function(order){clearTimeout(showLoaderId);JSShop.Models.Basket.Clear();if(JSShop.Settings.PaymentUrl){setTimeout(function(){location.href=JSShop.Settings.PaymentUrl+(JSShop.Settings.PaymentUrl.indexOf("?")===-1?"?":"&")+"OrderId="+order.Id()},750)}else if(JSShop.Settings.ReceiptUrl){setTimeout(function(){location.href=JSShop.Settings.ReceiptUrl},750)}else{Fit.Controls.Dialog.Alert(lang.OrderForm.OrderReceived,function(){location.href=location.href})}},function(order){if(Fit.Validation.IsSet(errorCallback)===true)errorCallback();cmdContinue.Enabled(true)})}function saveValue(sender){Fit.Validation.ExpectInstance(sender,Fit.Controls.ControlBase);if(chkRememberMe.Checked()===true)JSShop.Cookies.Set(sender.GetId(),sender.Value().replace(/;/g,"{[SEMI]}"),60*60*24*365*5)}function restoreValue(sender){Fit.Validation.ExpectInstance(sender,Fit.Controls.ControlBase);if(chkRememberMe.Checked()===true&&JSShop.Cookies.Get(sender.GetId())!==null)sender.Value(JSShop.Cookies.Get(sender.GetId()).replace(/\{\[SEMI\]\}/g,";"))}function clearValue(sender){Fit.Validation.ExpectInstance(sender,Fit.Controls.ControlBase);JSShop.Cookies.Remove(sender.GetId())}function saveValues(){var controls=[];Fit.Array.Add(controls,txtCompany);Fit.Array.Add(controls,txtFirstName);Fit.Array.Add(controls,txtLastName);Fit.Array.Add(controls,txtAddress);Fit.Array.Add(controls,txtZipCode);Fit.Array.Add(controls,txtCity);Fit.Array.Add(controls,txtEmail);Fit.Array.Add(controls,txtPhone);Fit.Array.Add(controls,chkAlternativeAddress);Fit.Array.Add(controls,txtAltCompany);Fit.Array.Add(controls,txtAltFirstName);Fit.Array.Add(controls,txtAltLastName);Fit.Array.Add(controls,txtAltAddress);Fit.Array.Add(controls,txtAltZipCode);Fit.Array.Add(controls,txtAltCity);if(lstPaymentMethod!==null)Fit.Array.Add(controls,lstPaymentMethod);Fit.Array.ForEach(controls,function(ctrl){if(chkRememberMe.Checked()===true)saveValue(ctrl);else clearValue(ctrl)})}function restoreValues(){restoreValue(txtCompany);restoreValue(txtFirstName);restoreValue(txtLastName);restoreValue(txtAddress);restoreValue(txtZipCode);restoreValue(txtCity);restoreValue(txtEmail);restoreValue(txtPhone);restoreValue(chkAlternativeAddress);restoreValue(txtAltCompany);restoreValue(txtAltFirstName);restoreValue(txtAltLastName);restoreValue(txtAltAddress);restoreValue(txtAltZipCode);restoreValue(txtAltCity);if(lstPaymentMethod!==null){restoreValue(lstPaymentMethod);if(lstPaymentMethod.GetSelections().length>0&&lstPaymentMethod.GetPicker().HasItem(lstPaymentMethod.GetSelections()[0].Value)===false){lstPaymentMethod.Clear()}}}init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.OrderList=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var me=this;var dom=null;var view=null;var models=[];var tagModels=[];var lang=JSShop.Language.Translations;var process=[];var txtSearch=null;var txtFrom=null;var txtTo=null;var cmdUpdate=null;var cmdExport=null;var cmdInvoice=null;var cmdCapture=null;var cmdReject=null;var cmdConfig=null;var chkSelectAll=null;function init(){dom=document.createElement("div");loadView(function(){loadTagModels(function(){loadData();populateToolbarAndColumnsToView()})});createControls()}this.GetDomElement=function(){return dom};function createControls(){txtSearch=new Fit.Controls.Input("JSShopSearch");txtSearch.Width(140);txtSearch.GetDomElement().title=lang.OrderList.Search;txtSearch.Placeholder(lang.OrderList.Search+"..");txtFrom=new Fit.Controls.Input("JSShopFromDate");txtFrom.Required(true);txtFrom.SetValidationCallback(function(res){try{Fit.Date.Parse(txtFrom.Value(),lang.Locale.DateFormat)}catch(err){return false}return true});txtFrom.OnBlur(function(sender){if(txtFrom.IsValid()===false){txtFrom.Value(Fit.Date.Format(new Date,lang.Locale.DateFormat))}else{var d=Fit.Date.Parse(txtFrom.Value(),lang.Locale.DateFormat);var v=Fit.Date.Format(d,lang.Locale.DateFormat);txtFrom.Value(v)}});txtFrom.Width(140);txtFrom.Value(Fit.Date.Format(new Date,lang.Locale.DateFormat));txtFrom.GetDomElement().title=lang.OrderList.DisplayFromDate;txtTo=new Fit.Controls.Input("JSShopToDate");txtTo.Required(true);txtTo.SetValidationCallback(function(res){try{Fit.Date.Parse(txtTo.Value(),lang.Locale.DateFormat)}catch(err){return false}return true});txtTo.OnBlur(function(sender){if(txtTo.IsValid()===false){txtTo.Value(Fit.Date.Format(new Date,lang.Locale.DateFormat))}else{var d=Fit.Date.Parse(txtTo.Value(),lang.Locale.DateFormat);var v=Fit.Date.Format(d,lang.Locale.DateFormat);txtTo.Value(v)}});txtTo.Width(140);txtTo.Value(Fit.Date.Format(new Date,lang.Locale.DateFormat));txtTo.GetDomElement().title=lang.OrderList.DisplayToDate;cmdUpdate=new Fit.Controls.Button("JSShopUpdateButton");cmdUpdate.Icon("fa-refresh");cmdUpdate.Type(Fit.Controls.Button.Type.Primary);cmdUpdate.OnClick(function(sender){loadData()});cmdUpdate.GetDomElement().title=lang.OrderList.Update;cmdExport=new Fit.Controls.Button("JSShopExportButton");cmdExport.Icon("fa-table");cmdExport.Type(Fit.Controls.Button.Type.Primary);cmdExport.OnClick(function(sender){if(process.length===0){Fit.Controls.Dialog.Alert(lang.OrderList.SelectOrders);return}var cmdCsv=new Fit.Controls.Button("JSShopExportCsvButton");cmdCsv.Title("CSV");cmdCsv.Icon("fa-table");cmdCsv.Type(Fit.Controls.Button.Type.Primary);cmdCsv.OnClick(function(sender){dia.Dispose();exportData()});var cmdPdf=new Fit.Controls.Button("JSShopExportPdfButton");cmdPdf.Title("PDF");cmdPdf.Icon("fa-file-pdf-o");cmdPdf.Type(Fit.Controls.Button.Type.Primary);cmdPdf.OnClick(function(sender){dia.Dispose();printOrders()});cmdPdf.Enabled(Fit.Browser.GetInfo().Name!=="MSIE"||Fit.Browser.GetInfo().Version>=10);var cmdCancel=new Fit.Controls.Button("JSShopExportCancelButton");cmdCancel.Title(lang.Common.Cancel);cmdCancel.Icon("fa-cancel");cmdCancel.Type(Fit.Controls.Button.Type.Danger);cmdCancel.OnClick(function(sender){dia.Dispose()});var dia=new Fit.Controls.Dialog;dia.Content(lang.OrderList.ChooseFormat);dia.Modal(true);dia.AddButton(cmdCsv);dia.AddButton(cmdPdf);dia.AddButton(cmdCancel);dia.Open(me.GetDomElement().parentElement);cmdCsv.Focused(true)});cmdExport.GetDomElement().title=lang.OrderList.Export;cmdInvoice=new Fit.Controls.Button("JSShopInvoiceButton");cmdInvoice.Icon("fa-paperclip");cmdInvoice.Type(Fit.Controls.Button.Type.Primary);cmdInvoice.OnClick(function(sender){if(process.length===0){Fit.Controls.Dialog.Alert(lang.OrderList.SelectOrders);return}Fit.Controls.Dialog.Confirm(lang.OrderList.ConfirmAction+": "+lang.OrderList.SendInvoice,function(res){if(res===true)sendInvoices()})});cmdInvoice.GetDomElement().title=lang.OrderList.SendInvoice;if(JSShop.Settings.PaymentCaptureUrl){cmdCapture=new Fit.Controls.Button("JSShopCaptureButton");cmdCapture.Icon("fa-exchange");cmdCapture.Type(Fit.Controls.Button.Type.Success);cmdCapture.OnClick(function(sender){if(process.length===0){Fit.Controls.Dialog.Alert(lang.OrderList.SelectOrders);return}Fit.Controls.Dialog.Confirm(lang.OrderList.ConfirmAction+": "+lang.OrderList.Capture,function(res){if(res===true)processPayments("Capture")})});cmdCapture.GetDomElement().title=lang.OrderList.Capture}if(JSShop.Settings.PaymentCancelUrl){cmdReject=new Fit.Controls.Button("JSShopReturnButton");cmdReject.Icon("fa-trash");cmdReject.Type(Fit.Controls.Button.Type.Danger);cmdReject.OnClick(function(sender){if(process.length===0){Fit.Controls.Dialog.Alert(lang.OrderList.SelectOrders);return}Fit.Controls.Dialog.Confirm(lang.OrderList.ConfirmAction+": "+lang.OrderList.Reject,function(res){if(res===true)processPayments("Reject")})});cmdReject.GetDomElement().title=lang.OrderList.Reject}if(JSShop.Settings.ConfigUrl){cmdConfig=new Fit.Controls.Button("JSShopConfigButton");cmdConfig.Icon("fa-cog");cmdConfig.Type(Fit.Controls.Button.Type.Warning);cmdConfig.OnClick(function(sender){location.href=JSShop.Settings.ConfigUrl});cmdConfig.GetDomElement().title=lang.OrderList.Settings}chkSelectAll=new Fit.Controls.CheckBox("JSShopSelectAll");chkSelectAll.OnChange(function(sender){if(chkSelectAll.Focused()===true){Fit.Array.ForEach(models,function(model){model._presenter.checkBox.Checked(chkSelectAll.Checked())})}})}function loadView(onComplete){Fit.Validation.ExpectFunction(onComplete);if(document.querySelector("link[href*='/Views/OrderList/OrderList.css']")===null){Fit.Browser.Log("Lazy loading OrderList.css");Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderList/OrderList.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"))}var tpl=new Fit.Template(true);tpl.AllowUnsafeContent(false);tpl.LoadUrl(JSShop.GetPath()+"/Views/OrderList/OrderList.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){view=sender;onComplete()});tpl.Render(dom)}function loadData(onComplete){Fit.Validation.ExpectFunction(onComplete,true);cmdUpdate.Enabled(false);var oldModels=models;models=[];process=[];var from=Fit.Date.Parse(txtFrom.Value()+" 00:00:00",lang.Locale.DateFormat+" hh:mm:ss").getTime();var to=Fit.Date.Parse(txtTo.Value()+" 23:59:59",lang.Locale.DateFormat+" hh:mm:ss").getTime();loadOrderModels(txtSearch.Value(),from,to,function(){Fit.Array.ForEach(oldModels,function(model){if(model._presenter){model._presenter.checkBox.Dispose()}});populateOrderDataToView();cmdUpdate.Enabled(true);if(onComplete){onComplete()}},function(){cmdUpdate.Enabled(true)})}function loadOrderModels(search,fromTimeStamp,toTimeStamp,onComplete,onError){Fit.Validation.ExpectString(search);Fit.Validation.ExpectInteger(fromTimeStamp);Fit.Validation.ExpectInteger(toTimeStamp);Fit.Validation.ExpectFunction(onComplete);Fit.Validation.ExpectFunction(onError);var expr=/^\$(.+?) (.+?) (.+)$/.exec(search);if(expr!==null){var field=expr[1];var operator=expr[2];if(Fit.Array.Contains(Fit.Array.GetKeys(new JSShop.Models.Order("-1").GetProperties()),field)===false){Fit.Controls.Dialog.Alert(lang.OrderList.SearchErrorField);if(Fit.Validation.IsSet(onError)===true){onError()}return}if(operator!="="&&operator!="!="&&operator!="<"&&operator!="<="&&operator!=">"&&operator!=">="&&operator.toUpperCase()!="CONTAINS"){Fit.Controls.Dialog.Alert(lang.OrderList.SearchErrorOperator);if(Fit.Validation.IsSet(onError)===true){onError()}return}}JSShop.Models.Order.RetrieveAll(search,fromTimeStamp,toTimeStamp,function(req,modelInstances){models=modelInstances;onComplete()},function(){onError()})}function loadTagModels(onComplete){Fit.Validation.ExpectFunction(onComplete);JSShop.Models.Tag.RetrieveAll("Order",function(req,modelInstances){tagModels=modelInstances;onComplete()})}function populateToolbarAndColumnsToView(){view.Content.ToolbarFromDateField=txtFrom.GetDomElement();view.Content.ToolbarToDateField=txtTo.GetDomElement();view.Content.ToolbarSearchField=txtSearch.GetDomElement();view.Content.ToolbarUpdateButton=cmdUpdate.GetDomElement();view.Content.ToolbarExportButton=cmdExport.GetDomElement();view.Content.ToolbarInvoiceButton=cmdInvoice.GetDomElement();view.Content.ToolbarCaptureButton=cmdCapture&&cmdCapture.GetDomElement()||null;view.Content.ToolbarRejectButton=cmdReject&&cmdReject.GetDomElement()||null;view.Content.ToolbarConfigButton=cmdConfig&&cmdConfig.GetDomElement()||null;view.Content.HeaderSelectAll=chkSelectAll.GetDomElement();view.Content.HeaderHeaderOrderId=lang.OrderList.OrderId;view.Content.HeaderTime=lang.OrderList.Time;view.Content.HeaderCustomer=lang.OrderList.Customer;view.Content.HeaderAmount=lang.OrderList.Amount;view.Content.HeaderPaymentMethod=lang.OrderList.PaymentMethod;view.Content.HeaderState=lang.OrderList.State;view.Content.HeaderInvoiceId=lang.OrderList.InvoiceId}function populateOrderDataToView(){view.Content.Orders.Clear();var allSelected=models.length>0;Fit.Array.ForEach(models,function(model){if(!model._presenter){model._presenter={};model._presenter.checkBox=new Fit.Controls.CheckBox("JSShopOrder"+model.Id());model._presenter.checkBox.OnChange(function(sender){if(sender.Checked()===true)Fit.Array.Add(process,model);else Fit.Array.Remove(process,model);if(sender.Focused()===true)updateSelectAll()});model._presenter.lnkCustomerDetails=document.createElement("a");model._presenter.lnkCustomerDetails.href="javascript:";model._presenter.lnkCustomerDetails.onclick=function(e){var target=Fit.Events.GetTarget(e);var oc=target.onclick;target.onclick=null;displayCustomerDetails(model,function(){target.onclick=oc})};model._presenter.lnkCustomerDetails.innerHTML=model.FirstName()+" "+model.LastName();model._presenter.lnkAmountWithDetails=document.createElement("a");model._presenter.lnkAmountWithDetails.href="javascript:";model._presenter.lnkAmountWithDetails.onclick=function(e){var target=Fit.Events.GetTarget(e);var oc=target.onclick;target.onclick=null;displayOrderEntries(model,function(){target.onclick=oc})};model._presenter.lnkAmountWithDetails.innerHTML=Fit.Math.Format(model.Price()+model.Vat(),2,lang.Locale.DecimalSeparator);model._presenter.stateElement=document.createElement("a");model._presenter.stateElement.href="javascript:";model._presenter.stateElement.innerHTML=getStateTitle(model.State());model._presenter.stateElement.onclick=function(e){var target=Fit.Events.GetTarget(e);var oc=target.onclick;target.onclick=null;displayStateDialog(model,function(tagsChanged){if(tagsChanged===true){populateOrderDataToView()}else{var newAltStateText=getTagTitlesByIds(model.TagIds()!==""?model.TagIds().split(";"):[]);model._presenter.stateElement.innerHTML=newAltStateText!==""?newAltStateText:getStateTitle(model.State())}},function(){target.onclick=oc})};model._presenter.invoiceElement=document.createElement("span");model._presenter.invoiceElement.innerHTML=model.InvoiceId()}var altStateText=getTagTitlesByIds(model.TagIds()!==""?model.TagIds().split(";"):[]);model._presenter.stateElement.innerHTML=altStateText!==""?altStateText:getStateTitle(model.State());if(model._presenter.checkBox.Checked()===false){allSelected=false}var item=view.Content.Orders.AddItem();item.Select=model._presenter.checkBox.GetDomElement();item.OrderId=model.Id();item.Time=Fit.Date.Format(new Date(model.Time()),lang.Locale.DateFormat+" "+lang.Locale.TimeFormat);item.Customer=model._presenter.lnkCustomerDetails;item.Currency=model.Currency();item.Amount=model._presenter.lnkAmountWithDetails;item.PaymentMethod=model.PaymentMethod();item.State=model._presenter.stateElement;item.InvoiceId=model._presenter.invoiceElement});chkSelectAll.Checked(allSelected);view.Update()}function getStateTitle(state){Fit.Validation.ExpectStringValue(state);if(state==="Initial")return lang.OrderList.StateInitial;else if(state==="Authorized")return lang.OrderList.StateAuthorized;else if(state==="Captured")return lang.OrderList.StateCaptured;else if(state==="Canceled")return lang.OrderList.StateCanceled;return"UNKNOWN"}function getTagTitlesByIds(ids){Fit.Validation.ExpectTypeArray(ids,Fit.Validation.ExpectString);var titles=[];var existingTagsIds=[];Fit.Array.ForEach(tagModels,function(tag){Fit.Array.Add(existingTagsIds,tag.Id());if(Fit.Array.Contains(ids,tag.Id())===true){Fit.Array.Add(titles,tag.Title())}});Fit.Array.ForEach(ids,function(id){if(Fit.Array.Contains(existingTagsIds,id)===false){Fit.Array.Add(titles,lang.OrderList.UnknownTag)}});return titles.join(", ")}function processPayments(type){Fit.Validation.ExpectStringValue(type);var processing=[];var failed=[];var scheduled=0;var processed=0;Fit.Array.ForEach(process,function(model){if(model.State()==="Captured"&&type==="Capture"||model.State()==="Canceled"&&type==="Reject"){return}Fit.Array.Add(processing,model)});if(processing.length===0)return;var statusDialog=new JSShop.Presenters.StatusDialog;statusDialog.Text(lang.OrderList.Processing);statusDialog.Modal(true);statusDialog.WarnOnExit(true,lang.OrderList.NavigateAway);statusDialog.Open();var scheduled=processing.length;var execute=null;execute=function(model){Fit.Validation.ExpectInstance(model,JSShop.Models.Order);var method=type==="Capture"?model.CapturePayment:model.CancelPayment;method(function(req,m){processed++;statusDialog.Progress(Fit.Math.Round(processed/scheduled*100));model._presenter.stateElement.innerHTML=getStateTitle(model.State());if(processing.length===0){if(processed===scheduled){statusDialog.Dispose();if(failed.length===0)Fit.Controls.Dialog.Alert(lang.OrderList.DoneSuccess);else Fit.Controls.Dialog.Alert(lang.OrderList.DoneFailure+":<br><br>"+failed.join(failed.length<=10?"<br>":", "))}}else{var nextModel=processing[0];Fit.Array.Remove(processing,nextModel);execute(nextModel)}},function(req,m){Fit.Array.Add(failed,model.Id());processed++;statusDialog.Progress(Fit.Math.Round(processed/scheduled*100));if(processing.length===0){if(processed===scheduled){statusDialog.Dispose();Fit.Controls.Dialog.Alert(lang.OrderList.DoneFailure+":<br><br>"+failed.join(failed.length<=10?"<br>":", "))}}else{var nextModel=processing[0];Fit.Array.Remove(processing,nextModel);execute(nextModel)}})};var maxConcurrentRequests=3;var startProcessing=[];for(var i=0;i<maxConcurrentRequests;i++){if(i<=processing.length-1){Fit.Array.Add(startProcessing,processing[i])}}Fit.Array.ForEach(startProcessing,function(model){Fit.Array.Remove(processing,model)});Fit.Array.ForEach(startProcessing,function(model){execute(model)})}function updateSelectAll(){var allSelected=true;Fit.Array.ForEach(models,function(model){if(model._presenter.checkBox.Checked()===false){allSelected=false;return false}});chkSelectAll.Checked(allSelected)}function displayCustomerDetails(model,closedCallback){Fit.Validation.ExpectInstance(model,JSShop.Models.Order);Fit.Validation.ExpectFunction(closedCallback);var dia=new Fit.Controls.Dialog;dia.Modal(true);var cmdOk=new Fit.Controls.Button("JSShopOrderDetailsOkButton");cmdOk.Title(lang.Common.Ok);cmdOk.Type(Fit.Controls.Button.Type.Success);cmdOk.OnClick(function(sender){dia.Dispose();closedCallback()});dia.AddButton(cmdOk);if(document.querySelector("link[href*='/Views/OrderList/DialogCustomerDetails.css']")===null)Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderList/DialogCustomerDetails.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"));var tpl=new Fit.Template;tpl.AllowUnsafeContent(true);tpl.LoadUrl(JSShop.GetPath()+"/Views/OrderList/DialogCustomerDetails.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){tpl.Content.CustomerDetailsHeadline=lang.OrderList.CustomerDetails;tpl.Content.AlternativeAddressHeadline=lang.OrderList.AlternativeAddress;tpl.Content.CustomerMessageHeadline=lang.OrderList.Message;tpl.Content.CustomDataHeadline=lang.OrderList.CustomData;var data=["Company","FirstName","LastName","Address","ZipCode","City","Phone","Email","Message"];data=Fit.Array.Merge(data,["AltCompany","AltFirstName","AltLastName","AltAddress","AltZipCode","AltCity"]);Fit.Array.ForEach(data,function(d){tpl.Content[d]=model[d]().replace(/\n/g,"<br>")});var custData="";for(var i=1;i<=3;i++){if(model["CustData"+i]()!==""){if(model["CustData"+i]()==="")continue;custData+=(custData!==""?"<br>":"")+model["CustData"+i]()}}tpl.Content.CustomData=custData;tpl.Content.AltAddressDisplay=model.AltAddress()!==""?"block":"none";tpl.Content.MessageDisplay=model.Message()!==""?"block":"none";tpl.Content.CustomDataDisplay=custData!==""?"block":"none";tpl.Render(dia.GetContentDomElement());dia.Open(me.GetDomElement().parentElement);cmdOk.Focused(true)})}function displayOrderEntries(model,closedCallback){Fit.Validation.ExpectInstance(model,JSShop.Models.Order);Fit.Validation.ExpectFunction(closedCallback);var dia=new Fit.Controls.Dialog;dia.Modal(true);dia.MaximumWidth(95,"%");var cmdOk=new Fit.Controls.Button("JSShopOrderEntriesOkButton");cmdOk.Title(lang.Common.Ok);cmdOk.Type(Fit.Controls.Button.Type.Success);cmdOk.OnClick(function(sender){dia.Dispose();closedCallback()});dia.AddButton(cmdOk);if(document.querySelector("link[href*='/Views/OrderList/DialogOrderEntries.css']")===null)Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderList/DialogOrderEntries.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"));var tpl=new Fit.Template;tpl.AllowUnsafeContent(false);tpl.LoadUrl(JSShop.GetPath()+"/Views/OrderList/DialogOrderEntries.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){tpl.Content.HeaderProduct=lang.OrderList.Product;tpl.Content.HeaderUnitPrice=lang.OrderList.UnitPrice;tpl.Content.HeaderUnits=lang.OrderList.Units;tpl.Content.HeaderPrice=lang.OrderList.Price;tpl.Content.HeaderTotalVat=lang.OrderList.TotalVat;tpl.Content.HeaderTotalPrice=lang.OrderList.TotalPrice;var populateEntries=function(entryModels){var item=null;Fit.Array.ForEach(entryModels,function(entry){var pricing=JSShop.CalculatePricing(entry.UnitPrice(),entry.Units(),entry.Vat(),entry.Discount());item=tpl.Content.OrderEntries.AddItem();item.Title=entry.Product!==null?entry.Product.Title():entry.ProductId();item.UnitPrice=Fit.Math.Format(pricing.UnitPriceInclVat,2,lang.Locale.DecimalSeparator);item.DiscountMessage=entry.DiscountMessage();item.Discount=pricing.DiscountInclVat>0||pricing.DiscountInclVat<0?Fit.Math.Format(pricing.DiscountInclVat*-1,2,lang.Locale.DecimalSeparator):"";item.Units=entry.Units();item.Currency=entry.Currency();item.Price=Fit.Math.Format(pricing.TotalInclVat,2,lang.Locale.DecimalSeparator)});for(var i=1;i<=3;i++){if(model["CostCorrection"+i]()>0||model["CostCorrection"+i]()<0){item=tpl.Content.OrderEntries.AddItem();item.Title=model["CostCorrectionMessage"+i]();item.UnitPrice="";item.DiscountMessage="";item.Discount="";item.Units="";item.Currency=model.Currency();item.Price=Fit.Math.Format(model["CostCorrection"+i]()+model["CostCorrectionVat"+i](),2,lang.Locale.DecimalSeparator)}}tpl.Content.Currency=model.Currency();tpl.Content.TotalVat=Fit.Math.Format(model.Vat(),2,lang.Locale.DecimalSeparator);tpl.Content.TotalPrice=Fit.Math.Format(model.Price()+model.Vat(),2,lang.Locale.DecimalSeparator);tpl.Render(dia.GetContentDomElement());dia.Open(me.GetDomElement().parentElement);cmdOk.Focused(true)};JSShop.Models.OrderEntry.RetrieveAll(model.Id(),function(req,entryModels){var products=0;Fit.Array.ForEach(entryModels,function(entry){var p=new JSShop.Models.Product(entry.ProductId());p.Retrieve(function(req,product){products++;entry.Product=p;if(products===entryModels.length)populateEntries(entryModels)},function(req,product){products++;entry.Product=null;if(products===entryModels.length)populateEntries(entryModels)})})})})}function displayStateDialog(model,updateStateCallback,closedCallback){Fit.Validation.ExpectInstance(model,JSShop.Models.Order);Fit.Validation.ExpectFunction(updateStateCallback);Fit.Validation.ExpectFunction(closedCallback);var dia=new Fit.Controls.Dialog;dia.Modal(true);dia.MinimumHeight(22,"em");var tagsCreated={};var tagsChanged=false;var treeview=new Fit.Controls.TreeView("JSShopStateDialogTreeViewPicker");var dropdown=new Fit.Controls.DropDown("JSShopStateDialogDropDown");dropdown.Width(100,"%");dropdown.DropDownMaxHeight(10,"em");dropdown.MultiSelectionMode(true);dropdown.SetPicker(treeview);dropdown.InputEnabled(true);dropdown.OnInputChanged(function(sender,value){dropdown.CloseDropDown()});dropdown.OnBlur(function(sender){var text=dropdown.GetInputValue();if(text!==""){var existing=null;Fit.Array.ForEach(treeview.GetChildren(),function(node){if(node.Title().toLowerCase()===text.toLowerCase()){existing=node;return false}});if(existing===null){var id=Fit.Data.CreateGuid();dropdown.AddSelection(text,id);tagsCreated[id]={Id:id,Title:text,Type:"Order"}}else{dropdown.AddSelection(existing.Title(),existing.Value())}}});var ctx=new Fit.Controls.ContextMenu;treeview.OnContextMenu(function(sender,node){ctx.RemoveAllChildren(true);ctx.AddChild(new Fit.Controls.ContextMenuItem("<span style='display: inline-block; width: 1.1em;' class='fa fa-edit'></span> Rename","Rename;"+node.Title()+";"+node.Value()));ctx.AddChild(new Fit.Controls.ContextMenuItem("<span style='display: inline-block; width: 1.1em; color: red;' class='fa fa-remove'></span> Delete","Delete;"+node.Title()+";"+node.Value()));ctx.Show()});ctx.OnSelect(function(sender,item){ctx.Hide();var info=item.Value().split(";");if(info[0]==="Delete"){Fit.Controls.Dialog.Confirm(lang.OrderList.DeleteTagWarning.replace("{0}",info[1]),function(res){if(res===false)return;tagsChanged=true;Fit.Array.ForEach(tagModels,function(tagModel){if(info[2]===tagModel.Id()){tagModel.Delete(function(){dropdown.RemoveSelection(info[2]);treeview.RemoveChild(treeview.GetChild(info[2]));Fit.Array.Remove(tagModels,tagModel)});return false}});if(tagsCreated[info[2]]){delete tagsCreated[info[2]]}})}else if(info[0]==="Rename"){Fit.Controls.Dialog.Prompt(lang.OrderList.RenameTag.replace("{0}",info[1]),info[1],function(newTitle){if(newTitle===null||newTitle===""||newTitle===info[1]){return}tagsChanged=true;Fit.Array.ForEach(tagModels,function(tagModel){if(info[2]===tagModel.Id()){tagModel.Title(newTitle);tagModel.Update(function(){if(dropdown.GetSelectionByValue(info[2])!==null){dropdown.RemoveSelection(info[2]);dropdown.AddSelection(tagModel.Title(),tagModel.Id())}treeview.GetChild(info[2]).Title(newTitle)});return false}});if(tagsCreated[info[2]]){tagsCreated[info[2]].Title=newTitle}})}});treeview.Width(100,"%");treeview.ContextMenu(ctx);treeview.Selectable(true,dropdown.MultiSelectionMode());var selected=model.TagIds()!==""?model.TagIds().split(";"):[];Fit.Array.ForEach(tagModels,function(tag){var node=new Fit.Controls.TreeViewNode(tag.Title(),tag.Id());treeview.AddChild(node);if(Fit.Array.Contains(selected,tag.Id())===true){dropdown.AddSelection(tag.Title(),tag.Id())}});Fit.Array.ForEach(selected,function(tagId){if(treeview.GetChild(tagId)===null){dropdown.AddSelection(lang.OrderList.UnknownTag,tagId)}});var disposeControls=function(){dia.Dispose();dropdown.Dispose();closedCallback()};var cmdOk=new Fit.Controls.Button("JSShopStateDialogOkButton");cmdOk.Title(lang.Common.Ok);cmdOk.Type(Fit.Controls.Button.Type.Success);cmdOk.OnClick(function(sender){var updateOrder=function(tags){cmdOk.Enabled(false);model.TagIds(tags.join(";"));model.Update(function(sender,orderModel){updateStateCallback(tagsChanged);disposeControls()})};var selections=dropdown.GetSelections();var selectedTags=[];Fit.Array.ForEach(selections,function(selection){if(tagsCreated[selection.Value]===undefined){Fit.Array.Add(selectedTags,selection.Value)}});if(Fit.Array.Count(tagsCreated)===0){updateOrder(selectedTags)}else{tagsChanged=true;Fit.Array.ForEach(tagsCreated,function(tagId){var tagInfo=tagsCreated[tagId];var tagModel=new JSShop.Models.Tag(tagInfo.Id);tagModel.Type(tagInfo.Type);tagModel.Title(tagInfo.Title);tagModel.Create(function(req,tModel){Fit.Array.Add(tagModels,tagModel);Fit.Array.Add(selectedTags,tagModel.Id());if(selections.length===selectedTags.length){updateOrder(selectedTags)}})})}});dia.AddButton(cmdOk);var cmdCancel=new Fit.Controls.Button("JSShopStateDialogCancelButton");cmdCancel.Title(lang.Common.Cancel);cmdCancel.Type(Fit.Controls.Button.Type.Danger);cmdCancel.OnClick(function(sender){disposeControls();if(tagsChanged===true){updateStateCallback(true)}});dia.AddButton(cmdCancel);if(document.querySelector("link[href*='/Views/OrderList/OrderTags.css']")===null)Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderList/OrderTags.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"));var tpl=new Fit.Template;tpl.AllowUnsafeContent(false);tpl.LoadUrl(JSShop.GetPath()+"/Views/OrderList/OrderTags.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"),function(sender,html){tpl.Content.Headline=lang.OrderList.State;tpl.Content.PaymentText=lang.OrderList.PaymentState+": ";tpl.Content.PaymentValue=getStateTitle(model.State());tpl.Content.TagText=lang.OrderList.CustomState;tpl.Content.TagValue=dropdown.GetDomElement();tpl.Render(dia.GetContentDomElement());dia.Open(me.GetDomElement().parentElement);dropdown.Focused(true)})}function exportData(){var execute=function(){var data=["Id","Time","ClientIp","Company","FirstName","LastName","Address","ZipCode","City","Email","Phone","Message","AltCompany","AltFirstName","AltLastName","AltAddress","AltZipCode","AltCity","Price","Vat","Currency","Weight","WeightUnit","CostCorrection1","CostCorrectionVat1","CostCorrectionMessage1","CostCorrection2","CostCorrectionVat2","CostCorrectionMessage2","CostCorrection3","CostCorrectionVat3","CostCorrectionMessage3","PaymentMethod","TransactionId","State","TagIds","PromoCode","CustData1","CustData2","CustData3"];var renames={TagIds:"Tags"};var items=[];Fit.Array.ForEach(process,function(model){var item=[];Fit.Array.ForEach(data,function(key){if(key==="Time"){var date=new Date(model.Time());Fit.Array.Add(item,'"'+Fit.Date.Format(date,"YYYY-MM-DD hh:mm:ss")+'"')}else if(key==="State"){Fit.Array.Add(item,'"'+getStateTitle(model.State())+'"')}else if(key==="TagIds"){Fit.Array.Add(item,'"'+getTagTitlesByIds(model.TagIds()!==""?model.TagIds().split(";"):[])+'"')}else{if(typeof model[key]()==="number")Fit.Array.Add(item,Fit.Math.Format(model[key](),4,"."));else Fit.Array.Add(item,'"'+model[key]()+'"')}});Fit.Array.Add(items,item)});var content="";Fit.Array.ForEach(data,function(key){content+=(content!==""?",":"")+'"'+(renames[key]?renames[key]:key)+'"'});Fit.Array.ForEach(items,function(item){content+="\n"+item.join(",")});if(navigator.msSaveOrOpenBlob){var blob=new Blob([content],{type:"text/csv"});navigator.msSaveOrOpenBlob(blob,"Export.csv")}else if(Fit.Browser.GetInfo().Name==="MSIE"){var ifr=document.createElement("iframe");ifr.style.display="none";document.body.appendChild(ifr);var doc=ifr.contentDocument;doc.write(content);doc.close();doc.execCommand("SaveAs",true,"Export.csv");Fit.Dom.Remove(ifr)}else{window.open(encodeURI("data:text/csv;charset=utf-8,"+content))}};execute()}function printOrders(){var execute=function(){var fontSize=12;var minorSize=10;var headerSize=14;var pdf=new jsPDF("portrait","pt","a4");pdf.setFont("helvetica","normal");pdf.setFontSize(fontSize);var first=true;var x=50;var y=0;Fit.Array.ForEach(process,function(order){if(first===false)pdf.addPage();first=false;y=50;pdf.setFontSize(headerSize);pdf.setFontStyle("bold");pdf.text(x,y,lang.OrderList.Order+" "+order.Id());pdf.setFontSize(fontSize);pdf.setFontStyle("normal");pdf.setFontSize(fontSize);pdf.text(450,y,Fit.Date.Format(new Date(order.Time()),lang.Locale.DateFormat+" "+lang.Locale.TimeFormat));pdf.setFontSize(fontSize);y+=30;var customerY=y;pdf.setFontStyle("bold");pdf.text(x,customerY+=20,lang.OrderList.CustomerDetails);pdf.setFontStyle("normal");if(order.Company()!=="")pdf.text(x,customerY+=20,order.Company());pdf.text(x,customerY+=20,order.FirstName()+" "+order.LastName());pdf.text(x,customerY+=20,order.Address());pdf.text(x,customerY+=20,order.ZipCode()+" "+order.City());if(order.Phone()!=="")pdf.text(x,customerY+=20,order.Phone());pdf.text(x,customerY+=20,order.Email());var deliveryY=y;pdf.setFontStyle("bold");pdf.text(x+250,deliveryY+=20,lang.OrderList.AlternativeAddress);pdf.setFontStyle("normal");if(order.AltCompany()!=="")pdf.text(x+250,deliveryY+=20,order.AltCompany());pdf.text(x+250,deliveryY+=20,order.AltFirstName()+" "+order.AltLastName());pdf.text(x+250,deliveryY+=20,order.AltAddress());pdf.text(x+250,deliveryY+=20,order.AltZipCode()+" "+order.AltCity());y=customerY>deliveryY?customerY:deliveryY;y+=50;pdf.setFontStyle("bold");pdf.text(x,y,lang.OrderList.Order);pdf.setFontStyle("normal");y+=20;pdf.text(x,y,lang.OrderList.Product);pdf.text(x+250,y,lang.OrderList.UnitPrice);pdf.text(x+350,y,lang.OrderList.Units);pdf.text(x+400,y,lang.OrderList.Price);Fit.Array.ForEach(order._presenter.Entries,function(entry){y+=20;var pricing=JSShop.CalculatePricing(entry.UnitPrice(),entry.Units(),entry.Vat(),entry.Discount());pdf.text(x,y,entry.Product!==null?entry.Product.Title():entry.ProductId());pdf.text(x+250,y,Fit.Math.Format(pricing.UnitPriceInclVat,2,lang.Locale.DecimalSeparator));pdf.text(x+350,y,entry.Units().toString());pdf.text(x+400,y,Fit.Math.Format(pricing.TotalInclVat,2,lang.Locale.DecimalSeparator));if(entry.Discount()!==0){y+=14;pdf.setFontSize(minorSize);pdf.text(x,y,entry.DiscountMessage());pdf.text(x+400,y,Fit.Math.Format(pricing.DiscountInclVat*-1,2,lang.Locale.DecimalSeparator));pdf.setFontSize(fontSize)}});for(var i=1;i<=3;i++){if(order["CostCorrection"+i]()>0||order["CostCorrection"+i]()<0){y+=20;pdf.text(x,y,order["CostCorrectionMessage"+i]());pdf.text(x+400,y,Fit.Math.Format(order["CostCorrection"+i]()+order["CostCorrectionVat"+i](),2,lang.Locale.DecimalSeparator))}}y+=50;pdf.text(x+250,y,lang.OrderList.TotalVat);pdf.text(x+400,y,Fit.Math.Format(order.Vat(),2,lang.Locale.DecimalSeparator));y+=20;pdf.text(x+250,y,lang.OrderList.TotalPrice);pdf.text(x+400,y,Fit.Math.Format(order.Price()+order.Vat(),2,lang.Locale.DecimalSeparator));if(order.PromoCode()!==""||order.CustData1()!==""||order.CustData2()!==""||order.CustData3()!==""){y+=30;if(order.PromoCode()!=="")pdf.text(x,y+=20,order.PromoCode());if(order.CustData1()!=="")pdf.text(x,y+=20,order.CustData1());if(order.CustData2()!=="")pdf.text(x,y+=20,order.CustData2());if(order.CustData3()!=="")pdf.text(x,y+=20,order.CustData3())}if(order.Message()!==""){y+=50;pdf.setFontStyle("bold");pdf.text(x,y,lang.OrderList.Message);pdf.setFontStyle("normal");var msg=order.Message();while(msg.indexOf("\n\n")>-1)msg=msg.replace("\n\n","\n");pdf.text(x,y+=20,msg);y+=50}});pdf.save(lang.OrderList.Export+".pdf")};var loaded=-1;Fit.Loader.LoadScript(JSShop.GetPath()+"/jspdf.min.js",function(src){loaded++;if(loaded===process.length)execute()});Fit.Array.ForEach(process,function(order){if(Fit.Validation.IsSet(order._presenter.Entries)===true){loaded++;if(loaded===process.length)execute();return}JSShop.Models.OrderEntry.RetrieveAll(order.Id(),function(req,entries){var productsLoaded=0;var orderModel=order;Fit.Array.ForEach(entries,function(entry){var prod=new JSShop.Models.Product(entry.ProductId());prod.Retrieve(function(req,product){productsLoaded++;entry.Product=product;if(productsLoaded===entries.length){loaded++;orderModel._presenter.Entries=entries;if(loaded===process.length)execute()}},function(req,product){productsLoaded++;entry.Product=null;if(productsLoaded===entries.length){loaded++;model._presenter.Entries=entries;if(loaded===process.length)execute()}})})},function(req,entries){loaded++;model._presenter.Entries=null;if(loaded===process.length)execute()})})}function sendInvoices(){var processing=[];var failed=[];var scheduled=0;var processed=0;Fit.Array.ForEach(process,function(model){Fit.Array.Add(processing,model)});if(processing.length===0)return;var scheduled=processing.length;var statusDialog=new JSShop.Presenters.StatusDialog;statusDialog.Text(lang.OrderList.Processing);statusDialog.Modal(true);statusDialog.WarnOnExit(true,lang.OrderList.NavigateAway);statusDialog.Open();var execute=null;execute=function(model){Fit.Validation.ExpectInstance(model,JSShop.Models.Order);model.SendInvoice(function(req,m){processed++;statusDialog.Progress(Fit.Math.Round(processed/scheduled*100));if(processing.length===0){if(processed===scheduled){statusDialog.Dispose();if(failed.length===0)Fit.Controls.Dialog.Alert(lang.OrderList.DoneSuccess);else Fit.Controls.Dialog.Alert(lang.OrderList.DoneFailure+":<br><br>"+failed.join(failed.length<=10?"<br>":", "))}}else{var nextModel=processing[0];Fit.Array.Remove(processing,nextModel);execute(nextModel)}model.Retrieve(function(req,m){model._presenter.invoiceElement.innerHTML=model.InvoiceId()})},function(req,m){Fit.Array.Add(failed,model.Id());processed++;statusDialog.Progress(Fit.Math.Round(processed/scheduled*100));if(processing.length===0){if(processed===scheduled){statusDialog.Dispose();Fit.Controls.Dialog.Alert(lang.OrderList.DoneFailure+":<br><br>"+failed.join(failed.length<=10?"<br>":", "))}}else{var nextModel=processing[0];Fit.Array.Remove(processing,nextModel);execute(nextModel)}})};var maxConcurrentRequests=3;var startProcessing=[];for(var i=0;i<maxConcurrentRequests;i++){if(i<=processing.length-1){Fit.Array.Add(startProcessing,processing[i])}}Fit.Array.ForEach(startProcessing,function(model){Fit.Array.Remove(processing,model)});Fit.Array.ForEach(startProcessing,function(model){execute(model)})}init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.ProductForm=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var me=this;var view=null;var models={};var currentModel=null;var lstProducts=null;var lstCategories=null;var txtId=null;var txtTitle=null;var txtDescription=null;var picImages=null;var txtPrice=null;var lstCurrencies=null;var txtVat=null;var txtWeight=null;var lstWeightUnits=null;var txtDeliveryTime=null;var txtDiscountExpr=null;var txtDiscountMsg=null;var cmdSave=null;var cmdClear=null;var cmdDelete=null;var lang=JSShop.Language.Translations;var imagesRemoved=[];var imagesIgnored=[];function init(){view=document.createElement("div");if(document.querySelector("link[href*='/Views/ProductForm/ProductForm.css']")===null){console.log("Lazy loading ProductForm.css");Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/ProductForm/ProductForm.css?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"))}var req=new Fit.Http.Request(JSShop.GetPath()+"/Views/ProductForm/ProductForm.html?CacheKey="+(JSShop.Settings.CacheKey?JSShop.Settings.CacheKey:"0"));req.OnSuccess(function(sender){var htmlView=req.GetResponseText();view.innerHTML=htmlView;Fit.Dom.Add(view.querySelector("#JSShop-Products-Label"),document.createTextNode(lang.ProductForm.EditProduct));lstProducts.Render(view.querySelector("#JSShop-Products-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Category-Label"),document.createTextNode(lang.ProductForm.Category));lstCategories.Render(view.querySelector("#JSShop-Category-Control"));Fit.Dom.Add(view.querySelector("#JSShop-ProductId-Label"),document.createTextNode(lang.ProductForm.ProductId));txtId.Render(view.querySelector("#JSShop-ProductId-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Title-Label"),document.createTextNode(lang.ProductForm.Title));txtTitle.Render(view.querySelector("#JSShop-Title-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Description-Label"),document.createTextNode(lang.ProductForm.Description));txtDescription.Render(view.querySelector("#JSShop-Description-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Images-Label"),document.createTextNode(lang.ProductForm.Images));picImages.Render(view.querySelector("#JSShop-Images-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Price-Label"),document.createTextNode(lang.ProductForm.Price));txtPrice.Render(view.querySelector("#JSShop-Price-Control"));lstCurrencies.Render(view.querySelector("#JSShop-Currency-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Vat-Label"),document.createTextNode(lang.ProductForm.Vat));txtVat.Render(view.querySelector("#JSShop-Vat-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Weight-Label"),document.createTextNode(lang.ProductForm.Weight));txtWeight.Render(view.querySelector("#JSShop-Weight-Control"));lstWeightUnits.Render(view.querySelector("#JSShop-WeightUnit-Control"));Fit.Dom.Add(view.querySelector("#JSShop-DeliveryTime-Label"),document.createTextNode(lang.ProductForm.DeliveryTime));txtDeliveryTime.Render(view.querySelector("#JSShop-DeliveryTime-Control"));Fit.Dom.Add(view.querySelector("#JSShop-DiscountExpression-Label"),document.createTextNode(lang.ProductForm.DiscountExpression));txtDiscountExpr.Render(view.querySelector("#JSShop-DiscountExpression-Control"));Fit.Dom.Add(view.querySelector("#JSShop-DiscountMessage-Label"),document.createTextNode(lang.ProductForm.DiscountMessage));txtDiscountMsg.Render(view.querySelector("#JSShop-DiscountMessage-Control"));Fit.Dom.Add(view.querySelector("#JSShop-Buttons"),cmdSave.GetDomElement());Fit.Dom.Add(view.querySelector("#JSShop-Buttons"),cmdClear.GetDomElement());Fit.Dom.Add(view.querySelector("#JSShop-Buttons"),cmdDelete.GetDomElement())});req.Start();lstProducts=new Fit.Controls.DropDown("JSShopProducts");lstProducts.TreeView=new Fit.Controls.TreeView("JSShopProductsTreeView");lstProducts.TreeView.Lines(true);lstProducts.TreeView.Width(100,"%");lstProducts.ListView=new Fit.Controls.ListView;lstProducts.Width(350,"px");lstProducts.DropDownMaxWidth(180,"%");lstProducts.InputEnabled(true);lstProducts.OnInputChanged(function(sender){if(lstProducts.GetInputValue()===""){lstProducts.SetPicker(lstProducts.TreeView)}else{lstProducts.OpenDropDown();lstProducts.ListView.RemoveItems();var nodes=lstProducts.TreeView.GetAllNodes();var search=lstProducts.GetInputValue().toLowerCase();Fit.Array.ForEach(nodes,function(node){if(node.GetLevel()===0)return;if(node.Title().toLowerCase().indexOf(search)>-1||node.Value().toLowerCase()===search)lstProducts.ListView.AddItem(node.Title()+" ("+node.GetParent().Title()+")",node.Value())});lstProducts.SetPicker(lstProducts.ListView)}});lstProducts.OnChange(function(sender){lstProducts.SetPicker(lstProducts.TreeView);if(lstProducts.TreeView.Selected().length===0)bind(null);else bind(models[lstProducts.TreeView.Selected()[0].Value()])});lstProducts.SetPicker(lstProducts.TreeView);lstCategories=new Fit.Controls.DropDown("JSShopProductCategory");lstCategories.SetPicker(new Fit.Controls.ListView);lstCategories.Width(350,"px");lstCategories.DropDownMaxWidth(150,"%");lstCategories.InputEnabled(true);lstCategories.SetValidationCallback(function(val){return val.split("=")[0].length<=50},lang.Common.MaxLengthExceeded);lstCategories.Required(true);lstCategories.Scope("JSShopProductForm");lstCategories.OnBlur(function(sender){if(lstCategories.GetSelections().length>0)lstCategories.SetInputValue("");else if(lstCategories.GetInputValue()!=="")lstCategories.AddSelection(lstCategories.GetInputValue(),lstCategories.GetInputValue())});me.OnRendered(function(sender){populatePickers()});txtId=new Fit.Controls.Input("JSShopProductId");txtId.Width(350,"px");txtId.Required(true);txtId.SetValidationCallback(function(val){return val.length<=30},lang.Common.MaxLengthExceeded);txtId.Scope("JSShopProductForm");txtTitle=new Fit.Controls.Input("JSShopProductTitle");txtTitle.Width(350,"px");txtTitle.Required(true);txtTitle.SetValidationCallback(function(val){return val.length<=250},lang.Common.MaxLengthExceeded);txtTitle.Scope("JSShopProductForm");txtDescription=new Fit.Controls.Input("JSShopProductDescription");txtDescription.Width(350,"px");txtDescription.Height(80,"px");txtDescription.MultiLine(true,300);txtDescription.Maximizable(true,250);txtDescription.SetValidationCallback(function(val){return val.length<=1e3},lang.Common.MaxLengthExceeded);txtDescription.Scope("JSShopProductForm");picImages=new Fit.Controls.FilePicker("JSShopProductImages");picImages.Url(JSShop.WebService.Files.Upload);picImages.Enabled(JSShop.WebService.Files.Upload?true:false);picImages.MultiSelectionMode(true);picImages.Title(lang.ProductForm.SelectFiles);picImages.OnChange(function(sender){if(picImages.IsLegacyModeEnabled()===true)return;imagesIgnored=[];var formImages=view.querySelector(".JSShopProductFormImages");Fit.Array.ForEach(formImages.querySelectorAll("div.JSShopPreviewContainer"),function(pc){Fit.Dom.Remove(pc)});Fit.Array.ForEach(picImages.GetFiles(),function(file){if(Fit.Array.Contains(["image/png","image/jpg","image/jpeg","image/gif"],file.Type)===false)return;var previewContainer=document.createElement("div");previewContainer.className="JSShopPreviewContainer";var p=new Fit.Controls.ProgressBar("JSShopFileProgress"+file.Id);p.Title(file.Filename);p.Render(previewContainer);var preview=file.GetImagePreview();if(preview!==null){previewContainer.appendChild(createPreviewFrame(preview,function(){Fit.Array.Add(imagesIgnored,file.Filename);Fit.Dom.Remove(previewContainer)}))}formImages.appendChild(previewContainer)})});picImages.OnProgress(function(sender,file){if(picImages.IsLegacyModeEnabled()===false)Fit.Controls.Find("JSShopFileProgress"+file.Id).Progress(file.Progress)});picImages.OnCompleted(function(sender){removeImages(saveData)});txtPrice=new Fit.Controls.Input("JSShopProductPrice");txtPrice.Width(185,"px");txtPrice.Required(true);txtPrice.SetValidationCallback(function(val){return val.length<=15&&parseFloat(val)<=9999999999.9999},lang.ProductForm.NumericValueError);txtPrice.SetValidationExpression(new RegExp("^([0-9]+(\\"+lang.Locale.DecimalSeparator+"[0-9]+)?)?$"),lang.Common.InvalidValue);txtPrice.Scope("JSShopProductForm");if(JSShop.Cookies.Get("PreviousCurrency")===null){JSShop.Cookies.Set("PreviousCurrency",lang.Locale.Currency,365*24*60*60)}var currencies=null;var prevCur=JSShop.Cookies.Get("PreviousCurrency");lstCurrencies=new Fit.Controls.DropDown("JSShopProductCurrency");lstCurrencies.Width(125,"px");lstCurrencies.SetPicker(new Fit.Controls.ListView);lstCurrencies.Value(prevCur);lstCurrencies.Required(true);lstCurrencies.InputEnabled(true);lstCurrencies.OnOpen(function(sender){if(currencies===null){currencies=[];var jsonReq=new Fit.Http.JsonRequest(JSShop.GetUrl()+"/Currencies.json");jsonReq.OnSuccess(function(req){currencies=jsonReq.GetResponseJson();var input=lstCurrencies.GetInputValue().toLowerCase();Fit.Array.ForEach(currencies,function(currency){if(input===""||currency.cc.toLowerCase().indexOf(input)>-1||currency.symbol.toLowerCase().indexOf(input)>-1||currency.name.toLowerCase().indexOf(input)>-1){lstCurrencies.GetPicker().AddItem(currency.cc+" ("+currency.symbol+")",currency.cc)}})});jsonReq.Start()}});lstCurrencies.OnInputChanged(function(sender){if(currencies===null){lstCurrencies.OpenDropDown()}else{var input=lstCurrencies.GetInputValue().toLowerCase();lstCurrencies.GetPicker().RemoveItems();Fit.Array.ForEach(currencies,function(currency){if(input===""||currency.cc.toLowerCase().indexOf(input)>-1||currency.symbol.toLowerCase().indexOf(input)>-1||currency.name.toLowerCase().indexOf(input)>-1){lstCurrencies.GetPicker().AddItem(currency.cc+" ("+currency.symbol+")",currency.cc)}});if(lstCurrencies.GetInputValue()!=="")lstCurrencies.OpenDropDown()}});lstCurrencies.OnChange(function(sender){JSShop.Cookies.Set("PreviousCurrency",lstCurrencies.Value(),365*24*60*60)});txtVat=new Fit.Controls.Input("JSShopProductVat");txtVat.Width(185,"px");txtVat.SetValidationCallback(function(val){return val.length<=15&&parseFloat(val)<=9999999999.9999},lang.ProductForm.NumericValueError);txtVat.SetValidationExpression(new RegExp("^([0-9]+(\\"+lang.Locale.DecimalSeparator+"[0-9]+)?)?$"),lang.Common.InvalidValue);txtVat.Scope("JSShopProductForm");txtVat.Value(JSShop.Cookies.Get("PreviousVat")!==null?JSShop.Cookies.Get("PreviousVat"):"");txtVat.OnChange(function(sender){JSShop.Cookies.Set("PreviousVat",txtVat.Value(),365*24*60*60)});txtWeight=new Fit.Controls.Input("JSShopProductWeight");txtWeight.Width(185,"px");txtWeight.SetValidationCallback(function(val){return val.length<=15&&parseFloat(val)<=9999999999.9999},lang.ProductForm.NumericValueError);txtWeight.SetValidationExpression(new RegExp("^([0-9]+(\\"+lang.Locale.DecimalSeparator+"[0-9]+)?)?$"),lang.Common.InvalidValue);txtWeight.Scope("JSShopProductForm");if(JSShop.Cookies.Get("PreviousWeightUnit")===null){JSShop.Cookies.Set("PreviousWeightUnit",getWeightUnitControlValue(lang.Locale.WeightUnit),365*24*60*60)}JSShop.Cookies.Get("PreviousWeightUnit");lstWeightUnits=new Fit.Controls.DropDown("JSShopProductWeightUnit");lstWeightUnits.Width(125,"px");lstWeightUnits.SetPicker(new Fit.Controls.ListView);lstWeightUnits.GetPicker().AddItem(lang.ProductForm.Kilos,"kg");lstWeightUnits.GetPicker().AddItem(lang.ProductForm.Pounds,"lbs");lstWeightUnits.Value(JSShop.Cookies.Get("PreviousWeightUnit"));lstWeightUnits.Required(true);lstWeightUnits.OnChange(function(sender){JSShop.Cookies.Set("PreviousWeightUnit",lstWeightUnits.Value(),365*24*60*60)});txtDeliveryTime=new Fit.Controls.Input("JSShopProductDeliveryTime");txtDeliveryTime.Width(350,"px");txtDeliveryTime.Value(JSShop.Cookies.Get("PreviousDeliveryTime")!==null?JSShop.Cookies.Get("PreviousDeliveryTime"):"");txtDeliveryTime.SetValidationCallback(function(val){return val.length<=50},lang.Common.MaxLengthExceeded);txtDeliveryTime.Scope("JSShopProductForm");txtDeliveryTime.OnChange(function(sender){JSShop.Cookies.Set("PreviousDeliveryTime",txtDeliveryTime.Value(),365*24*60*60)});txtDiscountExpr=new Fit.Controls.Input("JSShopProductDiscountExpression");txtDiscountExpr.Width(350,"px");txtDiscountExpr.SetValidationCallback(function(val){var p=new JSShop.Models.Product("JSShopTemp"+Fit.Data.CreateGuid());p.Price(100);p.Currency("USD");p.Vat(25);p.DiscountExpression(val);try{p.CalculateDiscount(-100);p.CalculateDiscount(0);p.CalculateDiscount(100);return true}catch(err){return false}},lang.Common.InvalidValue);txtDiscountExpr.SetValidationExpression(/^(.|\n){0,250}$/,lang.Common.MaxLengthExceeded);txtDiscountExpr.Scope("JSShopProductForm");txtDiscountMsg=new Fit.Controls.Input("JSShopProductDiscountMessage");txtDiscountMsg.Width(350,"px");txtDiscountMsg.SetValidationCallback(function(val){var p=new JSShop.Models.Product("JSShopTemp"+Fit.Data.CreateGuid());p.Price(100);p.Currency("USD");p.Vat(25);p.DiscountMessage(val);try{p.CalculateDiscountMessage(-100);p.CalculateDiscountMessage(0);p.CalculateDiscountMessage(100);return true}catch(err){return false}},lang.Common.InvalidValue);txtDiscountMsg.SetValidationExpression(/^(.|\n){0,250}$/,lang.Common.MaxLengthExceeded);txtDiscountMsg.Scope("JSShopProductForm");cmdSave=new Fit.Controls.Button("JSShopSaveButton");cmdSave.Title(lang.ProductForm.Save);cmdSave.Icon("floppy-o");cmdSave.Type(Fit.Controls.Button.Type.Success);cmdSave.OnClick(function(sender){if(Fit.Controls.ValidateAll("JSShopProductForm")===false){Fit.Controls.Dialog.Alert(lang.Common.InvalidEntries);return}if(picImages.GetFiles().length>0){var invalidFiles=[];Fit.Array.ForEach(picImages.GetFiles(),function(file){if(picImages.IsLegacyModeEnabled()===false){if(Fit.Array.Contains(["image/png","image/jpg","image/jpeg","image/gif"],file.Type)===false)Fit.Array.Add(invalidFiles,file.Filename)}else{if(Fit.Array.Contains([".png",".jpg",".jpeg",".gif"],file.Filename.substring(file.Filename.lastIndexOf(".")))===false)Fit.Array.Add(invalidFiles,file.Filename)}});var skipFiles=Fit.Array.Merge(invalidFiles,imagesIgnored);if(picImages.GetFiles().length>skipFiles.length)picImages.Upload(skipFiles);else removeImages(saveData)}else{removeImages(saveData)}});cmdClear=new Fit.Controls.Button("JSShopClearButton");cmdClear.Title(lang.ProductForm.Clear);cmdClear.Icon("refresh");cmdClear.Type(Fit.Controls.Button.Type.Warning);cmdClear.OnClick(function(sender){cmdClear.Icon("fa-check");setTimeout(function(){cmdClear.Icon("refresh")},1500);lstProducts.SetInputValue("");lstProducts.Clear();bind(null)});cmdDelete=new Fit.Controls.Button("JSShopDeleteButton");cmdDelete.Title(lang.ProductForm.Delete);cmdDelete.Icon("minus-circle");cmdDelete.Type(Fit.Controls.Button.Type.Danger);cmdDelete.GetDomElement().style.display="none";cmdDelete.OnClick(function(sender){Fit.Controls.Dialog.Confirm(lang.ProductForm.DeleteWarning,function(res){if(res===false)return;imagesRemoved=currentModel.Images()!==""?currentModel.Images().split(";"):[];removeImages(function(){currentModel.Delete(function(){cmdDelete.Icon("fa-check");setTimeout(function(){cmdDelete.Icon("minus-circle")},1500);bind(null);populatePickers()})})})})}this.GetDomElement=function(){return view};function populatePickers(){lstProducts.SetInputValue("");lstProducts.Value("");lstProducts.TreeView.RemoveAllChildren(true);lstCategories.GetPicker().RemoveItems();models={};JSShop.Models.Product.RetrieveAll("",function(request,allModels){Fit.Array.ForEach(allModels,function(model){var categoryValue="CAT#"+model.Category();if(lstProducts.TreeView.GetChild(categoryValue)===null){lstProducts.TreeView.AddChild(new Fit.Controls.TreeView.Node(model.Category(),categoryValue));lstCategories.GetPicker().AddItem(model.Category(),model.Category())}var node=new Fit.Controls.TreeView.Node(model.Title(),model.Id());node.Selectable(true);lstProducts.TreeView.GetChild(categoryValue).AddChild(node);models[model.Id()]=model});if(Fit.Array.Count(models)===0){lstProducts.SetInputValue(lang.ProductForm.NoProducts);lstProducts.CloseDropDown()}})}function bind(model){Fit.Validation.ExpectInstance(model,JSShop.Models.Product,true);if(Fit.Validation.IsSet(model)===true){lstCategories.ClearInput();lstCategories.AddSelection(model.Category(),model.Category());txtId.Value(model.Id());txtTitle.Value(model.Title());txtDescription.Value(model.Description());picImages.Clear();txtPrice.Value(model.Price().toString().replace(".",lang.Locale.DecimalSeparator));lstCurrencies.Value(model.Currency());txtVat.Value(model.Vat()!==0?model.Vat().toString().replace(".",lang.Locale.DecimalSeparator):"");txtWeight.Value(model.Weight()!==0?model.Weight().toString().replace(".",lang.Locale.DecimalSeparator):"");lstWeightUnits.Value(getWeightUnitControlValue(model.WeightUnit()));txtDeliveryTime.Value(model.DeliveryTime());txtDiscountExpr.Value(model.DiscountExpression());txtDiscountMsg.Value(model.DiscountMessage());view.querySelector(".JSShopProductFormImages").innerHTML="";if(model.Images()!==""){var formImages=view.querySelector(".JSShopProductFormImages");Fit.Array.ForEach(model.Images().split(";"),function(imgSrc){var img=new Image;formImages.appendChild(createPreviewFrame(img,function(){Fit.Array.Add(imagesRemoved,imgSrc);Fit.Dom.Remove(img.parentElement)}));img.src=imgSrc})}cmdDelete.GetDomElement().style.display="";currentModel=model}else{lstCategories.ClearInput();lstCategories.ClearSelections();txtId.Value("");txtTitle.Value("");txtDescription.Value("");picImages.Clear();txtPrice.Value("");lstCurrencies.Value(JSShop.Cookies.Get("PreviousCurrency")!==null?JSShop.Cookies.Get("PreviousCurrency"):"");txtVat.Value(JSShop.Cookies.Get("PreviousVat")!==null?JSShop.Cookies.Get("PreviousVat"):"");txtWeight.Value("");lstWeightUnits.Value(JSShop.Cookies.Get("PreviousWeightUnit")!==null?JSShop.Cookies.Get("PreviousWeightUnit"):"");txtDeliveryTime.Value(JSShop.Cookies.Get("PreviousDeliveryTime")!==null?JSShop.Cookies.Get("PreviousDeliveryTime"):"");txtDiscountExpr.Value("");txtDiscountMsg.Value("");view.querySelector(".JSShopProductFormImages").innerHTML="";cmdDelete.GetDomElement().style.display="none";currentModel=null}}function saveData(){var updateExisting=currentModel!==null&&currentModel.Id()===txtId.Value();var model=updateExisting===true?currentModel:new JSShop.Models.Product(txtId.Value());if(currentModel!==null&&model!==currentModel)model.Images(currentModel.Images());var imagesStr=model.Images();var newImages=imagesStr!==""?imagesStr.split(";"):[];Fit.Array.ForEach(picImages.GetFiles(),function(file){if(file.Processed===false)return;if(file.ServerResponse===null||file.ServerResponse==="")throw"File upload did not produce a valid file reference";Fit.Array.Add(newImages,file.ServerResponse)});Fit.Array.ForEach(imagesRemoved,function(imgRemoved){Fit.Array.Remove(newImages,imgRemoved)});imagesStr="";Fit.Array.ForEach(newImages,function(img){imagesStr+=(imagesStr!==""?";":"")+img});model.Category(lstCategories.GetSelections()[0].Value);model.Id(txtId.Value());model.Title(txtTitle.Value());model.Description(txtDescription.Value());model.Images(imagesStr);model.Price(parseFloat(txtPrice.Value().replace(lang.Locale.DecimalSeparator,".")));model.Currency(lstCurrencies.GetSelections()[0].Value);model.Vat(txtVat.Value()!==""?parseFloat(txtVat.Value().replace(lang.Locale.DecimalSeparator,".")):0);model.Weight(txtWeight.Value()!==""?parseFloat(txtWeight.Value().replace(lang.Locale.DecimalSeparator,".")):0);model.WeightUnit(lstWeightUnits.GetSelections()[0].Value);model.DeliveryTime(txtDeliveryTime.Value());model.DiscountExpression(txtDiscountExpr.Value());model.DiscountMessage(txtDiscountMsg.Value());var cb=function(){var cbUpdateUi=function(){cmdSave.Icon("fa-check");setTimeout(function(){cmdSave.Icon("floppy-o")},1500);bind(null);populatePickers()};if(currentModel!==null&&model!==currentModel)currentModel.Delete(cbUpdateUi);else cbUpdateUi()};if(updateExisting===true)model.Update(cb);else model.Create(cb)}function removeImages(cb){Fit.Validation.ExpectFunction(cb);if(imagesRemoved.length===0){cb();return}var req=new Fit.Http.Request(JSShop.WebService.Files.Remove);req.SetData("Files="+imagesRemoved.join(";"));req.OnSuccess(function(sender){cb()});req.OnFailure(function(sender){Fit.Controls.Dialog.Alert(lang.ProductForm.ImagesNotRemoved);cb()});req.Start()}function createPreviewFrame(preview,deleteCallback){Fit.Validation.ExpectInstance(preview,Image);Fit.Validation.ExpectFunction(deleteCallback);var previewFrame=document.createElement("div");previewFrame.className="JSShopFilePreview";var cmdDelete=document.createElement("span");cmdDelete.className="fa fa-remove";cmdDelete.onclick=function(e){if(JSShop.WebService.Files.Remove)deleteCallback()};cmdDelete.style.cssText=!JSShop.WebService.Files.Remove?"opacity: 0.5; cursor: not-allowed;":"";previewFrame.appendChild(cmdDelete);preview.onload=function(e){var frameDim=Fit.Dom.GetInnerDimensions(preview.parentElement);if(preview.width/2>preview.height){preview.style.height="100%";preview.style.width="auto";preview.style.marginLeft="-"+(preview.offsetWidth-frameDim.X)/2+"px"}else if(preview.width/2<preview.height){preview.style.width="100%";preview.style.height="auto";preview.style.marginTop="-"+(preview.offsetHeight-frameDim.Y)/2+"px"}else{preview.style.width="100%";preview.style.height="100%"}};previewFrame.appendChild(preview);return previewFrame}function getWeightUnitControlValue(unit){Fit.Validation.ExpectString(unit);if(unit==="lbs")return lang.ProductForm.Pounds+"=lbs";return lang.ProductForm.Kilos+"=kg"}init()};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.ProductList={};JSShop.Presenters.ProductList.Initialize=function(productList){Fit.Validation.ExpectDomElement(productList);var lang=JSShop.Language.Translations;var buyButtons=document.querySelectorAll(".JSShopBuyButton");Fit.Array.ForEach(buyButtons,function(button){var productId=Fit.Dom.Data(button,"ProductId");if(productId===null){console.log("Unable to create Buy Button - data-ProductId attribute must be set");return}var units="1";var i=new Fit.Controls.Input("JSShopUnits"+Fit.Data.CreateGuid());i.Width(2.5,"em");i.Height(2,"em");i.Value(units);i.OnChange(function(sender){if(i.Value()!==""&&(isNaN(parseInt(i.Value()))===true||parseInt(i.Value()).toString()!==i.Value()||parseInt(i.Value())<1||parseInt(i.Value())>999999)){i.Value(units);return}units=i.Value()});i.OnBlur(function(sender){if(i.Value()==="")i.Value("1")});var b=new Fit.Controls.Button("JSShopBuyButton"+Fit.Data.CreateGuid());b.Height(2,"em");b.Title(button.innerHTML);b.Type(Fit.Controls.Button.Type.Primary);b.Icon("shopping-cart");b.OnClick(function(){b.Enabled(false);var p=new JSShop.Models.Product(productId);p.Retrieve(function(){JSShop.Models.Basket.Add(p.Id(),parseInt(i.Value()));var dialog=new Fit.Controls.Dialog;dialog.Modal(true);dialog.Content("<b>"+lang.ProductList.ProductAdded+"</b><br><br>"+i.Value()+" x "+p.Title());if(JSShop.Settings.BasketUrl){var cmdOpenBasket=new Fit.Controls.Button("JSShopBasketButton"+Fit.Data.CreateGuid());cmdOpenBasket.Type(Fit.Controls.Button.Type.Default);cmdOpenBasket.Icon("shopping-basket");cmdOpenBasket.Title(lang.ProductList.OpenBasket);cmdOpenBasket.OnClick(function(sender){dialog.Close();b.Enabled(true);location.href=JSShop.Settings.BasketUrl});dialog.AddButton(cmdOpenBasket)}var cmdContinue=new Fit.Controls.Button("JSShopContinueButton"+Fit.Data.CreateGuid());cmdContinue.Type(Fit.Controls.Button.Type.Default);cmdContinue.Icon("shopping-cart");cmdContinue.Title(lang.ProductList.ContinueShopping);cmdContinue.OnClick(function(sender){dialog.Close();b.Enabled(true)});dialog.AddButton(cmdContinue);dialog.Open();cmdContinue.Focused(true)},function(){alert(lang.ProductList.ErrorNotFound+": "+productId);b.Enabled(true)})});var container=document.createElement("span");b.GetDomElement().style.verticalAlign="top";i.GetDomElement().style.verticalAlign="top";i.GetDomElement().style.marginLeft="0.3em";Fit.Dom.Add(container,b.GetDomElement());Fit.Dom.Add(container,i.GetDomElement());button.innerHTML="";Fit.Dom.Add(button,container)});var buttons=document.querySelectorAll(".JSShopInfoButton");Fit.Array.ForEach(buttons,function(btn){var b=new Fit.Controls.Button("SMShopButton"+Fit.Data.CreateGuid());b.Height(2,"em");b.Title(btn.innerHTML);b.Type(Fit.Controls.Button.Type.Info);btn.innerHTML="";Fit.Dom.Add(btn,b.GetDomElement())});var elements=document.querySelectorAll(".JSShopLocalizedNumber");Fit.Array.ForEach(elements,function(elm){var val=elm.innerHTML;var isNumber=/^\-?([0-9]+(\.[0-9]+)?)$/.test(val);if(isNumber===false)return;elm.innerHTML=val.replace(".",lang.Locale.DecimalSeparator)})};if(!window.JSShop)Fit.Validation.ThrowError("JSShop.js must be loaded");JSShop.Presenters.StatusDialog=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var dialog=null;var textElm=null;var status=null;var warnId=-1;var isOpen=false;function init(){dialog=new Fit.Controls.Dialog;var container=dialog.GetContentDomElement();textElm=Fit.Dom.CreateElement("<span></span>");Fit.Dom.Add(container,textElm);status=new Fit.Controls.ProgressBar("JSShopStatusDialog"+Fit.Data.CreateGuid());status.Width(100,"%");Fit.Dom.Add(container,status.GetDomElement())}this.GetDomElement=function(){return dialog.GetDomElement()};this.WarnOnExit=function(newVal,msg){Fit.Validation.ExpectBoolean(newVal,true);Fit.Validation.ExpectString(msg,true);if(Fit.Validation.IsSet(newVal)===true&&warnId!==-1){Fit.Events.RemoveHandler(window,warnId);warnId=-1}if(newVal===true){warnId=Fit.Events.AddHandler(window,"beforeunload",function(e){if(isOpen===false)return;var ev=Fit.Events.GetEvent(e);ev.returnValue=msg?msg:"Are you sure?";return ev.returnValue})}return warnId!==-1};this.Text=function(newVal){Fit.Validation.ExpectString(newVal,true);return Fit.Dom.Text(textElm,newVal)};this.Progress=function(newVal){Fit.Validation.ExpectInteger(newVal,true);return status.Progress(newVal)};this.Modal=function(newVal){Fit.Validation.ExpectBoolean(newVal,true);return dialog.Modal(newVal)};this.Open=function(){isOpen=true;dialog.Open()};this.Close=function(){isOpen=false;dialog.Close()};this.Dispose=function(){dialog.Dispose();if(warnId!==-1){Fit.Events.RemoveHandler(window,warnId)}dialog=textElm=status=warnId=isOpen=null};init()};Fit._internal.Validation.DebugMode=false;