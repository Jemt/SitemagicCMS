window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.Base=function(e){Fit.Validation.ExpectStringValue(e);var t=this,o=null;function n(e,t,o){return function(n){return!0===Fit.Validation.IsSet(o)&&o(n,!0),!0===Fit.Validation.IsSet(n)&&t(n),e()}}this.InitializeModel=function(e){Fit.Validation.ExpectBoolean(e,!0),o=t.GetWebServiceUrls();var r=t.GetProperties();Fit.Array.ForEach(r,function(e){"number"==typeof r[e]?t[e]=n(function(){return t.GetProperties()[e]},function(o){t.GetProperties()[e]=o},Fit.Validation.ExpectNumber):"string"==typeof r[e]?t[e]=n(function(){return t.GetProperties()[e]},function(o){t.GetProperties()[e]=o},Fit.Validation.ExpectString):"object"==typeof r[e]&&(t[e]=n(function(){return t.GetProperties()[e]},function(o){t.GetProperties()[e]=o},null))})},this.GetModelName=function(){Fit.Validation.ThrowError("Missing implementation")},this.GetProperties=function(){Fit.Validation.ThrowError("Missing implementation")},this.GetWebServiceUrls=function(){Fit.Validation.ThrowError("Missing implementation")},this.Create=function(e,n){Fit.Validation.ExpectFunction(e,!0),Fit.Validation.ExpectFunction(n,!0),!1===Fit.Validation.IsSet(o.Create)&&Fit.Validation.ThrowError("WebService URL not configured");var r=JSShop.Models.Base.CreateRequest(t,"Create",e,n);r.SetData({Model:t.GetModelName(),Properties:Fit.Core.Clone(t.GetProperties()),Operation:"Create"}),r.Start()},this.Retrieve=function(e,n){Fit.Validation.ExpectFunction(e,!0),Fit.Validation.ExpectFunction(n,!0),!1===Fit.Validation.IsSet(o.Retrieve)&&Fit.Validation.ThrowError("WebService URL not configured");var r=JSShop.Models.Base.CreateRequest(t,"Retrieve",e,n);r.SetData({Model:t.GetModelName(),Properties:Fit.Core.Clone(t.GetProperties()),Operation:"Retrieve"}),r.Start()},this.Update=function(e,n){Fit.Validation.ExpectFunction(e,!0),Fit.Validation.ExpectFunction(n,!0),!1===Fit.Validation.IsSet(o.Update)&&Fit.Validation.ThrowError("WebService URL not configured");var r=JSShop.Models.Base.CreateRequest(t,"Update",e,n);r.SetData({Model:t.GetModelName(),Properties:Fit.Core.Clone(t.GetProperties()),Operation:"Update"}),r.Start()},this.Delete=function(e,n){Fit.Validation.ExpectFunction(e,!0),Fit.Validation.ExpectFunction(n,!0),!1===Fit.Validation.IsSet(o.Delete)&&Fit.Validation.ThrowError("WebService URL not configured");var r=JSShop.Models.Base.CreateRequest(t,"Delete",e,n);r.SetData({Model:t.GetModelName(),Properties:Fit.Core.Clone(t.GetProperties()),Operation:"Delete"}),r.Start()},this.toString=function(){return"JSShop.Models."+t.GetModelName()+" = "+JSON.stringify(t.GetProperties())}},JSShop.Models.Base.CreateRequest=function(e,t,o,n){Fit.Validation.ExpectInstance(e,JSShop.Models.Base),Fit.Validation.ExpectString(t),Fit.Validation.ExpectFunction(o,!0),Fit.Validation.ExpectFunction(n,!0);var r=new Fit.Http.JsonRequest(e.GetWebServiceUrls()[t]);return r.OnRequest(function(o){if(!0!==r.SuppressEvents)return(!0!==Fit.Validation.IsSet(JSShop.Events.OnRequest)||!1!==JSShop.Events.OnRequest(r,[e],t))&&void 0}),r.OnSuccess(function(n){if(!0!==r.SuppressEvents){var i=r.GetResponseJson();null!==i&&Fit.Array.ForEach(e.GetProperties(),function(t){null!==i[t]&&void 0!==i[t]&&e[t](i[t])}),!0===Fit.Validation.IsSet(JSShop.Events.OnSuccess)&&JSShop.Events.OnSuccess(r,[e],t),!0===Fit.Validation.IsSet(o)&&o(r,e)}}),r.OnFailure(function(o){!0!==r.SuppressEvents&&(!0===Fit.Validation.IsSet(JSShop.Events.OnError)&&JSShop.Events.OnError(r,[e],t),!0===Fit.Validation.IsSet(n)&&n(r,e))}),r},JSShop.Models.Base.RetrieveAll=function(e,t,o,n,r){Fit.Validation.ExpectFunction(e),Fit.Validation.ExpectString(t),Fit.Validation.ExpectIsSet(o),Fit.Validation.ExpectFunction(n),Fit.Validation.ExpectFunction(r,!0);var i=new e("TemplateModel"+Fit.Data.CreateGuid());!1===Fit.Validation.IsSet(i.GetWebServiceUrls().RetrieveAll)&&Fit.Validation.ThrowError("WebService URL not configured");var a=JSShop.Models.Base.CreateRequest(i,"RetrieveAll");a.SuppressEvents=!0,a.SetData({Model:i.GetModelName(),Properties:Fit.Core.Clone(i.GetProperties()),Operation:"RetrieveAll",Match:o}),a.OnRequest(function(e){if(!0===Fit.Validation.IsSet(JSShop.Events.OnRequest)&&!1===JSShop.Events.OnRequest(a,[],"RetrieveAll"))return!1}),a.OnSuccess(function(o){var r=a.GetResponseJson(),i=[];Fit.Array.ForEach(r,function(o){var n=new e(o[t]);Fit.Array.ForEach(n.GetProperties(),function(e){null!==o[e]&&void 0!==o[e]&&n[e](o[e])}),Fit.Array.Add(i,n)}),!0===Fit.Validation.IsSet(JSShop.Events.OnSuccess)&&JSShop.Events.OnSuccess(a,i,"RetrieveAll"),n(a,i)}),a.OnFailure(function(e){!0===Fit.Validation.IsSet(JSShop.Events.OnError)&&JSShop.Events.OnError(a,[],"RetrieveAll"),!0===Fit.Validation.IsSet(r)&&r(a,[])}),a.Start()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.Basket={},JSShop.Models.Basket.Add=function(e,t){if(Fit.Validation.ExpectStringValue(e),Fit.Validation.ExpectInteger(t),!(t<1)){var o=JSShop.Cookies.Get("Basket"),n=null!==o?JSON.parse(o):{Items:[]},r=!1;if(Fit.Array.ForEach(n.Items,function(o){if(o.ProductId===e)return r=!0,o.Units=o.Units+t,!1}),!1===r){var i={ProductId:e,Units:t};Fit.Array.Add(n.Items,i)}JSShop.Cookies.Set("Basket",JSON.stringify(n))}},JSShop.Models.Basket.Update=function(e,t){if(Fit.Validation.ExpectStringValue(e),Fit.Validation.ExpectInteger(t),t<1)JSShop.Models.Basket.Remove(e);else{var o=JSShop.Cookies.Get("Basket"),n=null!==o?JSON.parse(o):{Items:[]},r=!1;Fit.Array.ForEach(n.Items,function(o){if(o.ProductId===e)return r=!0,o.Units=t,!1}),!0===r?JSShop.Cookies.Set("Basket",JSON.stringify(n)):JSShop.Models.Basket.Add(e,t)}},JSShop.Models.Basket.Remove=function(e){Fit.Validation.ExpectStringValue(e);var t=JSShop.Cookies.Get("Basket"),o=null!==t?JSON.parse(t):{Items:[]},n={Items:[]};Fit.Array.ForEach(o.Items,function(t){t.ProductId!==e&&Fit.Array.Add(n.Items,t)}),JSShop.Cookies.Set("Basket",JSON.stringify(n))},JSShop.Models.Basket.GetItems=function(){var e=JSShop.Cookies.Get("Basket");return(null!==e?JSON.parse(e):{Items:[]}).Items},JSShop.Models.Basket.Clear=function(){JSShop.Cookies.Remove("Basket")},JSShop.Models.Basket.CreateOrder=function(e,t,o){Fit.Validation.ExpectInstance(e,JSShop.Models.Order),Fit.Validation.ExpectFunction(t),Fit.Validation.ExpectFunction(o,!0);var n=JSShop.Cookies.Get("Basket"),r=null!==n?JSON.parse(n):{Items:[]},i=[],a=!1;Fit.Array.ForEach(r.Items,function(n){var l=new JSShop.Models.OrderEntry(Fit.Data.CreateGuid());l.OrderId(e.Id()),l.ProductId(n.ProductId),l.Units(n.Units),l.Create(function(n,s){Fit.Array.Add(i,l),i.length===r.Items.length&&(!1===a?e.Create(function(o,n){t(e)},function(t,n){!0===Fit.Validation.IsSet(o)&&o(e)}):!0===Fit.Validation.IsSet(o)&&o(e))},function(t,n){Fit.Array.Add(i,l),a=!0,i.length===r.Items.length&&!0===Fit.Validation.IsSet(o)&&o(e)})})},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.Config=function(e){Fit.Validation.ExpectStringValue(e,!0),Fit.Core.Extend(this,JSShop.Models.Base).Apply("-1");var t=this,o={Basic:{TermsPage:"Terms.html",ReceiptPage:"Receipt.html",ShopBccEmail:"copy@domain.com"},MailTemplates:{Confirmation:"Confirmation.html",Invoice:"Invoice.html",Templates:[{Title:"Confirmation.html",Subject:"Confirmation",Content:""},{Title:"Invoice.html",Subject:"Invoice",Content:""}]},PaymentMethods:[{Module:"DIBS",Title:"Credit Card",Enabled:!0,Settings:[{Title:"Merchant ID",Value:"39461770"},{Title:"Encryption Key",Value:"JFq9w72d3kh:f-2863@s.3l:l62kjfo-oo_u623467GhS"}]}],CostCorrections:[{CostCorrection:"price * -0.10",Vat:"25",Message:"'10% Christmas discount'"},{CostCorrection:"price < 100 ? 5 : 0",Vat:"25",Message:"'Shipping fee'"},{CostCorrection:"",Vat:"",Message:""}],AdditionalData:"{}"};this.GetModelName=function(){return"Config"},this.GetProperties=function(){return o},this.GetWebServiceUrls=function(){return{Retrieve:JSShop.WebService.Configuration.Retrieve,Update:JSShop.WebService.Configuration.Update}},this.Create=function(){Fit.Validation.ThrowError("Not supported")},this.Delete=function(){Fit.Validation.ThrowError("Not supported")},t.InitializeModel()},JSShop.Models.Config.RetrieveAll=function(e,t,o){Fit.Validation.ThrowError("Not supported")},JSShop.Models.Config.Current=new JSShop.Models.Config("-1"),window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.Order=function(e){Fit.Validation.ExpectStringValue(e),Fit.Core.Extend(this,JSShop.Models.Base).Apply(e);var t=this,o={Id:e,Time:-1,ClientIp:"",Company:"",FirstName:"",LastName:"",Address:"",ZipCode:"",City:"",Email:"",Phone:"",Message:"",AltCompany:"",AltFirstName:"",AltLastName:"",AltAddress:"",AltZipCode:"",AltCity:"",Price:0,Vat:0,Currency:"",Weight:0,WeightUnit:"",CostCorrection1:0,CostCorrectionVat1:0,CostCorrectionMessage1:"",CostCorrection2:0,CostCorrectionVat2:0,CostCorrectionMessage2:"",CostCorrection3:0,CostCorrectionVat3:0,CostCorrectionMessage3:"",PaymentMethod:"",TransactionId:"",State:"",PromoCode:"",CustData1:"",CustData2:"",CustData3:"",InvoiceId:"",InvoiceTime:-1};function n(e){return JSShop.Models.Order.CalculateExpression(t.Price(),t.Vat(),t.Currency(),t.Weight(),t.WeightUnit(),""!==t.AltZipCode()?t.AltZipCode():t.ZipCode(),t.PaymentMethod(),t.PromoCode(),t.CustData1(),t.CustData2(),t.CustData3(),e,"number")}function r(e){return JSShop.Models.Order.CalculateExpression(t.Price(),t.Vat(),t.Currency(),t.Weight(),t.WeightUnit(),""!==t.AltZipCode()?t.AltZipCode():t.ZipCode(),t.PaymentMethod(),t.PromoCode(),t.CustData1(),t.CustData2(),t.CustData3(),e,"string")}this.GetModelName=function(){return"Order"},this.GetProperties=function(){return o},this.GetWebServiceUrls=function(){return{Create:JSShop.WebService.Orders.Create,Retrieve:JSShop.WebService.Orders.Retrieve,RetrieveAll:JSShop.WebService.Orders.RetrieveAll,Update:JSShop.WebService.Orders.Update,Delete:JSShop.WebService.Orders.Delete}},this.CalculateCostCorrection1=function(){return n(JSShop.Settings.CostCorrection1?JSShop.Settings.CostCorrection1:"")},this.CalculateCostCorrectionVat1=function(){return n(JSShop.Settings.CostCorrectionVat1?JSShop.Settings.CostCorrectionVat1:"")},this.CalculateCostCorrectionMessage1=function(){return r(JSShop.Settings.CostCorrectionMessage1?JSShop.Settings.CostCorrectionMessage1:"")},this.CalculateCostCorrection2=function(){return n(JSShop.Settings.CostCorrection2?JSShop.Settings.CostCorrection2:"")},this.CalculateCostCorrectionVat2=function(){return n(JSShop.Settings.CostCorrectionVat2?JSShop.Settings.CostCorrectionVat2:"")},this.CalculateCostCorrectionMessage2=function(){return r(JSShop.Settings.CostCorrectionMessage2?JSShop.Settings.CostCorrectionMessage2:"")},this.CalculateCostCorrection3=function(){return n(JSShop.Settings.CostCorrection3?JSShop.Settings.CostCorrection3:"")},this.CalculateCostCorrectionVat3=function(){return n(JSShop.Settings.CostCorrectionVat3?JSShop.Settings.CostCorrectionVat3:"")},this.CalculateCostCorrectionMessage3=function(){return r(JSShop.Settings.CostCorrectionMessage3?JSShop.Settings.CostCorrectionMessage3:"")},this.CapturePayment=function(e,o){if(Fit.Validation.ExpectFunction(e),Fit.Validation.ExpectFunction(o,!0),JSShop.Settings.PaymentCaptureUrl){var n=new Fit.Http.Request(JSShop.Settings.PaymentCaptureUrl);n.AddData("OrderId",t.Id()),n.OnSuccess(function(o){t.State("Captured"),e(n,t)}),n.OnFailure(function(e){!0===Fit.Validation.IsSet(o)&&o(n,t)}),n.Start()}else!0===Fit.Validation.IsSet(o)&&o(t)},this.CancelPayment=function(e,o){if(Fit.Validation.ExpectFunction(e),Fit.Validation.ExpectFunction(o,!0),JSShop.Settings.PaymentCancelUrl){var n=new Fit.Http.Request(JSShop.Settings.PaymentCancelUrl);n.AddData("OrderId",t.Id()),n.OnSuccess(function(o){t.State("Canceled"),e(n,t)}),n.OnFailure(function(e){!0===Fit.Validation.IsSet(o)&&o(n,t)}),n.Start()}else!0===Fit.Validation.IsSet(o)&&o(null,t)},this.SendInvoice=function(e,o){if(Fit.Validation.ExpectFunction(e),Fit.Validation.ExpectFunction(o,!0),JSShop.Settings.SendInvoiceUrl){var n=new Fit.Http.Request(JSShop.Settings.SendInvoiceUrl);n.AddData("OrderId",t.Id()),n.OnSuccess(function(o){e(n,t)}),n.OnFailure(function(e){!0===Fit.Validation.IsSet(o)&&o(n,t)}),n.Start()}else!0===Fit.Validation.IsSet(o)&&o(null,t)},t.InitializeModel()},JSShop.Models.Order.RetrieveAll=function(e,t,o,n,r){Fit.Validation.ExpectString(e),Fit.Validation.ExpectInteger(t),Fit.Validation.ExpectInteger(o),Fit.Validation.ExpectFunction(n),Fit.Validation.ExpectFunction(r,!0);var i=[];if(""!==e)Fit.Array.ForEach(["FirstName","LastName","Address","City","ZipCode","Email","Phone","Message","AltFirstName","AltLastName","AltAddress","AltCity","AltZipCode"],function(n){var r=[];Fit.Array.Add(r,{Field:"Time",Operator:">=",Value:t}),Fit.Array.Add(r,{Field:"Time",Operator:"<=",Value:o}),Fit.Array.Add(r,{Field:n,Operator:"CONTAINS",Value:e}),Fit.Array.Add(i,r)});else{var a=[];Fit.Array.Add(a,{Field:"Time",Operator:">=",Value:t}),Fit.Array.Add(a,{Field:"Time",Operator:"<=",Value:o}),Fit.Array.Add(i,a)}JSShop.Models.Base.RetrieveAll(JSShop.Models.Order,"Id",i,n,r)},JSShop.Models.Order.CalculateExpression=function(price,vat,currency,weight,weightUnit,zipCode,paymentMethod,promoCode,custData1,custData2,custData3,expression,returnType){if(Fit.Validation.ExpectNumber(price),Fit.Validation.ExpectNumber(vat),Fit.Validation.ExpectString(currency),Fit.Validation.ExpectNumber(weight),Fit.Validation.ExpectString(weightUnit),Fit.Validation.ExpectString(zipCode),Fit.Validation.ExpectString(paymentMethod),Fit.Validation.ExpectString(promoCode),Fit.Validation.ExpectString(custData1),Fit.Validation.ExpectString(custData2),Fit.Validation.ExpectString(custData3),Fit.Validation.ExpectString(expression),Fit.Validation.ExpectStringValue(returnType),""===expression){if("number"===returnType)return 0;if("string"===returnType)return"";throw"InvalidReturnType: Return type must be either 'string' or 'number'"}var ex=expression;ex=ex.replace(/\r|\n|\t/g,""),ex=ex.replace(/\/\*.*?\*\//g,""),ex=ex.replace(/price|vat|currency|weightunit|weight|zipcodeval|zipcode|paymentmethod|promocode|custdata1|custdata2|custdata3|data/g,""),ex=ex.replace(/JSShop.Floor|JSShop.Ceil|JSShop.Round/g,""),ex=ex.replace(/ |[0-9]|\*|\+|\-|\/|%|=|&|\||!|\.|:|\(|\)|\[|\]|>|<|\?|true|false/g,""),ex=ex.replace(/(["']).*?\1/g,"");var secure=""===ex;if(!1===secure)throw"InvalidExpression: Invalid and potentially insecure expression detected - evaluation aborted";var zipCodeVal=!1===isNaN(parseInt(zipCode))&&parseInt(zipCode)+""===zipCode?parseInt(zipCode):-1,expr="";expr+="var price = "+price+";",expr+="var vat = "+vat+";",expr+='var currency = "'+currency+'";',expr+="var weight = "+weight+";",expr+='var weightunit = "'+weightUnit+'";',expr+='var zipcode = "'+zipCode+'";',expr+="var zipcodeval = "+zipCodeVal+";",expr+='var paymentmethod = "'+paymentMethod+'";',expr+='var promocode = "'+promoCode+'";',expr+='var custdata1 = "'+custData1+'";',expr+='var custdata2 = "'+custData2+'";',expr+='var custdata3 = "'+custData3+'";',expr+="var data = "+(JSShop.Settings.AdditionalData?JSON.stringify(JSShop.Settings.AdditionalData):"{}")+";",expr+="("+expression.replace(/JSShop\.Floor/g,"Math.floor").replace(/JSShop\.Ceil/g,"Math.ceil").replace(/JSShop\.Round/g,"Math.round")+");";var result=eval(expr);"string"==typeof result&&(result=Fit.String.EncodeHtml(result));var isValid=!1;if("number"===returnType)isValid=/^\-?([0-9]+(\.[0-9]+)?)$/.test(result.toString()),isValid=!0===isValid&&"number"==typeof result;else{if("string"!==returnType)throw"InvalidReturnType: Return type must be either 'string' or 'number'";isValid="string"==typeof result}if(!1===isValid)throw"InvalidExpressionResult: Expression did not produce a valid value of type '"+returnType+"'";return result},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.OrderEntry=function(e){Fit.Validation.ExpectStringValue(e),Fit.Core.Extend(this,JSShop.Models.Base).Apply(e);var t=this,o={Id:e,OrderId:"",ProductId:"",UnitPrice:0,Vat:0,Currency:"",Units:0,Discount:0,DiscountMessage:""};this.GetModelName=function(){return"OrderEntry"},this.GetProperties=function(){return o},this.GetWebServiceUrls=function(){return{Create:JSShop.WebService.OrderEntries.Create,Retrieve:JSShop.WebService.OrderEntries.Retrieve,RetrieveAll:JSShop.WebService.OrderEntries.RetrieveAll,Update:JSShop.WebService.OrderEntries.Update,Delete:JSShop.WebService.OrderEntries.Delete}},t.InitializeModel()},JSShop.Models.OrderEntry.RetrieveAll=function(e,t,o){Fit.Validation.ExpectString(e),Fit.Validation.ExpectFunction(t),Fit.Validation.ExpectFunction(o,!0);var n=[[{Field:"OrderId",Operator:"=",Value:e}]];JSShop.Models.Base.RetrieveAll(JSShop.Models.OrderEntry,"Id",n,t,o)},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Models.Product=function(itemId){Fit.Validation.ExpectStringValue(itemId),Fit.Core.Extend(this,JSShop.Models.Base).Apply(itemId);var me=this,properties={Id:itemId,Category:"",Title:"",Description:"",Images:"",Price:0,Vat:0,Currency:"",Weight:0,WeightUnit:"",DeliveryTime:"",DiscountExpression:"",DiscountMessage:""};function init(){me.InitializeModel()}function calculateExpression(units,expression,returnType){if(Fit.Validation.ExpectInteger(units),Fit.Validation.ExpectString(expression),Fit.Validation.ExpectStringValue(returnType),""===expression){if("number"===returnType)return 0;if("string"===returnType)return"";throw"InvalidReturnType: Return type must be either 'string' or 'number'"}var ex=expression;ex=ex.replace(/\r|\n|\t/g,""),ex=ex.replace(/\/\*.*?\*\//g,""),ex=ex.replace(/data|units|price|vat|currency|weight|weightunit/g,""),ex=ex.replace(/JSShop.Floor|JSShop.Ceil|JSShop.Round/g,""),ex=ex.replace(/ |[0-9]|\*|\+|\-|\/|%|=|&|\||!|\.|:|\(|\)|\[|\]|>|<|\?|true|false/g,""),ex=ex.replace(/(["']).*?\1/g,"");var secure=""===ex;if(!1===secure)throw"InvalidExpression: Invalid and potentially insecure expression detected - evaluation aborted";var expr="";expr+="var units = "+units+";",expr+="var price = "+me.Price()+";",expr+="var vat = "+me.Vat()+";",expr+='var currency = "'+me.Currency()+'";',expr+='var weight = "'+me.Weight()+'";',expr+='var weightunit = "'+me.WeightUnit()+'";',expr+="var data = "+(JSShop.Settings.AdditionalData?JSON.stringify(JSShop.Settings.AdditionalData):"{}")+";",expr+="("+expression.replace(/JSShop\.Floor/g,"Math.floor").replace(/JSShop\.Ceil/g,"Math.ceil").replace(/JSShop\.Round/g,"Math.round")+");";var result=eval(expr);"string"==typeof result&&(result=Fit.String.EncodeHtml(result));var isValid=!1;if("number"===returnType)isValid=/^\-?([0-9]+(\.[0-9]+)?)$/.test(result.toString()),isValid=!0===isValid&&"number"==typeof result;else{if("string"!==returnType)throw"InvalidReturnType: Return type must be either 'string' or 'number'";isValid="string"==typeof result}if(!1===isValid)throw"InvalidExpressionResult: Expression did not produce a valid value of type '"+returnType+"'";return result}this.GetModelName=function(){return"Product"},this.GetProperties=function(){return properties},this.GetWebServiceUrls=function(){return{Create:JSShop.WebService.Products.Create,Retrieve:JSShop.WebService.Products.Retrieve,RetrieveAll:JSShop.WebService.Products.RetrieveAll,Update:JSShop.WebService.Products.Update,Delete:JSShop.WebService.Products.Delete}},this.OLDOLDOLDCalculateDiscount=function(units){Fit.Validation.ExpectInteger(units);var ex=me.DiscountExpression();if(""===ex)return 0;if(ex=ex.replace(/ |[0-9]|\*|\+|\-|\/|=|&|\||!|\.|:|\(|\)|>|<|\?|true|false/g,""),ex=ex.replace(/units|price|vat|currency|weight|weightunit/g,""),""!==ex)throw"InvalidDiscountExpression: Invalid and potentially insecure DiscountExpression detected - evaluation aborted";var expr="";expr+="var units = "+units+";",expr+="var price = "+me.Price()+";",expr+="var vat = "+me.Vat()+";",expr+='var currency = "'+me.Currency()+'";',expr+='var weight = "'+me.Weight()+'";',expr+='var weightunit = "'+me.WeightUnit()+'";',expr+="("+me.DiscountExpression()+");";var discount=eval(expr),isNumber=/^\-?([0-9]+(\.[0-9]+)?)$/.test(discount.toString());if(!1===isNumber||"number"!=typeof discount)throw"NotNumber: Discount Expression did not produce a valid value (number)";return discount},this.CalculateDiscount=function(e){return Fit.Validation.ExpectInteger(e),""===me.DiscountExpression()?0:calculateExpression(e,me.DiscountExpression(),"number")},this.CalculateDiscountMessage=function(e){return Fit.Validation.ExpectInteger(e),""===me.DiscountMessage()?"":calculateExpression(e,me.DiscountMessage(),"string")},init()},JSShop.Models.Product.RetrieveAll=function(e,t,o){Fit.Validation.ExpectString(e),Fit.Validation.ExpectFunction(t),Fit.Validation.ExpectFunction(o,!0);var n=""!==e?[[{Field:"Category",Operator:"=",Value:e}]]:[];JSShop.Models.Base.RetrieveAll(JSShop.Models.Product,"Id",n,t,o)},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.Base=function(){var e=this;this.GetDomElement=function(){throw new Error("Not implemented")},this.Render=function(t){Fit.Validation.ExpectDomElement(t),Fit.Dom.Add(t,e.GetDomElement())}},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.Basket=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var e=this,t=null,o=JSShop.Models.Basket,n=JSShop.Language.Translations.Basket,r="",i="",a="",l="",s="",c="",u=[],d=[],S={Price:-1,Vat:-1};function p(){var h=o.GetItems();if(Fit.Array.ForEach(u,function(t){t(e)}),null===document.querySelector("link[href*='/Views/Basket.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/Basket.css"),0!==h.length){var C=new Fit.Http.Request(JSShop.GetPath()+"/Views/Basket.html");C.OnSuccess(function(u){var m=C.GetResponseText();m=(m=(m=(m=(m=(m=(m=m.replace(/{\[HeaderProduct\]}/g,n.Product)).replace(/{\[HeaderUnitPrice\]}/g,n.UnitPrice)).replace(/{\[HeaderUnits\]}/g,n.Units)).replace(/{\[HeaderDiscount\]}/g,n.Discount)).replace(/{\[HeaderPrice\]}/g,n.Price)).replace(/{\[HeaderTotalVat\]}/g,n.TotalVat)).replace(/{\[HeaderTotalPrice\]}/g,n.TotalPrice);var g="\x3c!-- REPEAT Items --\x3e",F="\x3c!-- /REPEAT Items --\x3e",y=new RegExp(g+"[\\s\\S]*"+F).exec(m);if(null!==y){var J="",f=0,V=0,v=0,A=0,x=y[0],D=x.indexOf(g)+g.length,E=x.indexOf(F);x=x.substring(D,E);var P=h.length,T=null,I=!1,L=null,M=!1,w=-99999.99,O=!0;Fit.Array.ForEach(h,function(u){var C=new JSShop.Models.Product(u.ProductId);C.Retrieve(function(g,F){if(P--,u.Product=C,0===P){Fit.Array.ForEach(h,function(e){T=null!==T?T:e.Product.Currency(),e.Product.Currency()!==T&&(I=!0),L=null!==L?L:e.Product.WeightUnit(),e.Product.WeightUnit()!==L&&(M=!0);var t=x,o=Fit.Math.Round(e.Product.CalculateDiscount(e.Units),2),n=JSShop.CalculatePricing(e.Product.Price(),e.Units,e.Product.Vat(),o);t=(t=(t=(t=(t=(t=(t=t.replace(/{\[Title\]}/g,e.Product.Title())).replace(/{\[UnitPrice\]}/g,Fit.Math.Format(n.UnitPriceInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator))).replace(/{\[DiscountMessage\]}/g,n.DiscountInclVat>0?e.Product.CalculateDiscountMessage(e.Units):"")).replace(/{\[Discount\]}/g,n.DiscountInclVat>0?Fit.Math.Format(-1*n.DiscountInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator):"")).replace(/{\[Units\]}/g,"<div id='JSShopBasketItem"+e.ProductId+"'></div>")).replace(/{\[Currency\]}/g,e.Product.Currency())).replace(/{\[Price\]}/g,Fit.Math.Format(n.TotalInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator)),J+=t,f=Fit.Math.Round(f+n.TotalVat,2),V=Fit.Math.Round(V+n.TotalInclVat,2),v=Fit.Math.Round(v+n.DiscountInclVat,2),A=Fit.Math.Round(A+e.Units*e.Product.Weight(),2),-99999.99===w&&(w=n.VatFactor),w!==n.VatFactor&&(O=!1)});var D=[{Expression:JSShop.Settings.CostCorrection1?JSShop.Settings.CostCorrection1:"",Vat:JSShop.Settings.CostCorrectionVat1?JSShop.Settings.CostCorrectionVat1:"",Msg:JSShop.Settings.CostCorrectionMessage1?JSShop.Settings.CostCorrectionMessage1:"",CostCorrectionExVat:0,CostCorrectionVat:0},{Expression:JSShop.Settings.CostCorrection2?JSShop.Settings.CostCorrection2:"",Vat:JSShop.Settings.CostCorrectionVat2?JSShop.Settings.CostCorrectionVat2:"",Msg:JSShop.Settings.CostCorrectionMessage2?JSShop.Settings.CostCorrectionMessage2:"",CostCorrectionExVat:0,CostCorrectionVat:0},{Expression:JSShop.Settings.CostCorrection3?JSShop.Settings.CostCorrection3:"",Vat:JSShop.Settings.CostCorrectionVat3?JSShop.Settings.CostCorrectionVat3:"",Msg:JSShop.Settings.CostCorrectionMessage3?JSShop.Settings.CostCorrectionMessage3:"",CostCorrectionExVat:0,CostCorrectionVat:0}];Fit.Array.ForEach(D,function(e){if(e.Expression){var t=JSShop.Models.Order.CalculateExpression(V-f,f,T,A,L,r,i,a,l,s,c,e.Expression,"number"),o=0;if(t>0||t<0){var n=0;e.Vat&&(n=JSShop.Models.Order.CalculateExpression(V-f,f,T,A,L,r,i,a,l,s,c,e.Vat,"number"));var u=JSShop.CalculatePricing(t,1,n,0);t=u.TotalExclVat,o=u.TotalInclVat;var d="";e.Msg&&(d=JSShop.Models.Order.CalculateExpression(V-f,f,T,A,L,r,i,a,l,s,c,e.Msg,"string"));var S=x;S=(S=(S=(S=(S=(S=(S=S.replace(/{\[Title\]}/g,d)).replace(/{\[UnitPrice\]}/g,"&nbsp;")).replace(/{\[Discount\]}/g,"")).replace(/{\[DiscountMessage\]}/g,"")).replace(/{\[Units\]}/g,"&nbsp;")).replace(/{\[Currency\]}/g,T)).replace(/{\[Price\]}/g,Fit.Math.Format(o,2,JSShop.Language.Translations.Locale.DecimalSeparator)),J+=S,e.CostCorrectionExVat=t,e.CostCorrectionVat=o-t,w!==u.VatFactor&&(O=!1)}}}),Fit.Array.ForEach(D,function(e){f+=e.CostCorrectionVat,V+=e.CostCorrectionExVat+e.CostCorrectionVat}),!0===O&&(f=Fit.Math.Round(V-V/w,2)),S={Price:V-f,Vat:f},m=(m=(m=(m=(m=m.replace(y[0],J)).replace(/{\[Currency\]}/g,h[0].Product.Currency())).replace(/{\[TotalVat\]}/g,Fit.Math.Format(f,2,JSShop.Language.Translations.Locale.DecimalSeparator))).replace(/{\[TotalPrice\]}/g,Fit.Math.Format(V,2,JSShop.Language.Translations.Locale.DecimalSeparator))).replace(/{\[TotalDiscount\]}/g,Fit.Math.Format(v,2,JSShop.Language.Translations.Locale.DecimalSeparator)),t.innerHTML=m,Fit.Array.ForEach(h,function(e){var r=new Fit.Controls.Button(Fit.Data.CreateGuid());r.Title(e.Units.toString()),r.Type(Fit.Controls.Button.Type.Default),r.GetDomElement().style.cssText="font-size: 0.9em; padding: 2px 10px 2px 10px;",r.Width(4,"em"),r.Render(t.querySelector("#JSShopBasketItem"+e.ProductId)),r.OnClick(function(t){var r="";r+="<div style='text-align: center' id='JSShopUnitsDialogInput'>",r+="<b>"+e.Product.Title()+"</b><br><br>",r+=n.NumberOfUnits+":<br><br>",r+="</div>";var i=new Fit.Controls.Dialog;i.Modal(!0),i.Content(r);var a=e.Units.toString(),l=new Fit.Controls.Input(Fit.Data.CreateGuid());l.Width(4,"em"),l.OnChange(function(e){""!==l.Value()&&(!0===isNaN(parseInt(l.Value()))||parseInt(l.Value()).toString()!==l.Value()||parseInt(l.Value())<0||parseInt(l.Value())>999999?l.Value(a):a=l.Value())}),l.OnBlur(function(e){""===l.Value()&&l.Value("0")}),l.Render(i.GetDomElement().querySelector("#JSShopUnitsDialogInput"));var s=new Fit.Controls.Button(Fit.Data.CreateGuid());s.Title(JSShop.Language.Translations.Common.Ok),s.Type(Fit.Controls.Button.Type.Success),s.OnClick(function(t){o.Update(e.ProductId,parseInt(l.Value())),i.Close(),p()}),i.AddButton(s);var c=new Fit.Controls.Button(Fit.Data.CreateGuid());c.Title(JSShop.Language.Translations.Common.Cancel),c.Type(Fit.Controls.Button.Type.Danger),c.OnClick(function(e){i.Close()}),i.AddButton(c),Fit.Events.AddHandler(l.GetDomElement(),"keydown",function(e){13===Fit.Events.GetEvent(e).keyCode&&(""===l.Value()&&l.Value("0"),s.Click())}),Fit.Events.AddHandler(i.GetDomElement(),"keydown",function(e){27===Fit.Events.GetEvent(e).keyCode&&i.Close()}),i.Open(),l.Focused(!0)})}),!0===I&&Fit.Controls.Dialog.Alert("Error - buying products with different currencies is not supported!"),!0===M&&Fit.Controls.Dialog.Alert("Error - buying products with different weight units is not supported!"),Fit.Array.ForEach(d,function(t){t(e)})}})})}}),C.Start()}else t.innerHTML=n.BasketEmpty}function h(e){for(var t=1;t<=3;t++)if(JSShop.Settings["CostCorrection"+t]&&JSShop.Settings["CostCorrection"+t].indexOf(e)>-1||JSShop.Settings["CostCorrectionVat"+t]&&JSShop.Settings["CostCorrectionVat"+t].indexOf(e)>-1||JSShop.Settings["CostCorrectionMessage"+t]&&JSShop.Settings["CostCorrectionMessage"+t].indexOf(e)>-1)return!0;return!1}t=document.createElement("div"),this.ZipCode=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==r&&!0===h("zipcode")&&(r=e,p()),r},this.PaymentMethod=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==i&&!0===h("paymentmethod")&&(i=e,p()),i},this.PromoCode=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==a&&!0===h("promocode")&&(a=e,p()),a},this.CustData1=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==l&&!0===h("custdata1")&&(l=e,p()),l},this.CustData2=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==s&&!0===h("custdata2")&&(s=e,p()),s},this.CustData3=function(e){return Fit.Validation.ExpectString(e,!0),!0===Fit.Validation.IsSet(e)&&e!==c&&!0===h("custdata3")&&(c=e,p()),c},this.GetPricing=function(){return S},this.GetDomElement=function(){return t},this.Update=function(){!0===Fit.Dom.IsRooted(t)&&p()},this.OnUpdate=function(e){Fit.Validation.ExpectFunction(e),Fit.Array.Add(u,e)},this.OnUpdated=function(e){Fit.Validation.ExpectFunction(e),Fit.Array.Add(d,e)},p()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.Config=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var e=null,t=null,o=null,n=(JSShop.Language.Translations.Config,[]),r=null;function i(e,t){Fit.Validation.ExpectString(e),Fit.Validation.ExpectFunction(t);var o=new Fit.Controls.Button(Fit.Data.CreateGuid());return o.Title(e),o.Type(Fit.Controls.Button.Type.Default),o.OnClick(function(e){t(e)}),Fit.Array.Add(n,o),o}function a(e){d(e),t.Content.Properties.Clear(),t.Content.Headline="Basic";var n=t.Content.Properties.AddItem();n.PropertyName="Receipt",null!==JSShop.Settings.Pages&&JSShop.Settings.Pages.length>0?n.PropertyValue=u(o.Basic.ReceiptPage,JSShop.Settings.Pages,function(e,t){o.Basic.ReceiptPage=t}):n.PropertyValue=s(o.Basic.ReceiptPage,function(e,t){o.Basic.ReceiptPage=t}),(n=t.Content.Properties.AddItem()).PropertyName="Terms",null!==JSShop.Settings.Pages&&JSShop.Settings.Pages.length>0?n.PropertyValue=u(o.Basic.TermsPage,JSShop.Settings.Pages,function(e,t){o.Basic.TermsPage=t}):n.PropertyValue=s(o.Basic.TermsPage,function(e,t){o.Basic.TermsPage=t}),(n=t.Content.Properties.AddItem()).PropertyName="BCC e-mail address (receive copies of all e-mails sent)",n.PropertyValue=s(o.Basic.ShopBccEmail,function(e,t){o.Basic.ShopBccEmail=t}),t.Update()}function l(e,t,o){var n=new Fit.Controls.ContextMenu;Fit.Array.ForEach(t,function(e){n.AddChild(new Fit.Controls.ContextMenu.Item(e,e))}),n.OnSelect(function(e,t){o(t.Value()),n.Hide()});var r=e.GetDomElement(),i=Fit.Dom.GetPosition(r),a=i.X,l=i.Y+r.offsetHeight;n.Show(a,l)}function s(e,t){Fit.Validation.ExpectString(e);var o=new Fit.Controls.Input(Fit.Data.CreateGuid());return o.Value(e),o.OnChange(function(e){t(e,o.Value())}),o.Width(700),o.GetDomElement().FitControl=o,o.GetDomElement()}function c(e,t,o){var n=s(e,o);return n.FitControl.SetValidationCallback(function(e){if(""===e)return!0;try{JSShop.Models.Order.CalculateExpression(100,.1,"USD",.5,"kg","5000","DIBS","TvCampaign","A","B","C",e,t),JSShop.Models.Order.CalculateExpression(1,.25,"DKK",25,"lbs","9850","QuickPay","Spring","X","Y","Z",e,t)}catch(e){return!1}return!0},"Invalid expression"),n.FitControl.CheckSpelling(!1),n.FitControl.MultiLine(!0),n.FitControl.Height(100),n.FitControl.Maximizable(!0,300),n.FitControl.Value(e),n}function u(e,t,o){Fit.Validation.ExpectString(e),Fit.Validation.ExpectArray(t,Fit.Validation.ExpectString);var n=new Fit.Controls.DropDown(Fit.Data.CreateGuid());n.SetPicker(new Fit.Controls.ListView);var r=e;return Fit.Array.ForEach(t,function(t){Fit.Validation.ExpectString(t.Title),Fit.Validation.ExpectString(t.Value),t.Value===e&&(r=t.Title),n.GetPicker().AddItem(t.Title,t.Value)}),n.AddSelection(r,e),n.OnChange(function(e){o(e,0!==n.GetSelections().length?n.GetSelections()[0].Value:"")}),n.Width(700),n.GetDomElement().FitControl=n,n.GetDomElement()}function d(e){Fit.Validation.ExpectInstance(e,Fit.Controls.Button),Fit.Array.ForEach(n,function(e){e.Type(Fit.Controls.Button.Type.Default)}),e.Type(Fit.Controls.Button.Type.Primary),e.Focused(!1)}this.GetDomElement=function(){return e},null===document.querySelector("link[href*='/Views/Config.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/Config.css"),e=document.createElement("div"),(t=new Fit.Template(!0)).Render(e),JSShop.Models.Config.Current.Retrieve(function(e){o=JSShop.Models.Config.Current.GetProperties(),t.LoadUrl(JSShop.GetPath()+"/Views/Config.html",function(e,n){var u=i("Basic",a),S=i("E-mail templates",function(e){var n,r;n=e,r=[],Fit.Array.ForEach(o.MailTemplates.Templates,function(e){Fit.Array.Add(r,e.Title)}),l(n,r,function(e){!function(e,n){Fit.Validation.ExpectInstance(e,Fit.Controls.Button),Fit.Validation.ExpectString(n),d(e),t.Content.Properties.Clear();var r=null;Fit.Array.ForEach(o.MailTemplates.Templates,function(e){if(e.Title===n)return r=e,!1}),t.Content.Headline=r.Title;var i=t.Content.Properties.AddItem();i.PropertyName="Subject",i.PropertyValue=s(r.Subject,function(e,t){r.Subject=t});var a="\x3c!-- JSShopAutoLineBreaks --\x3e\n",l=0===r.Content.indexOf(a),c=r.Content.replace(a,"");c=!0===l?c.replace(/<br\s?\/?>/g,"\n"):c;var u=t.Content.Properties.AddItem();u.PropertyName="Content",u.PropertyValue=s("",function(e,t){r.Content=!0===l?a+t.replace(/\n/g,"<br>"):t}),u.PropertyValue.FitControl.Width(700),u.PropertyValue.FitControl.Height(250),u.PropertyValue.FitControl.MultiLine(!0),u.PropertyValue.FitControl.Maximizable(!0),u.PropertyValue.FitControl.Value(c);var S=new Fit.Controls.CheckBox(Fit.Data.CreateGuid());S.Label("Automatically turn line breaks into &lt;br&gt; HTML line breaks (default)"),S.Checked(l),S.OnChange(function(e){!0===S.Checked()?(r.Content=a+u.PropertyValue.FitControl.Value().replace(/\n/g,"<br>"),u.PropertyValue.FitControl.Value(u.PropertyValue.FitControl.Value().replace(/<br\s?\/?>/g,"\n")),l=!0):(r.Content=u.PropertyValue.FitControl.Value().replace(a,""),u.PropertyValue.FitControl.Value(u.PropertyValue.FitControl.Value().replace(/\n/g,"<br>")),l=!1)}),t.Content.Properties.AddItem().PropertyValue=S.GetDomElement(),t.Update()}(n,e)})}),p=i("Payment methods",function(e){var n,r;n=e,r=[],Fit.Array.ForEach(o.PaymentMethods,function(e){Fit.Array.Add(r,e.Module)}),l(n,r,function(e){!function(e,n){d(e),t.Content.Properties.Clear();var r=null;Fit.Array.ForEach(o.PaymentMethods,function(e){if(e.Module===n)return r=e,!1}),t.Content.Headline=r.Module;var i=new Fit.Controls.CheckBox(Fit.Data.CreateGuid());i.Label("Enable this payment module"),i.Checked(r.Enabled),i.OnChange(function(e){r.Enabled=i.Checked()});var a=t.Content.Properties.AddItem();a.PropertyName="Title",a.PropertyValue=s(r.Title,function(e,t){r.Title=t}),Fit.Array.ForEach(r.Settings,function(e){var o=t.Content.Properties.AddItem();o.PropertyName=e.Title,o.PropertyValue=s(e.Value,function(t,o){e.Value=o})});var l=t.Content.Properties.AddItem();l.PropertyName="Enabled",l.PropertyValue=i.GetDomElement(),t.Update()}(n,e)})}),h=i("Advanced",function(e){var n;l(n=e,["Choose e-mail templates","Cost correction 1","Cost correction 2","Cost correction 3","Additional data"],function(e){!function(e,n){d(e),t.Content.Properties.Clear(),t.Content.Headline=n;var r=null;if("Choose e-mail templates"===n)(r=t.Content.Properties.AddItem()).PropertyName="Confirmation E-mail template",r.PropertyValue=s(o.MailTemplates.Confirmation,function(e,t){o.MailTemplates.Confirmation=t}),(r=t.Content.Properties.AddItem()).PropertyName="Invoice E-mail template",r.PropertyValue=s(o.MailTemplates.Invoice,function(e,t){o.MailTemplates.Invoice=t});else if(0===n.indexOf("Cost correction")){var i=parseInt(n.substring(n.length-1),10)-1,a=o.CostCorrections[i];(r=t.Content.Properties.AddItem()).PropertyName="Cost expression",r.PropertyValue=c(a.CostCorrection,"number",function(e,t){a.CostCorrection=t}),(r=t.Content.Properties.AddItem()).PropertyName="VAT expression",r.PropertyValue=c(a.Vat,"number",function(e,t){a.Vat=t}),(r=t.Content.Properties.AddItem()).PropertyName="Message expression",r.PropertyValue=c(a.Message,"string",function(e,t){a.Message=t})}else"Additional data"===n&&((r=t.Content.Properties.AddItem()).PropertyName="Additional data (JSON)",r.PropertyValue=s("",function(e,t){o.AdditionalData=t}),r.PropertyValue.FitControl.MultiLine(!0),r.PropertyValue.FitControl.Maximizable(!0),r.PropertyValue.FitControl.Value(o.AdditionalData),r.PropertyValue.FitControl.SetValidationCallback(function(e){if(""===e)return!0;try{JSON.parse(e)}catch(e){return!1}return!0},"Invalid JSON"));t.Update()}(n,e)})});(r=new Fit.Controls.Button(Fit.Data.CreateGuid())).Title("Save"),r.Type(Fit.Controls.Button.Type.Success),r.OnClick(function(e){JSShop.Models.Config.Current.Update(function(e,t){Fit.Controls.Dialog.Alert("Done")})}),t.Content.SectionList.AddItem().Section=u.GetDomElement(),t.Content.SectionList.AddItem().Section=S.GetDomElement(),t.Content.SectionList.AddItem().Section=p.GetDomElement(),t.Content.SectionList.AddItem().Section=h.GetDomElement(),t.Content.SectionList.AddItem().Section=r.GetDomElement(),u.Type(Fit.Controls.Button.Type.Primary),a(u),t.Update()})}),Fit.Events.AddHandler(document,"keydown",function(e){113===Fit.Events.GetEvent(e).keyCode&&(Fit.Loader.LoadStyleSheet("https://codemirror.net/lib/codemirror.css"),Fit.Loader.LoadScripts([{source:"https://codemirror.net/lib/codemirror.js"},{source:"https://codemirror.net/mode/xml/xml.js"},{source:"https://codemirror.net/mode/javascript/javascript.js"},{source:"https://codemirror.net/addon/edit/matchbrackets.js"}],function(e){Fit.Array.ForEach(document.querySelectorAll("div.FitUiControlInput[data-multiline='true']"),function(e){var t=Fit.Controls.Find(e.id);t.Maximizable(!1),t.Height(-1);var o=CodeMirror.fromTextArea(e.querySelector("textarea"),{lineNumbers:!0,mode:"javascript",matchBrackets:!0,viewportMargin:1/0,styleActiveLine:!0});o.getWrapperElement().style.cssText+="; border: 1px solid silver; height: auto;",o.on("change",function(e,o){t.Value(e.getValue())})})}))})},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.OrderDetails=function(e){Fit.Validation.ExpectInstance(e,JSShop.Models.Order),Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var t=null,o=JSShop.Language.Translations.OrderDetails;this.GetDomElement=function(){return t},function(){t=document.createElement("div"),null===document.querySelector("link[href*='/Views/OrderDetails.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderDetails.css");var n=new Fit.Http.Request(JSShop.GetPath()+"/Views/OrderDetails.html");n.OnSuccess(function(r){var i=n.GetResponseText();i=(i=i.replace(/{\[CustomerDetailsHeadline\]}/,o.CustomerDetails)).replace(/{\[AlternativeAddressHeadline\]}/,o.AlternativeAddress);var a=["Company","FirstName","LastName","Address","ZipCode","City","Phone","Email"];a=Fit.Array.Merge(a,["AltCompany","AltFirstName","AltLastName","AltAddress","AltZipCode","AltCity"]),Fit.Array.ForEach(a,function(t){i=i.replace(new RegExp("{\\["+t+"\\]}","g"),e[t]())}),t.innerHTML=i,t.querySelector("div.JSShopAlternativeAddress").style.display=""!==e.AltAddress()?"block":"none"}),n.Start()}()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.OrderForm=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var e=null,t=JSShop.Language.Translations.OrderForm,o=null,n=null,r=null,i=null,a=null,l=null,s=null,c=null,u=null,d=null,S=null,p=null,h=null,C=null,m=null,g=null,F=null,y=null,J=null,f=null,V=null;function v(e){return Fit.Validation.ExpectString(e),JSShop.Settings.CostCorrection1&&JSShop.Settings.CostCorrection1.indexOf(e)>-1||JSShop.Settings.CostCorrection2&&JSShop.Settings.CostCorrection2.indexOf(e)>-1||JSShop.Settings.CostCorrection3&&JSShop.Settings.CostCorrection3.indexOf(e)>-1||JSShop.Settings.CostCorrectionVat1&&JSShop.Settings.CostCorrectionVat1.indexOf(e)>-1||JSShop.Settings.CostCorrectionVat2&&JSShop.Settings.CostCorrectionVat2.indexOf(e)>-1||JSShop.Settings.CostCorrectionVat3&&JSShop.Settings.CostCorrectionVat3.indexOf(e)>-1||JSShop.Settings.CostCorrectionMessage1&&JSShop.Settings.CostCorrectionMessage1.indexOf(e)>-1||JSShop.Settings.CostCorrectionMessage2&&JSShop.Settings.CostCorrectionMessage2.indexOf(e)>-1||JSShop.Settings.CostCorrectionMessage3&&JSShop.Settings.CostCorrectionMessage3.indexOf(e)>-1}function A(e){var t=e.Value(),o=Fit.String.Trim(t.replace(" "," "));o!==e.Value()&&e.Value(o)}function x(e){if(Fit.Validation.ExpectFunction(e,!0),!1===Fit.Controls.ValidateAll("JSShopOrderForm"))return Fit.Controls.Dialog.Alert(JSShop.Language.Translations.Common.InvalidEntries),void(!0===Fit.Validation.IsSet(e)&&e());if(!0===S.Checked()&&!0===(!0===(""!==p.Value()||""!==h.Value()||""!==C.Value()||""!==m.Value()||""!==g.Value()||""!==F.Value())&&(""===h.Value()||""===C.Value()||""===m.Value()||""===g.Value()||""===F.Value())))return void Fit.Controls.Dialog.Alert(t.PartialAltAddress);V.Enabled(!1);var d=new JSShop.Models.Order(Fit.Data.CreateGuid());d.Company(o.Value()),d.FirstName(n.Value()),d.LastName(r.Value()),d.Address(i.Value()),d.ZipCode(a.Value()),d.City(l.Value()),d.Email(s.Value()),d.Phone(c.Value()),d.Message(u.Value()),!0===S.Checked()&&(d.AltCompany(p.Value()),d.AltFirstName(h.Value()),d.AltLastName(C.Value()),d.AltAddress(m.Value()),d.AltZipCode(g.Value()),d.AltCity(F.Value())),null!==y&&d.PromoCode(y.Value()),null!==J&&d.PaymentMethod(J.GetSelections()[0].Value),JSShop.Models.Basket.CreateOrder(d,function(e){JSShop.Models.Basket.Clear(),JSShop.Settings.PaymentUrl?location.href=JSShop.Settings.PaymentUrl+(-1===JSShop.Settings.PaymentUrl.indexOf("?")?"?":"&")+"OrderId="+e.Id():Fit.Controls.Dialog.Alert(t.OrderReceived,function(){location.href=location.href})},function(t){!0===Fit.Validation.IsSet(e)&&e(),V.Enabled(!0)})}function D(e){!0===d.Checked()&&JSShop.Cookies.Set(e.GetId(),e.Value(),15768e4)}function E(e){!0===d.Checked()&&null!==JSShop.Cookies.Get(e.GetId())&&e.Value(JSShop.Cookies.Get(e.GetId()))}function P(e){JSShop.Cookies.Remove(e.GetId())}this.GetDomElement=function(){return e},function(){if(e=document.createElement("div"),0!==JSShop.Models.Basket.GetItems().length){null===document.querySelector("link[href*='/Views/OrderForm.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderForm.css");var T=new Fit.Http.Request(JSShop.GetPath()+"/Views/OrderForm.html");T.OnSuccess(function(v){e.innerHTML=T.GetResponseText();var A=e.querySelector("div.JSShopAddress"),x=e.querySelector("div.JSShopAlternativeAddress"),D=e.querySelector("div.JSShopPaymentForm");if(x.style.display=!0===S.Checked()?"block":"none",Fit.Dom.Add(A.querySelector("#JSShop-Headline-Label"),document.createTextNode(t.CustomerDetails)),Fit.Dom.Add(A.querySelector("#JSShop-Company-Label"),document.createTextNode(t.Company)),o.Render(A.querySelector("#JSShop-Company-Control")),Fit.Dom.Add(A.querySelector("#JSShop-FirstName-Label"),document.createTextNode(t.FirstName)),n.Render(A.querySelector("#JSShop-FirstName-Control")),Fit.Dom.Add(A.querySelector("#JSShop-LastName-Label"),document.createTextNode(t.LastName)),r.Render(A.querySelector("#JSShop-LastName-Control")),Fit.Dom.Add(A.querySelector("#JSShop-Address-Label"),document.createTextNode(t.Address)),i.Render(A.querySelector("#JSShop-Address-Control")),Fit.Dom.Add(A.querySelector("#JSShop-ZipCode-Label"),document.createTextNode(t.ZipCode)),a.Render(A.querySelector("#JSShop-ZipCode-Control")),Fit.Dom.Add(A.querySelector("#JSShop-City-Label"),document.createTextNode(t.City)),l.Render(A.querySelector("#JSShop-City-Control")),Fit.Dom.Add(A.querySelector("#JSShop-Email-Label"),document.createTextNode(t.Email)),s.Render(A.querySelector("#JSShop-Email-Control")),Fit.Dom.Add(A.querySelector("#JSShop-Phone-Label"),document.createTextNode(t.Phone)),c.Render(A.querySelector("#JSShop-Phone-Control")),Fit.Dom.Add(A.querySelector("#JSShop-Message-Label"),document.createTextNode(t.Message)),u.Render(A.querySelector("#JSShop-Message-Control")),d.Render(A.querySelector("#JSShop-RememberMe-Control")),S.Render(A.querySelector("#JSShop-AlternativeAddress-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeHeadline-Label"),document.createTextNode(t.AlternativeAddress)),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeCompany-Label"),document.createTextNode(t.Company)),p.Render(x.querySelector("#JSShop-AlternativeCompany-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeFirstName-Label"),document.createTextNode(t.FirstName)),h.Render(x.querySelector("#JSShop-AlternativeFirstName-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeLastName-Label"),document.createTextNode(t.LastName)),C.Render(x.querySelector("#JSShop-AlternativeLastName-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeAddress-Label"),document.createTextNode(t.Address)),m.Render(x.querySelector("#JSShop-AlternativeAddress-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeZipCode-Label"),document.createTextNode(t.ZipCode)),g.Render(x.querySelector("#JSShop-AlternativeZipCode-Control")),Fit.Dom.Add(x.querySelector("#JSShop-AlternativeCity-Label"),document.createTextNode(t.City)),F.Render(x.querySelector("#JSShop-AlternativeCity-Control")),null===J&&null===y||null===f?null!==J||null!==y?Fit.Dom.Add(D.querySelector("#JSShop-Header-Label"),document.createTextNode(t.Payment)):null!==f&&Fit.Dom.Add(D.querySelector("#JSShop-Header-Label"),document.createTextNode(t.Terms)):Fit.Dom.Add(D.querySelector("#JSShop-Header-Label"),document.createTextNode(t.PaymentAndTerms)),null!==y&&(Fit.Dom.Add(D.querySelector("#JSShop-PromoCode-Label"),document.createTextNode("Kampagnekode")),y.Render(D.querySelector("#JSShop-PromoCode-Control"))),null!==J&&(Fit.Dom.Add(D.querySelector("#JSShop-PaymentMethod-Label"),document.createTextNode(t.PaymentMethod)),J.Render(D.querySelector("#JSShop-PaymentMethod-Control"))),null!==f){f.Render(D.querySelector("#JSShop-AcceptTerms-Control"));var E=new Fit.Controls.Dialog;E.Modal(!0),E.Content("<iframe src='"+JSShop.Settings.TermsUrl+"' frameBorder='0' style='width: 100%; min-width: 260px; height: 100%; min-height: 260px;' allowtransparency='true'></iframe>"),E.GetDomElement().firstChild.style.padding="0em";var P=new Fit.Controls.Button("JSShopOkButton");P.Type(Fit.Controls.Button.Type.Success),P.Title(JSShop.Language.Translations.Common.Ok),P.OnClick(function(e){f.Checked(!0),E.Close()}),E.AddButton(P);var I=new Fit.Controls.Button("JSShopCancelButton");I.Type(Fit.Controls.Button.Type.Danger),I.Title(JSShop.Language.Translations.Common.Cancel),I.OnClick(function(e){f.Checked(!1),E.Close()}),E.AddButton(I);var L=Fit.Dom.CreateElement(" (<a href='javascript:'>"+t.Read+"</a>)","span");L.onclick=function(e){E.Open()},Fit.Dom.InsertAfter(f.GetDomElement(),L)}V.Render(D.querySelector("#JSShop-Continue-Control"))}),T.Start(),(o=new Fit.Controls.Input("JSShopCompany")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),o.Scope("JSShopOrderForm"),o.LazyValidation(!0),o.OnChange(D),o.OnBlur(A),o.Width(100,"%"),(n=new Fit.Controls.Input("JSShopFirstName")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),n.Required(!0),n.Scope("JSShopOrderForm"),n.LazyValidation(!0),n.OnChange(D),n.OnBlur(A),n.Width(100,"%"),(r=new Fit.Controls.Input("JSShopLastName")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),r.Required(!0),r.Scope("JSShopOrderForm"),r.LazyValidation(!0),r.OnChange(D),r.OnBlur(A),r.Width(100,"%"),(i=new Fit.Controls.Input("JSShopAddress")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),i.Required(!0),i.Scope("JSShopOrderForm"),i.LazyValidation(!0),i.OnChange(D),i.OnBlur(A),i.Width(100,"%"),(a=new Fit.Controls.Input("JSShopZipCode")).SetValidationCallback(function(e){return e.length<=20},JSShop.Language.Translations.Common.MaxLengthExceeded),a.Required(!0),a.Scope("JSShopOrderForm"),a.LazyValidation(!0),a.OnChange(D),a.OnBlur(A),a.Width(100,"%"),!0===v("zipcodeval")&&a.SetValidationExpression(/^\d*$/,t.EnterValidZipCode),(l=new Fit.Controls.Input("JSShopCity")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),l.Required(!0),l.Scope("JSShopOrderForm"),l.LazyValidation(!0),l.OnChange(D),l.OnBlur(A),l.Width(100,"%"),(s=new Fit.Controls.Input("JSShopEmail")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),s.SetValidationExpression(/^[a-z0-9!#$%&'*+-\/=?^_`{|}~]+@[a-z0-9_.-]+$/i,t.EnterValidEmail),s.Required(!0),s.Scope("JSShopOrderForm"),s.LazyValidation(!0),s.OnChange(D),s.OnBlur(A),s.Width(100,"%"),(c=new Fit.Controls.Input("JSShopPhone")).SetValidationCallback(function(e){return e.length<=20},JSShop.Language.Translations.Common.MaxLengthExceeded),c.Scope("JSShopOrderForm"),c.LazyValidation(!0),c.OnChange(D),c.OnBlur(A),c.Width(100,"%"),(u=new Fit.Controls.Input("JSShopMessage")).SetValidationCallback(function(e){return e.length<=250},JSShop.Language.Translations.Common.MaxLengthExceeded),u.Scope("JSShopOrderForm"),u.LazyValidation(!0),u.MultiLine(!0),u.Width(100,"%"),u.Height(6,"em"),u.OnBlur(A),(d=new Fit.Controls.CheckBox("JSShopRememberMe")).Label(t.RememberMe),d.Value(null!==JSShop.Cookies.Get(d.GetId())?JSShop.Cookies.Get(d.GetId()):"false"),d.OnChange(function(e){!0===d.Checked()?D(d):P(d)}),d.OnChange(function(e){var t;t=[],Fit.Array.Add(t,o),Fit.Array.Add(t,n),Fit.Array.Add(t,r),Fit.Array.Add(t,i),Fit.Array.Add(t,a),Fit.Array.Add(t,l),Fit.Array.Add(t,s),Fit.Array.Add(t,c),Fit.Array.Add(t,S),Fit.Array.Add(t,p),Fit.Array.Add(t,h),Fit.Array.Add(t,C),Fit.Array.Add(t,m),Fit.Array.Add(t,g),Fit.Array.Add(t,F),null!==J&&Fit.Array.Add(t,J),Fit.Array.ForEach(t,function(e){!0===d.Checked()?D(e):P(e)})}),(S=new Fit.Controls.CheckBox("JSShopAlternativeAddress")).Label(t.AlternativeAddress),S.OnChange(D),S.OnChange(function(e){null!==document.querySelector("div.JSShopAlternativeAddress")&&(document.querySelector("div.JSShopAlternativeAddress").style.display=!0===S.Checked()?"block":"none")}),(p=new Fit.Controls.Input("JSShopAltCompany")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),p.Scope("JSShopOrderForm"),p.LazyValidation(!0),p.OnChange(D),p.OnBlur(A),p.Width(100,"%"),(h=new Fit.Controls.Input("JSShopAltFirstName")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),h.Scope("JSShopOrderForm"),h.LazyValidation(!0),h.OnChange(D),h.OnBlur(A),h.Width(100,"%"),(C=new Fit.Controls.Input("JSShopAltLastName")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),C.Scope("JSShopOrderForm"),C.LazyValidation(!0),C.OnChange(D),C.OnBlur(A),C.Width(100,"%"),(m=new Fit.Controls.Input("JSShopAltAddress")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),m.Scope("JSShopOrderForm"),m.LazyValidation(!0),m.OnChange(D),m.OnBlur(A),m.Width(100,"%"),(g=new Fit.Controls.Input("JSShopAltZipCode")).SetValidationCallback(function(e){return e.length<=20},JSShop.Language.Translations.Common.MaxLengthExceeded),g.Scope("JSShopOrderForm"),g.LazyValidation(!0),g.OnChange(D),g.OnBlur(A),g.Width(100,"%"),!0===v("zipcodeval")&&g.SetValidationExpression(/^\d*$/,t.EnterValidZipCode),(F=new Fit.Controls.Input("JSShopAltCity")).SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),F.Scope("JSShopOrderForm"),F.LazyValidation(!0),F.OnChange(D),F.OnBlur(A),F.Width(100,"%"),!0===v("promocode")&&((y=new Fit.Controls.Input("JSShopPromoCode")).SetValidationCallback(function(e){return e.length<=30},JSShop.Language.Translations.Common.MaxLengthExceeded),y.Scope("JSShopOrderForm"),y.LazyValidation(!0),y.OnBlur(A),y.Width(100,"%")),JSShop.Settings.PaymentMethods&&JSShop.Settings.PaymentMethods.length>0&&((J=new Fit.Controls.DropDown("JSShopPaymentMethod")).Required(!0),J.Scope("JSShopOrderForm"),J.LazyValidation(!0),J.OnChange(D),J.SetPicker(new Fit.Controls.ListView),J.Width(100,"%"),Fit.Array.ForEach(JSShop.Settings.PaymentMethods,function(e){e.Title&&e.Module&&!0===e.Enabled&&J.GetPicker().AddItem(e.Title,e.Module)})),JSShop.Settings.TermsUrl&&(f=new Fit.Controls.CheckBox("JSShopAcceptTerms")).Label(t.AcceptTerms),(V=new Fit.Controls.Button("JSShopContinue")).Type(Fit.Controls.Button.Type.Primary),V.Title(t.Continue),V.OnClick(function(e){if(null===f||!1!==f.Checked()){if(""===c.Value()){var o=new Fit.Controls.Dialog;o.Modal(!0),o.Content(t.MissingPhoneNumber);var n=new Fit.Controls.Button("JSShopContinueWithoutButton"),r=new Fit.Controls.Button("JSShopGoBackButton");return n.Type(Fit.Controls.Button.Type.Default),n.Title(t.ContinueWithout),n.OnClick(function(e){o.Close(),o.Dispose(),x()}),o.AddButton(n),r.Type(Fit.Controls.Button.Type.Default),r.Title(t.AddPhoneNumber),r.OnClick(function(e){o.Close(),o.Dispose(),c.Focused(!0)}),o.AddButton(r),o.Open(),void r.Focused(!0)}x()}else Fit.Controls.Dialog.Alert(t.TermsRequired)}),E(o),E(n),E(r),E(i),E(a),E(l),E(s),E(c),E(S),E(p),E(h),E(C),E(m),E(g),E(F),null!==J&&(E(J),J.GetSelections().length>0&&!1===J.GetPicker().HasItem(J.GetSelections()[0].Value)&&J.Clear())}}()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.OrderList=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var e=null,t=[],o=JSShop.Language.Translations.OrderList,n=null,r=null,i=-1,a=[],l=null,s=null,c=null,u=null,d=null,S=null,p=null,h=null,C=null,m=null;function g(e){return Fit.Validation.ExpectStringValue(e),"Initial"===e?o.StateInitial:"Authorized"===e?o.StateAuthorized:"Captured"===e?o.StateCaptured:"Canceled"===e?o.StateCanceled:"UNKNOWN"}function F(e){Fit.Validation.ExpectStringValue(e);var t=[],n=[],r=[],i=0;if(Fit.Array.ForEach(a,function(o){"Captured"===o.State()&&"Capture"===e||"Canceled"===o.State()&&"Reject"===e?Fit.Array.Add(r,o.Id()):Fit.Array.Add(t,o)}),r.length>0&&Fit.Controls.Dialog.Alert(o.OrdersSkipped+":<br><br>"+r.join(r.length<=10?"<br>":", ")),0!==t.length){var l=t.length,s=null;s=function(r){("Capture"===e?r.CapturePayment:r.CancelPayment)(function(e,a){i++,r._internal.StateElement.innerHTML=g(r.State()),0===t.length?i===l&&(0===n.length?Fit.Controls.Dialog.Alert(o.DoneSuccess):Fit.Controls.Dialog.Alert(o.DoneFailure+":<br><br>"+n.join(n.length<=10?"<br>":", "))):(s(t[0]),Fit.Array.Remove(t,t[0]))},function(e,a){Fit.Array.Add(n,r.Id()),i++,0===t.length?i===l&&Fit.Controls.Dialog.Alert(o.DoneFailure+":<br><br>"+n.join(n.length<=10?"<br>":", ")):(s(t[0]),Fit.Array.Remove(t,t[0]))})};for(var c=[],u=0;u<3;u++)u<=t.length-1&&(s(t[u]),Fit.Array.Add(c,t[u]));Fit.Array.ForEach(c,function(e){Fit.Array.Remove(t,e)})}}function y(){var e=function(){var e=new jsPDF("portrait","pt","a4");e.setFont("helvetica","normal"),e.setFontSize(12);var t=!0,o=0;Fit.Array.ForEach(a,function(n){!1===t&&e.addPage(),t=!1,o=50,e.setFontSize(14),e.setFontStyle("bold"),e.text(50,o,"Order "+n.Id()),e.setFontSize(12),e.setFontStyle("normal"),e.setFontSize(12),e.text(450,o,Fit.Date.Format(new Date(n.Time()),"YYYY-MM-DD hh:mm:ss")),e.setFontSize(12);var r=o+=30;e.setFontStyle("bold"),e.text(50,r+=20,"Kundedetaljer"),e.setFontStyle("normal"),""!==n.Company()&&e.text(50,r+=20,n.Company()),e.text(50,r+=20,n.FirstName()+" "+n.LastName()),e.text(50,r+=20,n.Address()),e.text(50,r+=20,n.ZipCode()+" "+n.City()),""!==n.Phone()&&e.text(50,r+=20,n.Phone()),e.text(50,r+=20,n.Email());var i=o;e.setFontStyle("bold"),e.text(300,i+=20,"Alternativ leveringsadresse"),e.setFontStyle("normal"),""!==n.AltCompany()&&e.text(300,i+=20,n.AltCompany()),e.text(300,i+=20,n.AltFirstName()+" "+n.AltLastName()),e.text(300,i+=20,n.AltAddress()),e.text(300,i+=20,n.AltZipCode()+" "+n.AltCity()),o=r>i?r:i,o+=50,e.setFontStyle("bold"),e.text(50,o,"Bestilling"),e.setFontStyle("normal"),o+=20,e.text(50,o,"Title"),e.text(300,o,"Enhedspris"),e.text(400,o,"Antal"),e.text(450,o,"Pris"),Fit.Array.ForEach(n._internal.Entries,function(t){o+=20;var n=JSShop.CalculatePricing(t.UnitPrice(),t.Units(),t.Vat(),t.Discount());e.text(50,o,null!==t.Product?t.Product.Title():t.ProductId()),e.text(300,o,Fit.Math.Format(n.UnitPriceInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator)),e.text(400,o,t.Units().toString()),e.text(450,o,Fit.Math.Format(n.TotalInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator)),0!==t.Discount()&&(o+=14,e.setFontSize(10),e.text(50,o,t.DiscountMessage()),e.text(450,o,Fit.Math.Format(-1*n.DiscountInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator)),e.setFontSize(12))});for(var a=1;a<=3;a++)(n["CostCorrection"+a]()>0||n["CostCorrection"+a]()<0)&&(o+=20,e.text(50,o,n["CostCorrectionMessage"+a]()),e.text(450,o,Fit.Math.Format(n["CostCorrection"+a]()+n["CostCorrectionVat"+a](),2,JSShop.Language.Translations.Locale.DecimalSeparator)));if(o+=50,e.text(300,o,"Moms"),e.text(450,o,Fit.Math.Format(n.Vat(),2,JSShop.Language.Translations.Locale.DecimalSeparator)),o+=20,e.text(300,o,"Total inkl. moms"),e.text(450,o,Fit.Math.Format(n.Price()+n.Vat(),2,JSShop.Language.Translations.Locale.DecimalSeparator)),""===n.PromoCode()&&""===n.CustData1()&&""===n.CustData2()&&""===n.CustData3()||(o+=30,""!==n.PromoCode()&&e.text(50,o+=20,n.PromoCode()),""!==n.CustData1()&&e.text(50,o+=20,n.CustData1()),""!==n.CustData2()&&e.text(50,o+=20,n.CustData2()),""!==n.CustData3()&&e.text(50,o+=20,n.CustData3())),""!==n.Message()){o+=50,e.setFontStyle("bold"),e.text(50,o,"Besked"),e.setFontStyle("normal");for(var l=n.Message();l.indexOf("\n\n")>-1;)l=l.replace("\n\n","\n");e.text(50,o+=20,l),o+=50}}),e.save("Export.pdf")},t=-1;Fit.Loader.LoadScript(JSShop.GetPath()+"/jspdf.min.js",function(o){++t===a.length&&e()}),Fit.Array.ForEach(a,function(o){!0!==Fit.Validation.IsSet(o._internal.Entries)?JSShop.Models.OrderEntry.RetrieveAll(o.Id(),function(n,r){var i=0,l=o;Fit.Array.ForEach(r,function(o){new JSShop.Models.Product(o.ProductId()).Retrieve(function(n,s){i++,o.Product=s,i===r.length&&(t++,l._internal.Entries=r,t===a.length&&e())},function(n,l){i++,o.Product=null,i===r.length&&(t++,model._internal.Entries=r,t===a.length&&e())})})},function(o,n){t++,model._internal.Entries=null,t===a.length&&e()}):++t===a.length&&e()})}e=document.createElement("div"),this.GetDomElement=function(){return e},window.PrintOrders=y,function(){var J=function(F){Fit.Validation.ExpectFunction(F,!0),Fit.Array.ForEach(t,function(e){e._internal.CheckBox.Dispose()}),m.Checked(!1);var y=t;t=[],a=[],null===document.querySelector("link[href*='/Views/OrderList.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/OrderList.css");var J=new Fit.Http.Request(JSShop.GetPath()+"/Views/OrderList.html");J.OnSuccess(function(f){!0==(""===e.innerHTML)&&(e.innerHTML=J.GetResponseText(),s.Render(e.querySelector("#JSShopOrderListButtons")),c.Render(e.querySelector("#JSShopOrderListButtons")),l.Render(e.querySelector("#JSShopOrderListButtons")),u.Render(e.querySelector("#JSShopOrderListButtons")),d.Render(e.querySelector("#JSShopOrderListButtons")),S.Render(e.querySelector("#JSShopOrderListButtons")),p.Render(e.querySelector("#JSShopOrderListButtons")),h.Render(e.querySelector("#JSShopOrderListButtons")),null!==C&&C.Render(e.querySelector("#JSShopOrderListButtons")),Fit.Dom.Add(e.querySelector("#JSShop-Select"),m.GetDomElement()),Fit.Dom.Add(e.querySelector("#JSShop-OrderId"),document.createTextNode(o.OrderId)),Fit.Dom.Add(e.querySelector("#JSShop-Time"),document.createTextNode(o.Time)),Fit.Dom.Add(e.querySelector("#JSShop-Customer"),document.createTextNode(o.Customer)),Fit.Dom.Add(e.querySelector("#JSShop-Amount"),document.createTextNode(o.Amount)),Fit.Dom.Add(e.querySelector("#JSShop-PaymentMethod"),document.createTextNode(o.PaymentMethod)),Fit.Dom.Add(e.querySelector("#JSShop-State"),document.createTextNode(o.State)),Fit.Dom.Add(e.querySelector("#JSShop-InvoiceId"),document.createTextNode(o.InvoiceId)),n=e.querySelector("#JSShopOrderEntry"),Fit.Dom.Attribute(n,"id",null),r=n.parentElement,i=Fit.Dom.GetIndex(n),Fit.Dom.Remove(n)),Fit.Array.ForEach(y,function(e){Fit.Dom.Remove(e._internal.DomElement)});var V=Fit.Date.Parse(s.Value()+" 00:00:00",JSShop.Language.Translations.Locale.DateFormat+" hh:mm:ss").getTime(),v=Fit.Date.Parse(c.Value()+" 23:59:59",JSShop.Language.Translations.Locale.DateFormat+" hh:mm:ss").getTime();JSShop.Models.Order.RetrieveAll(l.Value(),V,v,function(e,l){t=l;var s=null;Fit.Array.ForEach(t,function(e){var l=n.outerHTML;l=(l=(l=(l=(l=(l=(l=(l=(l=l.replace(/{\[CheckBox\]}/g,"<div id='JSShopOrderCheckBox"+e.Id()+"'></div>")).replace(/{\[OrderId\]}/g,e.Id())).replace(/{\[Time\]}/g,Fit.Date.Format(new Date(e.Time()),JSShop.Language.Translations.Locale.DateFormat+" "+JSShop.Language.Translations.Locale.TimeFormat))).replace(/{\[Customer\]}/g,"<div id='JSShopCustomerDetails"+e.Id()+"'></div>")).replace(/{\[Currency\]}/g,e.Currency())).replace(/{\[Amount\]}/g,"<div id='JSShopOrderEntries"+e.Id()+"'></div>")).replace(/{\[State\]}/g,"<span id='JSShopOrderState"+e.Id()+"'></span>")).replace(/{\[InvoiceId\]}/g,"<span id='JSShopOrderInvoice"+e.Id()+"'></span>")).replace(/{\[PaymentMethod\]}/g,e.PaymentMethod());var c=Fit.Dom.CreateElement(l);null===s?Fit.Dom.InsertAt(r,i,c):Fit.Dom.InsertAfter(s,c),s=c;var u=new Fit.Controls.CheckBox("JSShopOrder"+e.Id());u.OnChange(function(o){var n;!0===u.Checked()?Fit.Array.Add(a,e):Fit.Array.Remove(a,e),!0===u.Focused()&&(n=!0,Fit.Array.ForEach(t,function(e){if("none"!==e._internal.DomElement.style.display&&!1===e._internal.CheckBox.Checked())return n=!1,!1}),m.Checked(n))}),Fit.Dom.Replace(c.querySelector("#JSShopOrderCheckBox"+e.Id()),u.GetDomElement());var d=document.createElement("a");d.href="javascript:",d.onclick=function(t){!function(e){Fit.Validation.ExpectInstance(e,JSShop.Models.Order);var t=new Fit.Controls.Dialog;t.Modal(!0),t.Content("Working on it.."),t.Open();var n=new Fit.Controls.Button("JSShopOrderDetailsOkButton");n.Title(JSShop.Language.Translations.Common.Ok),n.Type(Fit.Controls.Button.Type.Success),n.Enabled(!1),n.OnClick(function(e){t.Dispose()}),t.AddButton(n),n.Focused(!0),null===document.querySelector("link[href*='/Views/DialogCustomerDetails.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/DialogCustomerDetails.css");var r=new Fit.Http.Request(JSShop.GetPath()+"/Views/DialogCustomerDetails.html");r.OnSuccess(function(i){var a=r.GetResponseText();a=(a=(a=a.replace(/{\[CustomerDetailsHeadline\]}/,o.CustomerDetails)).replace(/{\[AlternativeAddressHeadline\]}/,o.AlternativeAddress)).replace(/{\[CustomerMessageHeadline\]}/,o.Message);var l=["Company","FirstName","LastName","Address","ZipCode","City","Phone","Email","Message"];l=Fit.Array.Merge(l,["AltCompany","AltFirstName","AltLastName","AltAddress","AltZipCode","AltCity"]),Fit.Array.ForEach(l,function(t){a=a.replace(new RegExp("{\\["+t+"\\]}","g"),e[t]().replace("\n","<br>"))}),n.Enabled(!0),t.Content(a);var s=t.GetDomElement().querySelector("#JSShopAlternativeAddress");s.style.display=""!==e.AltAddress()?"block":"none";for(var c="",u=1;u<=3;u++)""!==e["CustData"+u]()&&(c+=(""!==c?"<br>":"")+e["CustData"+u]());var d=t.GetDomElement().querySelector("#JSShopCustomerMessage");""!==c&&(d.innerHTML=d.innerHTML+"<br><br>"+c),d.style.display=""!==e.Message()||""!==c?"block":"none"}),r.Start()}(e)},d.innerHTML=e.FirstName()+" "+e.LastName(),Fit.Dom.Replace(c.querySelector("#JSShopCustomerDetails"+e.Id()),d);var S=document.createElement("a");S.href="javascript:",S.onclick=function(t){!function(e){Fit.Validation.ExpectInstance(e,JSShop.Models.Order);var t=new Fit.Controls.Dialog;t.Modal(!0),t.Content("Working on it.."),t.Open(),t.GetDomElement().style.maxWidth="95%";var n=new Fit.Controls.Button("JSShopOrderEntriesOkButton");n.Title(JSShop.Language.Translations.Common.Ok),n.Type(Fit.Controls.Button.Type.Success),n.Enabled(!1),n.OnClick(function(e){t.Dispose()}),t.AddButton(n),n.Focused(!0),null===document.querySelector("link[href*='/Views/DialogOrderEntries.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/DialogOrderEntries.css");var r=new Fit.Http.Request(JSShop.GetPath()+"/Views/DialogOrderEntries.html");r.OnSuccess(function(i){var a=r.GetResponseText();a=(a=(a=(a=(a=(a=a.replace(/{\[HeaderProduct\]}/g,o.Product)).replace(/{\[HeaderUnitPrice\]}/g,o.UnitPrice)).replace(/{\[HeaderUnits\]}/g,o.Units)).replace(/{\[HeaderPrice\]}/g,o.Price)).replace(/{\[HeaderTotalVat\]}/g,o.TotalVat)).replace(/{\[HeaderTotalPrice\]}/g,o.TotalPrice);var l="\x3c!-- REPEAT Items --\x3e",s="\x3c!-- /REPEAT Items --\x3e",c=new RegExp(l+"[\\s\\S]*"+s),u=c.exec(a);if(null!==u){var d=u[0],S=d.indexOf(l)+l.length,p=d.indexOf(s);d=d.substring(S,p);var h=function(o){var r="",i=null;Fit.Array.ForEach(o,function(e){i=d;var t=JSShop.CalculatePricing(e.UnitPrice(),e.Units(),e.Vat(),e.Discount());i=(i=(i=(i=(i=(i=(i=i.replace(/{\[Title\]}/g,null!==e.Product?e.Product.Title():e.ProductId())).replace(/{\[UnitPrice\]}/g,Fit.Math.Format(t.UnitPriceInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator))).replace(/{\[DiscountMessage\]}/g,e.DiscountMessage())).replace(/{\[Discount\]}/g,t.DiscountInclVat>0?Fit.Math.Format(-1*t.DiscountInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator):"")).replace(/{\[Units\]}/g,e.Units())).replace(/{\[Currency\]}/g,e.Currency())).replace(/{\[Price\]}/g,Fit.Math.Format(t.TotalInclVat,2,JSShop.Language.Translations.Locale.DecimalSeparator)),r+=i});for(var l=1;l<=3;l++)(e["CostCorrection"+l]()>0||e["CostCorrection"+l]()<0)&&(i=(i=(i=(i=(i=(i=(i=(i=d).replace(/{\[Title\]}/g,e["CostCorrectionMessage"+l]())).replace(/{\[UnitPrice\]}/g,"")).replace(/{\[DiscountMessage\]}/g,"")).replace(/{\[Discount\]}/g,"")).replace(/{\[Units\]}/g,"")).replace(/{\[Currency\]}/g,e.Currency())).replace(/{\[Price\]}/g,Fit.Math.Format(e["CostCorrection"+l]()+e["CostCorrectionVat"+l](),2,JSShop.Language.Translations.Locale.DecimalSeparator)),r+=i);a=(a=(a=(a=a.replace(u[0],r)).replace(/{\[Currency\]}/g,e.Currency())).replace(/{\[TotalVat\]}/g,Fit.Math.Format(e.Vat(),2,JSShop.Language.Translations.Locale.DecimalSeparator))).replace(/{\[TotalPrice\]}/g,Fit.Math.Format(e.Price()+e.Vat(),2,JSShop.Language.Translations.Locale.DecimalSeparator)),n.Enabled(!0),t.Content(a)};JSShop.Models.OrderEntry.RetrieveAll(e.Id(),function(e,t){var o=0;Fit.Array.ForEach(t,function(e){var n=new JSShop.Models.Product(e.ProductId());n.Retrieve(function(r,i){o++,e.Product=n,o===t.length&&h(t)},function(n,r){o++,e.Product=null,o===t.length&&h(t)})})})}}),r.Start()}(e)},S.innerHTML=Fit.Math.Format(e.Price()+e.Vat(),2,JSShop.Language.Translations.Locale.DecimalSeparator),Fit.Dom.Replace(c.querySelector("#JSShopOrderEntries"+e.Id()),S);var p=document.createElement("span");p.innerHTML=g(e.State()),Fit.Dom.Replace(c.querySelector("#JSShopOrderState"+e.Id()),p);var h=document.createElement("span");h.innerHTML=e.InvoiceId(),Fit.Dom.Replace(c.querySelector("#JSShopOrderInvoice"+e.Id()),h),e._internal.StateElement=p,e._internal.InvoiceElement=h,e._internal.CheckBox=u,e._internal.DomElement=c}),F&&F()})}),J.Start()};(l=new Fit.Controls.Input("JSShopSearch")).Width(120),l.GetDomElement().title="Search",l.Placeholder("Search..");var f=new Date;new Date((new Date).setDate(f.getDate()-1)),(s=new Fit.Controls.Input("JSShopFromDate")).Required(!0),s.SetValidationCallback(function(e){try{Fit.Date.Parse(s.Value(),JSShop.Language.Translations.Locale.DateFormat)}catch(e){return!1}return!0}),s.OnBlur(function(e){if(!1===s.IsValid())s.Value(Fit.Date.Format(new Date,JSShop.Language.Translations.Locale.DateFormat));else{var t=Fit.Date.Parse(s.Value(),JSShop.Language.Translations.Locale.DateFormat),o=Fit.Date.Format(t,JSShop.Language.Translations.Locale.DateFormat);s.Value(o)}}),s.Width(120),s.Value(Fit.Date.Format(new Date,JSShop.Language.Translations.Locale.DateFormat)),s.GetDomElement().title="Display orders from this date",(c=new Fit.Controls.Input("JSShopToDate")).Required(!0),c.SetValidationCallback(function(e){try{Fit.Date.Parse(c.Value(),JSShop.Language.Translations.Locale.DateFormat)}catch(e){return!1}return!0}),c.OnBlur(function(e){if(!1===c.IsValid())c.Value(Fit.Date.Format(new Date,JSShop.Language.Translations.Locale.DateFormat));else{var t=Fit.Date.Parse(c.Value(),JSShop.Language.Translations.Locale.DateFormat),o=Fit.Date.Format(t,JSShop.Language.Translations.Locale.DateFormat);c.Value(o)}}),c.Width(120),c.Value(Fit.Date.Format(new Date,JSShop.Language.Translations.Locale.DateFormat)),c.GetDomElement().title="Display orders to this date",(u=new Fit.Controls.Button("JSShopUpdateButton")).Icon("fa-refresh"),u.Type(Fit.Controls.Button.Type.Primary),u.OnClick(function(e){u.Enabled(!1),J(function(){u.Enabled(!0)})}),u.GetDomElement().title="Update",(d=new Fit.Controls.Button("JSShopExportButton")).Icon("fa-table"),d.Type(Fit.Controls.Button.Type.Primary),d.OnClick(function(e){if(0!==a.length){var t=new Fit.Controls.Button("JSShopExportCsvButton");t.Title("CSV"),t.Icon("fa-table"),t.Type(Fit.Controls.Button.Type.Primary),t.OnClick(function(e){var t;i.Dispose(),Fit.Validation.ExpectBoolean(t,!0),!0===t||function(){var e=["Id","Time","ClientIp","Company","FirstName","LastName","Address","ZipCode","City","Email","Phone","Message","AltCompany","AltFirstName","AltLastName","AltAddress","AltZipCode","AltCity","Price","Vat","Currency","Weight","WeightUnit","CostCorrection1","CostCorrectionVat1","CostCorrectionMessage1","CostCorrection2","CostCorrectionVat2","CostCorrectionMessage2","CostCorrection3","CostCorrectionVat3","CostCorrectionMessage3","PaymentMethod","TransactionId","State","PromoCode","CustData1","CustData2","CustData3"],t=[];Fit.Array.ForEach(a,function(o){var n=[];Fit.Array.ForEach(e,function(e){if("Time"===e){var t=new Date(o.Time());Fit.Array.Add(n,'"'+Fit.Date.Format(t,"YYYY-MM-DD hh:mm:ss")+'"')}else"State"===e?Fit.Array.Add(n,'"'+g(o.State())+'"'):"number"==typeof o[e]()?Fit.Array.Add(n,Fit.Math.Format(o[e](),4,".")):Fit.Array.Add(n,'"'+o[e]()+'"')}),Fit.Array.Add(t,n)});var o='"'+e.join('","')+'"';if(Fit.Array.ForEach(t,function(e){o+="\n"+e.join(",")}),"MSIE"===Fit.Browser.GetInfo().Name){var n=document.createElement("iframe");n.style.display="none",document.body.appendChild(n);var r=n.contentDocument;r.write(o),r.close(),r.execCommand("SaveAs",!0,"Export.csv"),Fit.Dom.Remove(n)}else if(navigator.msSaveOrOpenBlob){var i=new Blob([o],{type:"text/csv"});navigator.msSaveOrOpenBlob(i,"Export.csv")}else window.open(encodeURI("data:text/csv;charset=utf-8,"+o))}()});var n=new Fit.Controls.Button("JSShopExportPdfButton");n.Title("PDF"),n.Icon("fa-file-pdf-o"),n.Type(Fit.Controls.Button.Type.Primary),n.OnClick(function(e){i.Dispose(),y()}),n.Enabled("MSIE"!==Fit.Browser.GetInfo().Name||Fit.Browser.GetInfo().Name>=10);var r=new Fit.Controls.Button("JSShopExportCancelButton");r.Title("Annuller"),r.Icon("fa-cancel"),r.Type(Fit.Controls.Button.Type.Danger),r.OnClick(function(e){i.Dispose()});var i=new Fit.Controls.Dialog;i.Content("Vælg venligst format"),i.Modal(!0),i.AddButton(t),i.AddButton(n),i.AddButton(r),i.Open(),t.Focused(!0)}else Fit.Controls.Dialog.Alert(o.SelectOrders)}),d.GetDomElement().title=o.Export,(S=new Fit.Controls.Button("JSShopInvoiceButton")).Icon("fa-paperclip"),S.Type(Fit.Controls.Button.Type.Primary),S.OnClick(function(e){0!==a.length?function(){var e=[],t=[],n=[],r=0,i=0;if(Fit.Array.ForEach(a,function(t){"Captured"===t.State()?Fit.Array.Add(e,t):Fit.Array.Add(n,t.Id())}),n.length>0&&Fit.Controls.Dialog.Alert(o.OrdersSkipped+":<br><br>"+n.join(n.length<=10?"<br>":", ")),0!==e.length){var r=e.length,l=null;l=function(n){n.SendInvoice(function(a,s){i++,0===e.length?i===r&&(0===t.length?Fit.Controls.Dialog.Alert(o.DoneSuccess):Fit.Controls.Dialog.Alert(o.DoneFailure+":<br><br>"+t.join(t.length<=10?"<br>":", "))):(l(e[0]),Fit.Array.Remove(e,e[0])),n.Retrieve(function(e,t){n._internal.InvoiceElement.innerHTML=n.InvoiceId()})},function(a,s){Fit.Array.Add(t,n.Id()),i++,0===e.length?i===r&&Fit.Controls.Dialog.Alert(o.DoneFailure+":<br><br>"+t.join(t.length<=10?"<br>":", ")):(l(e[0]),Fit.Array.Remove(e,e[0]))})};for(var s=[],c=0;c<3;c++)c<=e.length-1&&(l(e[c]),Fit.Array.Add(s,e[c]));Fit.Array.ForEach(s,function(t){Fit.Array.Remove(e,t)})}}():Fit.Controls.Dialog.Alert(o.SelectOrders)}),S.GetDomElement().title=o.SendInvoice,(p=new Fit.Controls.Button("JSShopCaptureButton")).Icon("fa-exchange"),p.Type(Fit.Controls.Button.Type.Success),p.OnClick(function(e){0!==a.length?Fit.Controls.Dialog.Confirm(o.ConfirmAction+": "+o.Capture,function(e){!0===e&&F("Capture")}):Fit.Controls.Dialog.Alert(o.SelectOrders)}),p.GetDomElement().title=o.Capture,(h=new Fit.Controls.Button("JSShopReturnButton")).Icon("fa-trash"),h.Type(Fit.Controls.Button.Type.Danger),h.OnClick(function(e){0!==a.length?Fit.Controls.Dialog.Confirm(o.ConfirmAction+": "+o.Reject,function(e){!0===e&&F("Reject")}):Fit.Controls.Dialog.Alert(o.SelectOrders)}),h.GetDomElement().title=o.Reject,JSShop.Settings.ConfigUrl&&((C=new Fit.Controls.Button("JSShopConfigButton")).Icon("fa-cog"),C.Type(Fit.Controls.Button.Type.Warning),C.OnClick(function(e){location.href=JSShop.Settings.ConfigUrl}),C.GetDomElement().title="Settings"),(m=new Fit.Controls.CheckBox("JSShopSelectAll")).OnChange(function(e){!0===m.Focused()&&Fit.Array.ForEach(t,function(e){"none"!==e._internal.DomElement.style.display&&e._internal.CheckBox.Checked(m.Checked())})}),J()}()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.ProductForm=function(){Fit.Core.Extend(this,JSShop.Presenters.Base).Apply();var e=null,t={},o=null,n=null,r=null,i=null,a=null,l=null,s=null,c=null,u=null,d=null,S=null,p=null,h=null,C=null,m=null,g=null,F=null,y=null,J=JSShop.Language.Translations.ProductForm,f=[],V=[];function v(){n.SetInputValue(""),n.Value(""),n.TreeView.RemoveAllChildren(!0),r.GetPicker().RemoveItems(),t={},JSShop.Models.Product.RetrieveAll("",function(e,o){Fit.Array.ForEach(o,function(e){null===n.TreeView.GetChild(e.Category())&&(n.TreeView.AddChild(new Fit.Controls.TreeView.Node(e.Category(),e.Category())),r.GetPicker().AddItem(e.Category(),e.Category()));var o=new Fit.Controls.TreeView.Node(e.Title(),e.Id());o.Selectable(!0),n.TreeView.GetChild(e.Category()).AddChild(o),t[e.Id()]=e}),0===Fit.Array.Count(t)&&(n.SetInputValue(J.NoProducts),n.CloseDropDown())})}function A(t){if(Fit.Validation.ExpectInstance(t,JSShop.Models.Product,!0),!0===Fit.Validation.IsSet(t)){if(r.ClearInput(),r.AddSelection(t.Category(),t.Category()),i.Value(t.Id()),a.Value(t.Title()),l.Value(t.Description()),s.Clear(),c.Value(t.Price().toString().replace(".",JSShop.Language.Translations.Locale.DecimalSeparator)),u.Value(t.Currency()),d.Value(0!==t.Vat()?t.Vat().toString().replace(".",JSShop.Language.Translations.Locale.DecimalSeparator):""),S.Value(0!==t.Weight()?t.Weight().toString().replace(".",JSShop.Language.Translations.Locale.DecimalSeparator):""),p.Value(P(t.WeightUnit())),h.Value(t.DeliveryTime()),C.Value(t.DiscountExpression()),m.Value(t.DiscountMessage()),e.querySelector(".JSShopProductFormImages").innerHTML="",""!==t.Images()){var n=e.querySelector(".JSShopProductFormImages");Fit.Array.ForEach(t.Images().split(";"),function(e){var t=new Image;n.appendChild(E(t,function(){Fit.Array.Add(f,e),Fit.Dom.Remove(t.parentElement)})),t.src=e})}y.GetDomElement().style.display="",o=t}else r.ClearInput(),r.ClearSelections(),i.Value(""),a.Value(""),l.Value(""),s.Clear(),c.Value(""),u.Value(null!==JSShop.Cookies.Get("PreviousCurrency")?JSShop.Cookies.Get("PreviousCurrency"):""),d.Value(null!==JSShop.Cookies.Get("PreviousVat")?JSShop.Cookies.Get("PreviousVat"):""),S.Value(""),p.Value(null!==JSShop.Cookies.Get("PreviousWeightUnit")?JSShop.Cookies.Get("PreviousWeightUnit"):""),h.Value(null!==JSShop.Cookies.Get("PreviousDeliveryTime")?JSShop.Cookies.Get("PreviousDeliveryTime"):""),C.Value(""),m.Value(""),e.querySelector(".JSShopProductFormImages").innerHTML="",y.GetDomElement().style.display="none",o=null}function x(){var e=null!==o&&o.Id()===i.Value(),t=!0===e?o:new JSShop.Models.Product(i.Value());null!==o&&t!==o&&t.Images(o.Images());var n=t.Images(),F=""!==n?n.split(";"):[];Fit.Array.ForEach(s.GetFiles(),function(e){if(!1!==e.Processed){if(null===e.ServerResponse||""===e.ServerResponse)throw"File upload did not produce a valid file reference";Fit.Array.Add(F,e.ServerResponse)}}),Fit.Array.ForEach(f,function(e){Fit.Array.Remove(F,e)}),n="",Fit.Array.ForEach(F,function(e){n+=(""!==n?";":"")+e}),t.Category(r.GetSelections()[0].Value),t.Id(i.Value()),t.Title(a.Value()),t.Description(l.Value()),t.Images(n),t.Price(parseFloat(c.Value().replace(JSShop.Language.Translations.Locale.DecimalSeparator,"."))),t.Currency(u.GetSelections()[0].Value),t.Vat(""!==d.Value()?parseFloat(d.Value().replace(JSShop.Language.Translations.Locale.DecimalSeparator,".")):0),t.Weight(""!==S.Value()?parseFloat(S.Value().replace(JSShop.Language.Translations.Locale.DecimalSeparator,".")):0),t.WeightUnit(p.GetSelections()[0].Value),t.DeliveryTime(h.Value()),t.DiscountExpression(C.Value()),t.DiscountMessage(m.Value());var y=function(){var e=function(){g.Icon("fa-check"),setTimeout(function(){g.Icon("floppy-o")},1500),A(null),v()};null!==o&&t!==o?o.Delete(e):e()};!0===e?t.Update(y):t.Create(y)}function D(e){if(0!==f.length){var t=new Fit.Http.Request(JSShop.WebService.Files.Remove);t.SetData("Files="+f.join(";")),t.OnSuccess(function(t){e()}),t.OnFailure(function(t){Fit.Controls.Dialog.Alert(J.ImagesNotRemoved),e()}),t.Start()}else e()}function E(e,t){var o=document.createElement("div");o.className="JSShopFilePreview";var n=document.createElement("span");return n.className="fa fa-remove",n.onclick=function(e){t()},o.appendChild(n),e.onload=function(t){var o=Fit.Dom.GetInnerDimensions(e.parentElement);e.width/2>e.height?(e.style.height="100%",e.style.width="auto",e.style.marginLeft="-"+(e.offsetWidth-o.X)/2+"px"):e.width/2<e.height?(e.style.width="100%",e.style.height="auto",e.style.marginTop="-"+(e.offsetHeight-o.Y)/2+"px"):(e.style.width="100%",e.style.height="100%")},o.appendChild(e),o}function P(e){return"lbs"===e?J.Pounds+"=lbs":J.Kilos+"=kg"}this.GetDomElement=function(){return e},function(){e=document.createElement("div"),null===document.querySelector("link[href*='/Views/ProductForm.css']")&&Fit.Loader.LoadStyleSheet(JSShop.GetPath()+"/Views/ProductForm.css");var T=new Fit.Http.Request(JSShop.GetPath()+"/Views/ProductForm.html");T.OnSuccess(function(t){var o=T.GetResponseText();e.innerHTML=o,Fit.Dom.Add(e.querySelector("#JSShop-Products-Label"),document.createTextNode(J.EditProduct)),n.Render(e.querySelector("#JSShop-Products-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Category-Label"),document.createTextNode(J.Category)),r.Render(e.querySelector("#JSShop-Category-Control")),Fit.Dom.Add(e.querySelector("#JSShop-ProductId-Label"),document.createTextNode(J.ProductId)),i.Render(e.querySelector("#JSShop-ProductId-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Title-Label"),document.createTextNode(J.Title)),a.Render(e.querySelector("#JSShop-Title-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Description-Label"),document.createTextNode(J.Description)),l.Render(e.querySelector("#JSShop-Description-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Images-Label"),document.createTextNode(J.Images)),s.Render(e.querySelector("#JSShop-Images-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Price-Label"),document.createTextNode(J.Price)),c.Render(e.querySelector("#JSShop-Price-Control")),u.Render(e.querySelector("#JSShop-Currency-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Vat-Label"),document.createTextNode(J.Vat)),d.Render(e.querySelector("#JSShop-Vat-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Weight-Label"),document.createTextNode(J.Weight)),S.Render(e.querySelector("#JSShop-Weight-Control")),p.Render(e.querySelector("#JSShop-WeightUnit-Control")),Fit.Dom.Add(e.querySelector("#JSShop-DeliveryTime-Label"),document.createTextNode(J.DeliveryTime)),h.Render(e.querySelector("#JSShop-DeliveryTime-Control")),Fit.Dom.Add(e.querySelector("#JSShop-DiscountExpression-Label"),document.createTextNode(J.DiscountExpression)),C.Render(e.querySelector("#JSShop-DiscountExpression-Control")),Fit.Dom.Add(e.querySelector("#JSShop-DiscountMessage-Label"),document.createTextNode(J.DiscountMessage)),m.Render(e.querySelector("#JSShop-DiscountMessage-Control")),Fit.Dom.Add(e.querySelector("#JSShop-Buttons"),g.GetDomElement()),Fit.Dom.Add(e.querySelector("#JSShop-Buttons"),F.GetDomElement()),Fit.Dom.Add(e.querySelector("#JSShop-Buttons"),y.GetDomElement())}),T.Start(),(n=new Fit.Controls.DropDown("JSShopProducts")).TreeView=new Fit.Controls.TreeView("JSShopProductsTreeView"),n.TreeView.Lines(!0),n.TreeView.Width(100,"%"),n.ListView=new Fit.Controls.ListView,n.Width(350,"px"),n.DropDownMaxWidth(180,"%"),n.InputEnabled(!0),n.OnInputChanged(function(e){if(""===n.GetInputValue())n.SetPicker(n.TreeView);else{n.OpenDropDown(),n.ListView.RemoveItems();var t=n.TreeView.GetAllNodes(),o=n.GetInputValue().toLowerCase();Fit.Array.ForEach(t,function(e){0!==e.GetLevel()&&(e.Title().toLowerCase().indexOf(o)>-1||e.Value().toLowerCase()===o)&&n.ListView.AddItem(e.Title()+" ("+e.GetParent().Title()+")",e.Value())}),n.SetPicker(n.ListView)}}),n.OnChange(function(e){n.SetPicker(n.TreeView),0===n.TreeView.Selected().length?A(null):A(t[n.TreeView.Selected()[0].Value()])}),n.SetPicker(n.TreeView),(r=new Fit.Controls.DropDown("JSShopProductCategory")).SetPicker(new Fit.Controls.ListView),r.Width(350,"px"),r.DropDownMaxWidth(150,"%"),r.InputEnabled(!0),r.SetValidationCallback(function(e){return e.split("=")[0].length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),r.Required(!0),r.Scope("JSShopProductForm"),r.OnBlur(function(e){r.GetSelections().length>0?r.SetInputValue(""):""!==r.GetInputValue()&&r.AddSelection(r.GetInputValue(),r.GetInputValue())}),v(),(i=new Fit.Controls.Input("JSShopProductId")).Width(350,"px"),i.Required(!0),i.SetValidationCallback(function(e){return e.length<=30},JSShop.Language.Translations.Common.MaxLengthExceeded),i.Scope("JSShopProductForm"),(a=new Fit.Controls.Input("JSShopProductTitle")).Width(350,"px"),a.Required(!0),a.SetValidationCallback(function(e){return e.length<=250},JSShop.Language.Translations.Common.MaxLengthExceeded),a.Scope("JSShopProductForm"),(l=new Fit.Controls.Input("JSShopProductDescription")).Width(350,"px"),l.Height(80,"px"),l.MultiLine(!0,300),l.Maximizable(!0,250),l.SetValidationCallback(function(e){return e.length<=1e3},JSShop.Language.Translations.Common.MaxLengthExceeded),l.Scope("JSShopProductForm"),(s=new Fit.Controls.FilePicker("JSShopProductImages")).Url(JSShop.WebService.Files.Upload),s.MultiSelectionMode(!0),s.Title(J.SelectFiles),s.OnChange(function(t){if(!0!==s.IsLegacyModeEnabled()){V=[];var o=e.querySelector(".JSShopProductFormImages");Fit.Array.ForEach(o.querySelectorAll("div.JSShopPreviewContainer"),function(e){Fit.Dom.Remove(e)}),Fit.Array.ForEach(s.GetFiles(),function(e){if(!1!==Fit.Array.Contains(["image/png","image/jpg","image/jpeg","image/gif"],e.Type)){var t=document.createElement("div");t.className="JSShopPreviewContainer";var n=new Fit.Controls.ProgressBar("JSShopFileProgress"+e.Id);n.Title(e.Filename),n.Render(t);var r=e.GetImagePreview();null!==r&&t.appendChild(E(r,function(){Fit.Array.Add(V,e.Filename),Fit.Dom.Remove(t)})),o.appendChild(t)}})}}),s.OnProgress(function(e,t){!1===s.IsLegacyModeEnabled()&&Fit.Controls.Find("JSShopFileProgress"+t.Id).Progress(t.Progress)}),s.OnCompleted(function(e){D(x)}),(c=new Fit.Controls.Input("JSShopProductPrice")).Width(185,"px"),c.Required(!0),c.SetValidationCallback(function(e){return e.length<=10},JSShop.Language.Translations.Common.MaxLengthExceeded),c.SetValidationExpression(new RegExp("^([0-9]+(\\"+JSShop.Language.Translations.Locale.DecimalSeparator+"[0-9]+)?)?$"),JSShop.Language.Translations.Common.InvalidValue),c.Scope("JSShopProductForm"),null===JSShop.Cookies.Get("PreviousCurrency")&&JSShop.Cookies.Set("PreviousCurrency",JSShop.Language.Translations.Locale.Currency,31536e3);var I=null,L=JSShop.Cookies.Get("PreviousCurrency");(u=new Fit.Controls.DropDown("JSShopProductCurrency")).Width(125,"px"),u.SetPicker(new Fit.Controls.ListView),u.Value(L),u.Required(!0),u.InputEnabled(!0),u.OnOpen(function(e){if(null===I){I=[];var t=new Fit.Http.JsonRequest(JSShop.GetUrl()+"/Currencies.json");t.OnSuccess(function(e){I=t.GetResponseJson();var o=u.GetInputValue().toLowerCase();Fit.Array.ForEach(I,function(e){(""===o||e.cc.toLowerCase().indexOf(o)>-1||e.symbol.toLowerCase().indexOf(o)>-1||e.name.toLowerCase().indexOf(o)>-1)&&u.GetPicker().AddItem(e.cc+" ("+e.symbol+")",e.cc)})}),t.Start()}}),u.OnInputChanged(function(e){if(null===I)u.OpenDropDown();else{var t=u.GetInputValue().toLowerCase();u.GetPicker().RemoveItems(),Fit.Array.ForEach(I,function(e){(""===t||e.cc.toLowerCase().indexOf(t)>-1||e.symbol.toLowerCase().indexOf(t)>-1||e.name.toLowerCase().indexOf(t)>-1)&&u.GetPicker().AddItem(e.cc+" ("+e.symbol+")",e.cc)}),""!==u.GetInputValue()&&u.OpenDropDown()}}),u.OnChange(function(e){JSShop.Cookies.Set("PreviousCurrency",u.Value(),31536e3)}),(d=new Fit.Controls.Input("JSShopProductVat")).Width(185,"px"),d.SetValidationCallback(function(e){return e.length<=10},JSShop.Language.Translations.Common.MaxLengthExceeded),d.SetValidationExpression(new RegExp("^([0-9]+(\\"+JSShop.Language.Translations.Locale.DecimalSeparator+"[0-9]+)?)?$"),JSShop.Language.Translations.Common.InvalidValue),d.Scope("JSShopProductForm"),d.Value(null!==JSShop.Cookies.Get("PreviousVat")?JSShop.Cookies.Get("PreviousVat"):""),d.OnChange(function(e){JSShop.Cookies.Set("PreviousVat",d.Value(),31536e3)}),(S=new Fit.Controls.Input("JSShopProductWeight")).Width(185,"px"),S.SetValidationCallback(function(e){return e.length<=10},JSShop.Language.Translations.Common.MaxLengthExceeded),S.SetValidationExpression(new RegExp("^([0-9]+(\\"+JSShop.Language.Translations.Locale.DecimalSeparator+"[0-9]+)?)?$"),JSShop.Language.Translations.Common.InvalidValue),S.Scope("JSShopProductForm"),null===JSShop.Cookies.Get("PreviousWeightUnit")&&JSShop.Cookies.Set("PreviousWeightUnit",P(JSShop.Language.Translations.Locale.WeightUnit),31536e3),JSShop.Cookies.Get("PreviousWeightUnit"),(p=new Fit.Controls.DropDown("JSShopProductWeightUnit")).Width(125,"px"),p.SetPicker(new Fit.Controls.ListView),p.GetPicker().AddItem(J.Kilos,"kg"),p.GetPicker().AddItem(J.Pounds,"lbs"),p.Value(JSShop.Cookies.Get("PreviousWeightUnit")),p.Required(!0),p.OnChange(function(e){JSShop.Cookies.Set("PreviousWeightUnit",p.Value(),31536e3)}),(h=new Fit.Controls.Input("JSShopProductDeliveryTime")).Width(350,"px"),h.Value(null!==JSShop.Cookies.Get("PreviousDeliveryTime")?JSShop.Cookies.Get("PreviousDeliveryTime"):""),h.SetValidationCallback(function(e){return e.length<=50},JSShop.Language.Translations.Common.MaxLengthExceeded),h.Scope("JSShopProductForm"),h.OnChange(function(e){JSShop.Cookies.Set("PreviousDeliveryTime",h.Value(),31536e3)}),(C=new Fit.Controls.Input("JSShopProductDiscountExpression")).Width(350,"px"),C.SetValidationCallback(function(e){var t=new JSShop.Models.Product("JSShopTemp"+Fit.Data.CreateGuid());t.Price(100),t.Currency("USD"),t.Vat(25),t.DiscountExpression(e);try{return t.CalculateDiscount(-100),t.CalculateDiscount(0),t.CalculateDiscount(100),!0}catch(e){return!1}},JSShop.Language.Translations.Common.InvalidValue),C.SetValidationExpression(/^(.|\n){0,250}$/,JSShop.Language.Translations.Common.MaxLengthExceeded),C.Scope("JSShopProductForm"),(m=new Fit.Controls.Input("JSShopProductDiscountMessage")).Width(350,"px"),m.SetValidationCallback(function(e){var t=new JSShop.Models.Product("JSShopTemp"+Fit.Data.CreateGuid());t.Price(100),t.Currency("USD"),t.Vat(25),t.DiscountMessage(e);try{return t.CalculateDiscountMessage(-100),t.CalculateDiscountMessage(0),t.CalculateDiscountMessage(100),!0}catch(e){return!1}},JSShop.Language.Translations.Common.InvalidValue),m.SetValidationExpression(/^(.|\n){0,250}$/,JSShop.Language.Translations.Common.MaxLengthExceeded),m.Scope("JSShopProductForm"),(g=new Fit.Controls.Button("JSShopSaveButton")).Title(J.Save),g.Icon("floppy-o"),g.Type(Fit.Controls.Button.Type.Success),g.OnClick(function(e){if(!1!==Fit.Controls.ValidateAll("JSShopProductForm"))if(s.GetFiles().length>0){var t=[];Fit.Array.ForEach(s.GetFiles(),function(e){!1===s.IsLegacyModeEnabled()?!1===Fit.Array.Contains(["image/png","image/jpg","image/jpeg","image/gif"],e.Type)&&Fit.Array.Add(t,e.Filename):!1===Fit.Array.Contains([".png",".jpg",".jpeg",".gif"],e.Filename.substring(e.Filename.lastIndexOf(".")))&&Fit.Array.Add(t,e.Filename)});var o=Fit.Array.Merge(t,V);s.GetFiles().length>o.length?s.Upload(o):D(x)}else D(x);else Fit.Controls.Dialog.Alert(JSShop.Language.Translations.Common.InvalidEntries)}),(F=new Fit.Controls.Button("JSShopClearButton")).Title(J.Clear),F.Icon("refresh"),F.Type(Fit.Controls.Button.Type.Warning),F.OnClick(function(e){F.Icon("fa-check"),setTimeout(function(){F.Icon("refresh")},1500),n.SetInputValue(""),n.Clear(),A(null)}),(y=new Fit.Controls.Button("JSShopDeleteButton")).Title(J.Delete),y.Icon("minus-circle"),y.Type(Fit.Controls.Button.Type.Danger),y.GetDomElement().style.display="none",y.OnClick(function(e){Fit.Controls.Dialog.Confirm(J.DeleteWarning,function(e){!1!==e&&(f=""!==o.Images()?o.Images().split(";"):[],D(function(){o.Delete(function(){y.Icon("fa-check"),setTimeout(function(){y.Icon("minus-circle")},1500),A(null),v()})}))})})}()},window.JSShop||Fit.Validation.ThrowError("JSShop.js must be loaded"),JSShop.Presenters.ProductList={},JSShop.Presenters.ProductList.Initialize=function(e){Fit.Validation.ExpectDomElement(e);var t=document.querySelectorAll(".JSShopBuyButton");Fit.Array.ForEach(t,function(e){var t=Fit.Dom.Data(e,"ProductId");if(null!==t){var o="1",n=new Fit.Controls.Input("JSShopUnits"+Fit.Data.CreateGuid());n.Width(2.5,"em"),n.Height(2,"em"),n.Value(o),n.OnChange(function(e){""!==n.Value()&&(!0===isNaN(parseInt(n.Value()))||parseInt(n.Value()).toString()!==n.Value()||parseInt(n.Value())<1||parseInt(n.Value())>999999)?n.Value(o):o=n.Value()}),n.OnBlur(function(e){""===n.Value()&&n.Value("1")});var r=new Fit.Controls.Button("JSShopBuyButton"+Fit.Data.CreateGuid());r.Height(2,"em"),r.Title(e.innerHTML),r.Type(Fit.Controls.Button.Type.Primary),r.Icon("shopping-cart"),r.OnClick(function(){r.Enabled(!1);var e=new JSShop.Models.Product(t);e.Retrieve(function(){JSShop.Models.Basket.Add(e.Id(),parseInt(n.Value()));var t=new Fit.Controls.Dialog;if(t.Modal(!0),t.Content("<b>"+JSShop.Language.Translations.ProductList.ProductAdded+"</b><br><br>"+n.Value()+" x "+e.Title()),JSShop.Settings.BasketUrl){var o=new Fit.Controls.Button("JSShopBasketButton"+Fit.Data.CreateGuid());o.Type(Fit.Controls.Button.Type.Default),o.Icon("shopping-basket"),o.Title(JSShop.Language.Translations.ProductList.OpenBasket),o.OnClick(function(e){t.Close(),r.Enabled(!0),location.href=JSShop.Settings.BasketUrl}),t.AddButton(o)}var i=new Fit.Controls.Button("JSShopContinueButton"+Fit.Data.CreateGuid());i.Type(Fit.Controls.Button.Type.Default),i.Icon("shopping-cart"),i.Title(JSShop.Language.Translations.ProductList.ContinueShopping),i.OnClick(function(e){t.Close(),r.Enabled(!0)}),t.AddButton(i),t.Open(),i.Focused(!0)},function(){alert("Product with ID '"+t+"' not found"),r.Enabled(!0)})});var i=document.createElement("span");r.GetDomElement().style.verticalAlign="top",n.GetDomElement().style.verticalAlign="top",n.GetDomElement().style.marginLeft="0.3em",Fit.Dom.Add(i,r.GetDomElement()),Fit.Dom.Add(i,n.GetDomElement()),e.innerHTML="",Fit.Dom.Add(e,i)}else console.log("Unable to create Buy Button - data-ProductId attribute must be set")});var o=document.querySelectorAll(".JSShopInfoButton");Fit.Array.ForEach(o,function(e){var t=new Fit.Controls.Button("SMShopButton"+Fit.Data.CreateGuid());t.Height(2,"em"),t.Title(e.innerHTML),t.Type(Fit.Controls.Button.Type.Info),e.innerHTML="",Fit.Dom.Add(e,t.GetDomElement())});var n=document.querySelectorAll(".JSShopLocalizedNumber");Fit.Array.ForEach(n,function(e){var t=e.innerHTML;!1!==/^\-?([0-9]+(\.[0-9]+)?)$/.test(t)&&(e.innerHTML=t.replace(".",JSShop.Language.Translations.Locale.DecimalSeparator))})};