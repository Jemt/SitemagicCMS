<div id="SMShopProductList" class="SMShopProductList">
	<!-- REPEAT Products -->
	<div class="SMShopProduct" id="SMShopProduct{[Id]}">
		<div class="SMShopProductHeader">
			<i class="SMShopCloseDialogButton fa fa-times-circle"></i>
			<span class="SMShopProductTitle">{[Title]}</span>
		</div>
		<div class="SMShopProductImages">
			<!-- REPEAT Images{[Id]} -->
			<img src="{[Image]}" alt="">
			<!-- /REPEAT Images{[Id]} -->
			<i class="SMShopPrevImageButton fa fa-chevron-circle-left" onclick="SMShopSwitchImage(this.parentElement, 'prev');"></i>
			<i class="SMShopNextImageButton fa fa-chevron-circle-right" onclick="SMShopSwitchImage(this.parentElement, 'next');"></i>
			<span class="SMShopProductImagePlaceHolder fa-stack fa-lg">
				<i class="fa fa-camera fa-stack-1x"></i>
				<i class="fa fa-circle-thin fa-stack-2x"></i>
			</span>
		</div>
		<div class="SMShopProductBody">
			<span class="SMShopProductDescription">{[Description]}</span>
		</div>
		<div class="SMShopProductFooter">
			<span class="SMShopProductWeight" data-weight="{[Weight]}" data-unit="{[WeightUnit]}"><span class="JSShopLocalizedNumber">{[Weight]}</span> {[WeightUnit]}.</span>
			<span class="SMShopProductDeliveryTime" data-delivery="{[DeliveryTime]}">{[DeliveryTime]}</span>
			<span class="SMShopProductFullPrice" data-currency="{[Currency]}" data-fullprice="{[FullPrice]}">{[Currency]} <span class="JSShopLocalizedNumber">{[FullPrice]}</span></span>
			<span class="SMShopProductPriceInfo" data-price="{[Price]}" data-vat="{[Vat]}">({[Currency]} <span class="JSShopLocalizedNumber">{[Price]}</span> + <span class="JSShopLocalizedNumber">{[Vat]}</span>%)</span>
			<div class="SMShopProductButtons">
				<span class="SMShopButton JSShopInfoButton" onclick="SMShopOpenProductDialog(this.parentElement.parentElement.parentElement);">{[ReadMore]}</span>
				<span class="SMShopButton JSShopBuyButton" data-ProductId="{[Id]}">{[Buy]}</span>
			</div>
		</div>

		<!--
		<span>{[CategoryId]}</span>
		<span>{[Category]}</span>
		<span>{[Id]}</span>
		-->
	</div>
	<!-- /REPEAT Products -->
	<div style="clear: both"></div>
</div>

<script type="text/javascript">
function SMShopOpenProductDialog(prod)
{
	// Add placeholder - product is to be taken out of flow

	var placeholder = Fit.Dom.CreateElement(prod.outerHTML);
	Fit.Dom.InsertBefore(prod, placeholder);

	// Background layer

	var layer = Fit.Dom.CreateElement("<div id='SMShopBackgroundLayer' class='SMShopBackgroundLayer'></div>");
	Fit.Events.AddHandler(layer, "click", function(e)
	{
		var target = Fit.Events.GetTarget(e);

		if (target !== layer && Fit.Dom.HasClass(target, "SMShopCloseDialogButton") === false)
			return; // Cancel - only close if user clicked on layer or close button

		document.body.style.overflow = "";
		document.documentElement.style.overflow = "";

		Fit.Dom.InsertAfter(placeholder, prod);
		Fit.Dom.Remove(placeholder);
		Fit.Dom.Remove(layer);

		Fit.Array.ForEach(prod.getElementsByTagName("img"), function(img)
		{
			img.style.display = ""; // Set by SMShopSwitchImage function - reset to return control to CSS
		});

		Fit.Dom.RemoveClass(prod, "SMShopProductDialog");

		var qs = Fit.Browser.GetQueryString();
		if (qs.Anchor !== null)
			location.href = qs.Url.replace("#" + qs.Anchor, "#_"); // Using #_ rather than # to prevent page from scrolling to top
	});
	Fit.Dom.Add(document.body, layer);

	// Transform product card into product dialog

	Fit.Dom.AddClass(prod, "SMShopProductDialog");

	// Move product inside scrollable background layer and disable scrolling on page to prevent having multiple scrollbars visible

	Fit.Dom.Add(layer, prod);

	// Scrolling can be enabled for both the <html> and <body>.
	// Unfortunately this will make the content move slightly to the right when the scrollbar disappears.
	// But it also have the advantage that the user only scrolls the product dialog, not the entire page.
	// So when the dialog is closed, the user is returned to the exact same scroll position as before.
	document.body.style.overflow = "hidden";
	document.documentElement.style.overflow = "hidden";

	// Add Product ID to URL

	var qs = Fit.Browser.GetQueryString();
	var url = ((qs.Anchor !== null) ? qs.Url.replace("#" + qs.Anchor, "") : qs.Url);
	url += "#" + prod.id.replace("SMShopProduct", "");

	location.href = url;
}

function SMShopSwitchImage(imageContainer, direction)
{
	var images = imageContainer.getElementsByTagName("img");

	var visible = null;
	var nextImage = null;

	for (var i = 0 ; i < images.length ; i++)
	{
		if (Fit.Dom.IsVisible(images[i]) === true)
		{
			visible = images[i];

			if (direction === "prev" && i > 0)
				nextImage = images[i - 1];
			else if (direction === "next" && i < images.length - 1)
				nextImage = images[i + 1];
		}
	}

	if (nextImage === null)
		return;

	visible.style.display = "none";
	nextImage.style.display = "block";
}

(function()
{
	var qs = Fit.Browser.GetQueryString();

	if (qs.Anchor !== null)
	{
		var prod = document.getElementById("SMShopProduct" + qs.Anchor);

		if (prod !== null)
			SMShopOpenProductDialog(prod);
	}
})();
</script>
